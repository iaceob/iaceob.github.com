<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="幾文山" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>幾文山</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">幾文山</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="http://old.3u3.me" class="head-nav__link">Old</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2016-12-04T08:35:14.000Z" class="post__time">December 4, 2016</time><h1 class="post__title"><a href="/post/letsencrypt-auto-shell/">letsencrypt 交互式脚本</a></h1></header><div class="post__main echo"><h2 id="赘述"><a href="#赘述" class="headerlink" title="赘述"></a>赘述</h2><blockquote>
<p>随着国内网络环境的持续恶化，各种篡改和劫持层出不穷，越来越多的网站选择了全站 HTTPS。就在今天，免费提供证书服务的 <a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a> 项目也正式开放，HTTPS 很快就会成为 WEB 必选项。HTTPS 通过 TLS 层和证书机制提供了内容加密、身份认证和数据完整性三大功能，可以有效防止数据被查看或篡改，以及防止中…</p>
</blockquote>
<p><a href="https://imququ.com/post/sth-about-switch-to-https.html" target="_blank" rel="external">不抄了</a>…</p>
<p>这里要说的是, 使用脚本去开启 https 认证.</p>
<p>此脚本是根据 <a href="https://imququ.com/post/letsencrypt-certificate.html" target="_blank" rel="external">Let’s Encrypt，免费好用的 HTTPS 证书</a> 所阐述的内容而进行修改的交互式执行脚本.</p>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p><strong>ecpt.sh</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span><br><span class="line"></span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 自动设定 Let's Encrypt https</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 脚本执行路径</span></span><br><span class="line">BIN_PATH=$(dirname $(readlink <span class="_">-f</span> <span class="variable">$0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">## 证书存储目录</span></span><br><span class="line">F_CERT_STORE=</span><br><span class="line"><span class="comment">## nginx ssl 验证目录</span></span><br><span class="line">F_NGINX_VERIFY=</span><br><span class="line"><span class="comment">## nginx 自定义配置文件目录</span></span><br><span class="line">F_NGINX_CONF=</span><br><span class="line"><span class="comment">## 私钥类型</span></span><br><span class="line">CSR_TYPE=</span><br><span class="line"><span class="comment">## ecc 私钥加密算法</span></span><br><span class="line">ECC_ALGO=</span><br><span class="line"><span class="comment">## 域名</span></span><br><span class="line">DOMAINLIST=</span><br><span class="line"><span class="comment">## openssl 配置文件</span></span><br><span class="line">OPENSSLCONFIG=</span><br><span class="line">OPENSSLCONFIGPATHETC=/etc/ssl/openssl.cnf</span><br><span class="line">OPENSSLCONFIGPATHUSR=/usr/<span class="built_in">local</span>/openssl/ssl/openssl.cnf</span><br><span class="line">OPENSSLCONFIGPATHPKI=/etc/pki/tls/openssl.cnf</span><br><span class="line"><span class="comment">## 预定义文件名</span></span><br><span class="line">SSL_VERIFY_CONF=ssl_verify.conf</span><br><span class="line">SYNC_SH=sync.sh</span><br><span class="line"></span><br><span class="line">ACCOUNT_KEY=account.key</span><br><span class="line">DOMAIN_KEY=domain.key</span><br><span class="line">DOMAIN_CSR=domain.csr</span><br><span class="line">DOMAIN_LIST_BACK=domain.list</span><br><span class="line">SIGNED_CRT=signed.crt</span><br><span class="line">CHAINED_PEM=chained.pem</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log</span></span>()&#123;</span><br><span class="line">    TYPE=`tr <span class="string">'[a-z]'</span> <span class="string">'[A-Z]'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$1</span>"</span>`</span><br><span class="line">    <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"[<span class="variable">$&#123;TYPE&#125;</span>]: <span class="variable">$2</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">isRoot</span></span>()&#123;</span><br><span class="line">  <span class="keyword">if</span> [ `id -u` <span class="_">-eq</span> 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">return</span>  0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">userInput</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'* 选择证书存储目录: '</span> F_CERT_STORE</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$F_CERT_STORE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'请输入目录'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">    <span class="comment"># xTODO 测试临时使用</span></span><br><span class="line">    <span class="comment"># F_CERT_STORE=/tmp/cert</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$F_CERT_STORE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    mkdir -p <span class="variable">$F_CERT_STORE</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'* 选择 nginx ssl 验证目录: '</span> F_NGINX_VERIFY</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$F_NGINX_VERIFY</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'请输入 nginx ssl 验证目录'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">    <span class="comment"># xTODO 测试临时使用</span></span><br><span class="line">    <span class="comment"># F_NGINX_VERIFY=/tmp/cert/verify/</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$F_NGINX_VERIFY</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    mkdir -p <span class="variable">$F_NGINX_VERIFY</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'* 选择 nginx 自定义配置文件目录: '</span> F_NGINX_CONF</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$F_NGINX_CONF</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'请输入 nginx 自定义配置文件目录'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">    <span class="comment"># xTODO 测试临时使用</span></span><br><span class="line">    <span class="comment"># F_NGINX_CONF=/tmp/cert/conf.d</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$F_NGINX_CONF</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'未发现 nginx 自定义配置文件目录'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'选择私钥加密类型(RSA/ECC)(RSA): '</span> CSR_TYPE</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$CSR_TYPE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    CSR_TYPE=RSA</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  CSR_TYPE=`tr <span class="string">'[a-z]'</span> <span class="string">'[A-Z]'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$CSR_TYPE</span>"</span>`</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$CSR_TYPE</span>"</span>x != <span class="string">"RSA"</span>x &amp;&amp; <span class="string">"<span class="variable">$CSR_TYPE</span>"</span>x != <span class="string">"ECC"</span>x ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'仅支持 RSA 或 ECC 类型'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$CSR_TYPE</span>"</span> = <span class="string">"ECC"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">'选择 ECC 加密算法 [1: secp256r1] [2: secp384r1] (1): '</span> ECC_ALGO</span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$ECC_ALGO</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">      ECC_ALGO=1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$ECC_ALGO</span>"</span> <span class="_">-ne</span> 1 &amp;&amp; <span class="string">"<span class="variable">$ECC_ALGO</span>"</span> <span class="_">-ne</span> 2 ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">log</span> error <span class="string">'选择正确的算法 [1: secp256r1] [2: secp384r1]'</span></span><br><span class="line">      <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'* 输入认证的域名[多个使用 , 区分]: '</span> DOMAINLIST</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$DOMAINLIST</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'至少需要一个域名'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$DOMAINLIST</span> &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_LIST_BACK</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'openssl 配置文件地址(/etc/ssl/openssl.cnf): '</span> OPENSSLCONFIG</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$OPENSSLCONFIG</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    OPENSSLCONFIG=/etc/ssl/openssl.cnf</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">createAccount</span></span>()&#123;</span><br><span class="line">  openssl genrsa 4096 &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$ACCOUNT_KEY</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">createPrivateKey</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$CSR_TYPE</span>"</span>x = <span class="string">"RSA"</span>x ]; <span class="keyword">then</span></span><br><span class="line">      openssl genrsa 4096 &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_KEY</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$CSR_TYPE</span>"</span>x = <span class="string">"ECC"</span>x ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ECC_ALGO</span> <span class="_">-eq</span> 1 ]; <span class="keyword">then</span></span><br><span class="line">      openssl ecparam -genkey -name secp256r1 | openssl ec -out <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_KEY</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ECC_ALGO</span> <span class="_">-eq</span> 2 ]; <span class="keyword">then</span></span><br><span class="line">      openssl ecparam -genkey -name secp384r1 | openssl ec -out <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_KEY</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">createCSR</span></span>() &#123;</span><br><span class="line">  OLCG=</span><br><span class="line">  <span class="keyword">if</span> [[ -z <span class="string">"<span class="variable">$OLCG</span>"</span> &amp;&amp; <span class="_">-f</span> <span class="string">"<span class="variable">$OPENSSLCONFIGPATHETC</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    OLCG=<span class="variable">$OPENSSLCONFIGPATHETC</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [[ -z <span class="string">"<span class="variable">$OLCG</span>"</span> &amp;&amp; <span class="_">-f</span> <span class="string">"<span class="variable">$OPENSSLCONFIGPATHUSR</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    OLCG=<span class="variable">$OPENSSLCONFIGPATHUSR</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [[ -z <span class="string">"<span class="variable">$OLCG</span>"</span> &amp;&amp; <span class="_">-f</span> <span class="string">"<span class="variable">$OPENSSLCONFIGPATHPKI</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    OLCG=<span class="variable">$OPENSSLCONFIGPATHPKI</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$OPENSSLCONFIG</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    OLCG=<span class="variable">$OPENSSLCONFIG</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  DNS=$(genDNS)</span><br><span class="line">  <span class="comment"># log debug $DNS</span></span><br><span class="line"></span><br><span class="line">  cp <span class="variable">$OLCG</span> <span class="variable">$F_CERT_STORE</span>/openssl.cnf</span><br><span class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'[SAN]\nsubjectAltName='</span><span class="variable">$DNS</span> &gt;&gt; <span class="variable">$F_CERT_STORE</span>/openssl.cnf</span><br><span class="line">  openssl req -new -sha256 -key <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_KEY</span> -subj <span class="string">"/"</span> -reqexts SAN -config <span class="variable">$F_CERT_STORE</span>/openssl.cnf &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_CSR</span></span><br><span class="line">  rm -rf <span class="variable">$F_CERT_STORE</span>/openssl.cnf</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">genDNS</span></span>() &#123;</span><br><span class="line">  DML=<span class="variable">$&#123;DOMAINLIST//,/ &#125;</span></span><br><span class="line">  DNS=</span><br><span class="line">  IX=0</span><br><span class="line">  <span class="keyword">for</span> DOMAIN <span class="keyword">in</span> <span class="variable">$DML</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$IX</span>"</span> <span class="_">-gt</span> <span class="string">"0"</span> ]; <span class="keyword">then</span></span><br><span class="line">      DNS=<span class="variable">$DNS</span><span class="string">','</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    DNS=<span class="variable">$DNS</span><span class="string">'DNS:'</span><span class="variable">$DOMAIN</span></span><br><span class="line">    ((IX+=1))</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$DNS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">writeNginxConf</span></span>()&#123;</span><br><span class="line">  <span class="comment"># xTODO 应改成单个域名匹配, 而不是所有域名放置在一起</span></span><br><span class="line">  CONF=$(cat <span class="variable">$BIN_PATH</span>/<span class="variable">$SSL_VERIFY_CONF</span>)</span><br><span class="line">  DML=<span class="variable">$&#123;DOMAINLIST//,/ &#125;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">""</span> &gt; <span class="variable">$F_NGINX_CONF</span>/<span class="variable">$SSL_VERIFY_CONF</span></span><br><span class="line">  <span class="keyword">for</span> DOMAIN <span class="keyword">in</span> <span class="variable">$DML</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    DMS=<span class="variable">$&#123;CONF//\&#123;\&#123;DOMAIN\&#125;</span>\&#125;/<span class="variable">$DOMAIN</span>&#125;</span><br><span class="line">    DMS=<span class="variable">$&#123;DMS//\&#123;\&#123;F_NGINX_VERIFY\&#125;</span>\&#125;/<span class="variable">$F_NGINX_VERIFY</span>&#125;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$DMS</span>"</span> &gt;&gt; <span class="variable">$F_NGINX_CONF</span>/<span class="variable">$SSL_VERIFY_CONF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">""</span> &gt;&gt; <span class="variable">$F_NGINX_CONF</span>/<span class="variable">$SSL_VERIFY_CONF</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restartNginx</span></span>()&#123;</span><br><span class="line">  SYSCTL=`<span class="built_in">which</span> systemctl`</span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$SYSCTL</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="variable">$SYSCTL</span> restart nginx</span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  SERVICE=`<span class="built_in">which</span> service`</span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$SERVICE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="variable">$SERVICE</span> nginx restart</span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">fetchCert</span></span>()&#123;</span><br><span class="line">  curl -o <span class="variable">$F_CERT_STORE</span>/acme_tiny.py https://raw.githubusercontent.com/diafygi/acme-tiny/master/acme_tiny.py</span><br><span class="line">  python <span class="variable">$F_CERT_STORE</span>/acme_tiny.py --account-key <span class="variable">$F_CERT_STORE</span>/<span class="variable">$ACCOUNT_KEY</span> \</span><br><span class="line">    --csr <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_CSR</span> --acme-dir <span class="variable">$F_NGINX_VERIFY</span> &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SIGNED_CRT</span></span><br><span class="line"></span><br><span class="line">  curl -o <span class="variable">$F_CERT_STORE</span>/intermediate.pem https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</span><br><span class="line">  cat <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SIGNED_CRT</span> <span class="variable">$F_CERT_STORE</span>/intermediate.pem &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$CHAINED_PEM</span></span><br><span class="line"></span><br><span class="line">  curl -o <span class="variable">$F_CERT_STORE</span>/root.pem https://letsencrypt.org/certs/isrgrootx1.pem</span><br><span class="line">  cat <span class="variable">$F_CERT_STORE</span>/intermediate.pem <span class="variable">$F_CERT_STORE</span>/root.pem &gt; <span class="variable">$F_CERT_STORE</span>/full_chained.pem</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">end</span></span>()&#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">''</span></span><br><span class="line">  <span class="built_in">log</span> info <span class="string">'证书配置完成'</span></span><br><span class="line">  <span class="built_in">log</span> info <span class="string">'已配置 https 的域名'</span></span><br><span class="line">  DML=<span class="variable">$&#123;DOMAINLIST//,/ &#125;</span></span><br><span class="line">  <span class="keyword">for</span> DOMAIN <span class="keyword">in</span> <span class="variable">$DML</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"\e[1;35m<span class="variable">$DOMAIN</span>\e[0m"</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">''</span></span><br><span class="line">  <span class="built_in">log</span> info <span class="string">' 在 Nginx 中有关证书配置的域名中设定如下配置, 以启用 https'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"\e[1;31mlisten              443 ssl;\e[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"\e[1;31mssl_certificate     <span class="variable">$F_CERT_STORE</span>/<span class="variable">$CHAINED_PEM</span>;\e[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"\e[1;31mssl_certificate_key <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_KEY</span>;\e[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"有关 Nginx 更多配置: https://imququ.com/post/my-nginx-conf.html"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">''</span></span><br><span class="line">  <span class="built_in">log</span> info <span class="string">'执行 \e[1;31mcrontab -e\e[0m 命令, 在打开的编辑器中写入下方内容, 以启用定时更新脚本.'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"\e[1;31m0 0 1 * * <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SYNC_SH</span> &gt;/dev/null 2&gt;&amp;1\e[0m"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">sync</span></span>()&#123;</span><br><span class="line">  SYNC_SHELL=$(cat <span class="variable">$BIN_PATH</span>/<span class="variable">$SYNC_SH</span>)</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;F_CERT_STORE\&#125;</span>\&#125;/<span class="variable">$F_CERT_STORE</span>&#125;</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;F_NGINX_VERIFY\&#125;</span>\&#125;/<span class="variable">$F_NGINX_VERIFY</span>&#125;</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;ACCOUNT_KEY\&#125;</span>\&#125;/<span class="variable">$ACCOUNT_KEY</span>&#125;</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;DOMAIN_CSR\&#125;</span>\&#125;/<span class="variable">$DOMAIN_CSR</span>&#125;</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;SIGNED_CRT\&#125;</span>\&#125;/<span class="variable">$SIGNED_CRT</span>&#125;</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;CHAINED_PEM\&#125;</span>\&#125;/<span class="variable">$CHAINED_PEM</span>&#125;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$SYNC_SHELL</span>"</span> &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SYNC_SH</span></span><br><span class="line">  chmod +x <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SYNC_SH</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">main</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">  isRoot</span><br><span class="line">  <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'请使用 root 账户执行'</span></span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  userInput</span><br><span class="line">  <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  createAccount</span><br><span class="line"></span><br><span class="line">  createPrivateKey</span><br><span class="line"></span><br><span class="line">  createCSR</span><br><span class="line"></span><br><span class="line">  writeNginxConf</span><br><span class="line"></span><br><span class="line">  restartNginx</span><br><span class="line"></span><br><span class="line">  fetchCert</span><br><span class="line"></span><br><span class="line">  sync</span><br><span class="line"></span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main</span><br></pre></td></tr></table></figure>
<p><strong>ssl_verify.conf</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  server_name &#123;&#123;DOMAIN&#125;&#125;;</span><br><span class="line">  listen 80;</span><br><span class="line"></span><br><span class="line">  location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">    alias &#123;&#123;F_NGINX_VERIFY&#125;&#125;;</span><br><span class="line">    try_files $uri =404;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    rewrite ^/(.*)$ https://&#123;&#123;DOMAIN&#125;&#125;/$1 permanent;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>sync.sh</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span><br><span class="line"></span></span><br><span class="line"><span class="comment">## #######</span></span><br><span class="line"><span class="comment"># 自动更新脚本</span></span><br><span class="line"><span class="comment"># 此脚本为自动更新模板, 在执行 ecpt.sh 后会创建一个新的脚本并将信息配置为交互时填入的信息且加入到 crontab 中定时执行</span></span><br><span class="line"><span class="comment">## #######</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 证书存储目录</span></span><br><span class="line">F_CERT_STORE=&#123;&#123;F_CERT_STORE&#125;&#125;</span><br><span class="line"><span class="comment">## nginx ssl 验证目录</span></span><br><span class="line">F_NGINX_VERIFY=&#123;&#123;F_NGINX_VERIFY&#125;&#125;</span><br><span class="line"></span><br><span class="line">ACCOUNT_KEY=&#123;&#123;ACCOUNT_KEY&#125;&#125;</span><br><span class="line">DOMAIN_CSR=&#123;&#123;DOMAIN_CSR&#125;&#125;</span><br><span class="line">SIGNED_CRT=&#123;&#123;SIGNED_CRT&#125;&#125;</span><br><span class="line">CHAINED_PEM=&#123;&#123;CHAINED_PEM&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restartNginx</span></span>()&#123;</span><br><span class="line">  SYSCTL=`<span class="built_in">which</span> systemctl`</span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$SYSCTL</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="variable">$SYSCTL</span> restart nginx</span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  SERVICE=`<span class="built_in">which</span> service`</span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$SERVICE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="variable">$SERVICE</span> nginx restart</span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">python <span class="variable">$F_CERT_STORE</span>/acme_tiny.py --account-key <span class="variable">$F_CERT_STORE</span>/<span class="variable">$ACCOUNT_KEY</span> \</span><br><span class="line">  --csr <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_CSR</span> --acme-dir <span class="variable">$F_NGINX_VERIFY</span> &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SIGNED_CRT</span> || <span class="built_in">exit</span></span><br><span class="line">curl -o <span class="variable">$F_CERT_STORE</span>/intermediate.pem https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</span><br><span class="line">cat <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SIGNED_CRT</span> <span class="variable">$F_CERT_STORE</span>/intermediate.pem &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$CHAINED_PEM</span></span><br><span class="line"></span><br><span class="line">restartNginx</span><br></pre></td></tr></table></figure>
<p>整体目录结构看起来是这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── ecpt.sh</span><br><span class="line">├── ssl_verify.conf</span><br><span class="line">└── sync.sh</span><br></pre></td></tr></table></figure>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>若执行成功会显示类似如下日志信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">~# ./ecpt.sh </span><br><span class="line">* 选择证书存储目录: /data/cert/0u0</span><br><span class="line">* 选择 nginx ssl 验证目录: /data/wwwroot/ssl/</span><br><span class="line">* 选择 nginx 自定义配置文件目录: /etc/nginx/conf.d</span><br><span class="line">选择私钥加密类型(RSA/ECC)(RSA): </span><br><span class="line">* 输入认证的域名[多个使用 , 区分]: thief.0u0.me</span><br><span class="line">openssl 配置文件地址(/etc/ssl/openssl.cnf): </span><br><span class="line">Generating RSA private key, 4096 bit long modulus</span><br><span class="line">................................................................................++</span><br><span class="line">.................................++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Generating RSA private key, 4096 bit long modulus</span><br><span class="line">........................................................................................++</span><br><span class="line">................................................................++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line"> * Restarting nginx nginx                                                  [OK] </span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  9151  100  9151    0     0  12225      0 --:--:-- --:--:-- --:--:-- 12217</span><br><span class="line">Parsing account key...</span><br><span class="line">Parsing CSR...</span><br><span class="line">Registering account...</span><br><span class="line">Registered!</span><br><span class="line">Verifying thief.0u0.me...</span><br><span class="line">thief.0u0.me verified!</span><br><span class="line">Signing certificate...</span><br><span class="line">Certificate signed!</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  1647  100  1647    0     0   5159      0 --:--:-- --:--:-- --:--:--  5163</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  1967  100  1967    0     0  28235      0 --:--:-- --:--:-- --:--:-- 28507</span><br><span class="line"></span><br><span class="line">[INFO]: 证书配置完成</span><br><span class="line">[INFO]: 已配置 https 的域名</span><br><span class="line">thief.0u0.me</span><br><span class="line"></span><br><span class="line">[INFO]:  在 Nginx 中有关证书配置的域名中设定如下配置, 已启用 https</span><br><span class="line">listen              443 ssl;</span><br><span class="line">ssl_certificate     /data/cert/0u0/chained.pem;</span><br><span class="line">ssl_certificate_key /data/cert/0u0/domain.key;</span><br><span class="line">有关 Nginx 更多配置: https://imququ.com/post/my-nginx-conf.html</span><br><span class="line"></span><br><span class="line">[INFO]: 执行 crontab -e 命令, 在打开的编辑器中写入下方内容, 以启用定时更新脚本.</span><br><span class="line">0 0 1 * * /data/cert/0u0/sync.sh &gt;/dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>运行方式</p>
<blockquote>
<p>整个运行过程需要在 root 账户下进行, 可通过 <code>sudo -i</code> 或者 <code>su</code> 命令进入 root 账户</p>
</blockquote>
<p><code>ecpt.sh</code> 为执行脚本, <code>sync.sh</code> 为证书定时更新脚本模板, 执行成功后会在第一步输入的证书存放目录生成一个新的可执行脚本, <code>ssl_verify.conf</code> 为 nginx 配置模板, 用于进行 https 站点认证.</p>
<p>要求输入的信息解释</p>
<ul>
<li><p>* 选择证书存储目录: /data/cert/0u0<br>必填, 所有有关 https 证书和此脚本的文件存储均存放在此目录</p>
</li>
<li><p>* 选择 nginx ssl 验证目录: /data/wwwroot/ssl/<br>必填,此目录是用于进行站点认证时所访问的路径, 配置与 nginx 中(脚本中自动配置)</p>
</li>
<li><p>* 选择 nginx 自定义配置文件目录: /etc/nginx/conf.d<br>必填, nginx 自定义配置路径, 具体路径可通过 <code>/etc/nginx/nginx.conf</code> 中查看, 通常是 <code>include xx</code> 这样的语句</p>
</li>
<li><p>选择私钥加密类型(RSA/ECC)(RSA):<br>加密类型, 可选 RSA/ECC 类型, 若选择 ECC 后续还会跳出选择使用 [1: secp256r1]  [2: secp384r1] 算法, 默认 1</p>
</li>
<li><p>* 输入认证的域名[多个使用 , 区分]: thief.0u0.me<br>必填, 需要认证的域名, 多个使用 , 区分, 不要输入空格</p>
</li>
<li><p>openssl 配置文件地址(/etc/ssl/openssl.cnf):<br>openssl 配文件地址, 脚本中已经预定义了三个路径, 分别是<br><code>/etc/ssl/openssl.cnf</code><br><code>/usr/local/openssl/ssl/openssl.cnf</code><br><code>/etc/pki/tls/openssl.cnf</code><br>如果不输入将默认从这三个路径去找, 但是只要有输入将以输入的地址为最优先地址.</p>
</li>
</ul>
<h2 id="一些坑"><a href="#一些坑" class="headerlink" title="一些坑"></a>一些坑</h2><ul>
<li>必须要使用 root 账户执行, <code>sudo</code> 在测试时发生了 nginx 不能重启的问题.</li>
<li>执行 <code>ecpt.sh</code> 进行域名输入时, 多个域名使用半角 <code>,</code> 进行分割, 且不要出现空格(后果未知, 未进行测试).</li>
<li>执行 <code>ecpt.sh</code> 进行第二步输入 <code>选择 nginx ssl 验证目录</code> 时, 所输入的路径必须要在最后加入 <code>/</code> , 因为此处输入的路径是用于 nginx 的配置中, 若没有 <code>/</code> 会导致后续进行验证失败 (我就是不在脚本给处理了 ╮(╯▽╰)╭ ).</li>
<li>因 nginx 配置特性, 同一个域名和端口只能够有一个 <code>server</code>, 因此, 在执行本脚本时输入的域名在 nginx 配置中一定不要有 <code>80</code> 端口的其他配置, 否则会导致认证失败.</li>
<li>执行成功后最后的日志输入, 定时更新脚本未自动写入到 <code>crontab</code> 中, 请手动执行 <code>crontab -e</code> 进行追加 (使用 root 账户).</li>
</ul>
<p>关于此脚本所做的事情看文章开始提供的链接查看.</p>
<p>收工 (￣ω￣) </p>
<p>喔 不, 看上面的执行日志就看到了, <a href="https://thief.0u0.me" target="_blank" rel="external">thief.0u0.me</a> 对 就是这个~</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/ssl/" class="post__tag__link">ssl</a></li><li class="post__tag__item"><a href="/tags/lesencrypt/" class="post__tag__link">lesencrypt</a></li><li class="post__tag__item"><a href="/tags/https/" class="post__tag__link">https</a></li></ul><a href="/post/letsencrypt-auto-shell/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-11-28T13:56:37.000Z" class="post__time">November 28, 2016</time><h1 class="post__title"><a href="/post/final-ng-II-part-1/">ng2 ngcli</a></h1></header><div class="post__main echo"><h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>Angularjs 2 目前已经进入正式版, 相对的后续的变动已经不会有很大的变化, 相较于 Angularjs 1 已经是完全不同, 所以在学习 ng2 的时候完全抛弃掉 ng1 时的使用经验, 可以说完全没有任何帮助.</p>
<blockquote>
<p>插曲</p>
<p>曾经有人在 <code>segmentfault</code> 问, <a href="https://segmentfault.com/q/1010000003885199" target="_blank" rel="external">angular2出来以后，angular1你还在用吗？</a><br>我也有去回复</p>
<p><code>那我问你? jquery 2.x 都出来这么久了 jquery 1.x 已经死了吗?</code></p>
<p>然而, 应该是不被大多数人去理解的.<br>不说为什么不被理解, 在这里只能说是 ng1 不会死, 至少短期内, 就像到现今仍然能够找到很多 1.x 的 jquery 一样, 甚至是版本非常低.<br>一个非常重要的原因就是, 老系统!<br>你确定你能够将一整个站从 ng1 升到 ng2 去???<br>当然, 这不是绝对的, 所以, ng1 仍然会有人去用, 而且不再少数.</p>
</blockquote>
<p>ng2 的发布带来了一个新东西, <a href="https://github.com/angular/angular-cli" target="_blank" rel="external">ngcli</a>, 这能极大的简化 ng2 在开发上的流程, 采用 <a href="http://coolshell.cn/articles/4535.html" target="_blank" rel="external">CoC(惯例优于配置原则)</a> 原则, 在开发过程中, 很多情况下无需去考虑很多繁杂的配置, 专注于工程编码即可.</p>
<p>ng2 默认采用 TypeScript 作为工程编码脚本, 但是也可以切换为 Dart 或者仅是 JavaScript 开发. 但是官方目前建议的方式是 TypeScript, 且官网的案例大都是 TypeScript, 使用 TypeScript 开发可以使用 ES6/7 的最新语法, 而不必去关心浏览器支援问题, 在最终发布时可以通过 ngcli 来翻译为 ES5 语法供浏览器访问.</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol>
<li>安装 <a href="https://nodejs.org/" target="_blank" rel="external">node/npm</a></li>
</ol>
<blockquote>
<p>ngcli 要求<br>node &gt; 5.x.x<br>npm  &gt; 3.x.x</p>
</blockquote>
<ol>
<li>安装 ngcli</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g angular-cli</span><br></pre></td></tr></table></figure>
<p>安装完成后可通过 <code>ng</code> 命令使用 ngcli.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ng -v</span><br><span class="line">angular-cli: 1.0.0-beta.20-4</span><br><span class="line">node: 6.9.1</span><br><span class="line">os: linux x64</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>建立 ng2 工程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng new project</span><br></pre></td></tr></table></figure>
<p>这个过程比较慢, ng 在创建工程时候, 会去下载工程相关套件, 时间取决于网络环境速度.</p>
<p>创建完成后, 就可以直接在这个工程中进行开发了.</p>
<p>进入工程, 并启动工程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> project</span><br><span class="line">ng server</span><br></pre></td></tr></table></figure>
<p>此时进入浏览器访问 <code>localhost:4200</code> 即可访问刚创建的工程.</p>
<h2 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h2><h3 id="ng-help"><a href="#ng-help" class="headerlink" title="ng help"></a>ng help</h3><p>查看 ng 帮助文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ng build &lt;options...&gt;</span><br><span class="line">  Builds your app and places it into the output path (dist/ by default).</span><br><span class="line">  aliases: b</span><br><span class="line">  --target (String) (Default: development)</span><br><span class="line">    aliases: -t &lt;value&gt;, -dev (--target=development), -prod (--target=production)</span><br><span class="line">  --environment (String) (Default: )</span><br><span class="line">    aliases: -e &lt;value&gt;</span><br><span class="line">  --output-path (Path) (Default: null)</span><br><span class="line">    aliases: -o &lt;value&gt;</span><br><span class="line">  --watch (Boolean) (Default: false)</span><br><span class="line">    aliases: -w</span><br><span class="line">  --watcher (String)</span><br><span class="line">  --suppress-sizes (Boolean) (Default: false)</span><br><span class="line">  --base-href (String) (Default: null)</span><br><span class="line">    aliases: -bh &lt;value&gt;</span><br><span class="line">  --aot (Boolean) (Default: false)</span><br><span class="line"></span><br><span class="line">ng completion</span><br><span class="line">  Adds autocomplete functionality to `ng` commands and subcommands</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<h3 id="ng-new"><a href="#ng-new" class="headerlink" title="ng new"></a>ng new</h3><p>创建新的工程, 创建工程时会建立好整个工程结构的目录, 且将所有用到的组件放入在 <code>package.json</code> 文件中, 然后会去下载这些组件; 此外还会建立一个初始的工程运行环境, 包括单元测试等.</p>
<h3 id="ng-generate-g"><a href="#ng-generate-g" class="headerlink" title="ng generate(g)"></a>ng generate(g)</h3><p>用来创建在 ng2 中开发的 组件(component), 服务(service) 等模板. generate 指令可以通过 g 别名的方式执行, 具体可参考 <code>ng help</code> 的文档.</p>
<p>例如, 如果需要创建一个组件可以通过 <code>ng g component</code> 来生成, component 也可以通过其别名 <code>c</code> 来替代, 此指令可简化为 <code>ng g c</code>.</p>
<p>更多的组件以及其别名方式.</p>
<table>
<thead>
<tr>
<th>Scaffold</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td>Component</td>
<td><code>ng g component my-new-component</code></td>
</tr>
<tr>
<td>Directive</td>
<td><code>ng g directive my-new-directive</code></td>
</tr>
<tr>
<td>Pipe</td>
<td><code>ng g pipe my-new-pipe</code></td>
</tr>
<tr>
<td>Service</td>
<td><code>ng g service my-new-service</code></td>
</tr>
<tr>
<td>Class</td>
<td><code>ng g class my-new-class</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>ng g interface my-new-interface</code></td>
</tr>
<tr>
<td>Enum</td>
<td><code>ng g enum my-new-enum</code></td>
</tr>
<tr>
<td>Module</td>
<td><code>ng g module my-module</code></td>
</tr>
</tbody>
</table>
<p>ng g 产生的代码会存在在预设的目录下, 若要指定目录可通过创建时指定相对路径设定, 例如, <code>ng g c test</code> 存放在 <code>src/app/test</code> 目录下, 若要指定目录, 可通过 <code>ng g c admin/test</code>, 这样生成的代码将在 <code>src/app/admin/test</code> 中.</p>
<h3 id="ng-build"><a href="#ng-build" class="headerlink" title="ng build"></a>ng build</h3><p>此指令就是将使用 TypeScript 编写的工程转换为最终部署的代码, 最终将转换的代码放入 <code>dist</code> 目录中, 这样 <code>dist</code> 目录中的代码就可以作为最终部署的代码. 如果是正式的部署环境中此处构建还可以使用 <code>ng build --prod</code> 指令来将最终打包的 js 代码进行压缩.</p>
<h3 id="ng-server"><a href="#ng-server" class="headerlink" title="ng server"></a>ng server</h3><p>在开发过程中可通过此命令来实时看到代码修改的结果, 并且此服务会自动代码改动后自动重新编译以及自动刷新浏览器, 因此保存代码后将无需刷新浏览器即可预览代码修改的结果.</p>
<h3 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h3><p>更多实用的可通过 ngcli <a href="https://github.com/angular/angular-cli" target="_blank" rel="external">文档</a>或者 <code>ng help</code> 查阅.</p>
<h2 id="ngcli-工程结构"><a href="#ngcli-工程结构" class="headerlink" title="ngcli 工程结构"></a>ngcli 工程结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── angular-cli.json</span><br><span class="line">├── e2e</span><br><span class="line">│   ├── app.e2e-spec.ts</span><br><span class="line">│   ├── app.po.ts</span><br><span class="line">│   └── tsconfig.json</span><br><span class="line">├── karma.conf.js</span><br><span class="line">├── node_modules</span><br><span class="line">│   ├── ...</span><br><span class="line">│   └── ...</span><br><span class="line">├── package.json</span><br><span class="line">├── protractor.conf.js</span><br><span class="line">├── README.md</span><br><span class="line">├── src</span><br><span class="line">│   ├── app</span><br><span class="line">│   │   ├── app.component.css</span><br><span class="line">│   │   ├── app.component.html</span><br><span class="line">│   │   ├── app.component.spec.ts</span><br><span class="line">│   │   ├── app.component.ts</span><br><span class="line">│   │   ├── app.module.ts</span><br><span class="line">│   │   └── index.ts</span><br><span class="line">│   ├── assets</span><br><span class="line">│   ├── environments</span><br><span class="line">│   │   ├── environment.prod.ts</span><br><span class="line">│   │   └── environment.ts</span><br><span class="line">│   ├── favicon.ico</span><br><span class="line">│   ├── index.html</span><br><span class="line">│   ├── main.ts</span><br><span class="line">│   ├── polyfills.ts</span><br><span class="line">│   ├── styles.css</span><br><span class="line">│   ├── test.ts</span><br><span class="line">│   ├── tsconfig.json</span><br><span class="line">│   └── typings.d.ts</span><br><span class="line">└── tslint.json</span><br></pre></td></tr></table></figure>
<ul>
<li><p>protractor.conf.js 于 e2e<br>e2e(end to end) 测试, ngcli 产生的工程会使用 <a href="http://www.protractortest.org/" target="_blank" rel="external">protractor</a> 来进行 e2e 测试, 测试的相关配置存放在 <code>protractor.conf.js</code> 文件中.</p>
</li>
<li><p>node_modules<br>工程依赖</p>
</li>
<li><p>src<br>工程代码目录</p>
</li>
<li><p>.editorconfig<br>一个给 IDE 识别的编码风格文件, 关于 editorconfig 配置可至 <a href="http://editorconfig.org/" target="_blank" rel="external">editorconfig</a> 查看.</p>
</li>
<li><p>angular-cli.json<br>ngcli 工程识别配置文件, 配置工程信息, 以及打包等相关设定.</p>
</li>
<li><p>karma.conf.js<br>ngcli 工程使用 <a href="https://karma-runner.github.io/1.0/index.html" target="_blank" rel="external">karma</a> 进行单元测试, 此为 karma 相关配置, 可使用 <code>ng test</code> 进行测试.</p>
</li>
<li><p>tslint.json<br>可以通过 <a href="https://palantir.github.io/tslint/" target="_blank" rel="external">tslint</a> 进行 TypeScript 编码风格校验, 可通过指令 <code>ng lint</code> 执行.</p>
</li>
</ul>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/ng2/" class="post__tag__link">ng2</a></li><li class="post__tag__item"><a href="/tags/angularjs/" class="post__tag__link">angularjs</a></li></ul><a href="/post/final-ng-II-part-1/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-11-05T09:09:06.000Z" class="post__time">November 5, 2016</time><h1 class="post__title"><a href="/post/remedy-chmod-777-root/">补救 chmod -R 777 /</a></h1></header><div class="post__main echo"><p>因某 xx 在服务器中执行了 <code>chmod -R 777 /</code> 命令, 遂就有了这篇文章.</p>
<p>补救前提: 你至少要有一种方式能进入到系统中, 或者执行 <code>chmod -R 777 /</code> 没有退出该命令窗口.<br>如果做不到这个前提, 那么只能 gg.</p>
<p><code>chmod</code> 命令是用来赋权的, <code>777</code> 权限是 用户/组/其他人 都有 读/写/执行 权限, 但是在 Linux 中一些文件的所属人是特有的, 不可更改.</p>
<p>执行这个命令后会发现 <code>ssh</code> 无法连接进入, 其原因则是 ssh 的相关文件权限被更改了, 那么将权限还原成初始状态即可恢复.</p>
<p>修改 ssh 权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc</span><br><span class="line">chmod 644 passwd group shadow</span><br><span class="line">chmod 400 gshadow</span><br><span class="line"><span class="built_in">cd</span> ssh</span><br><span class="line">chmod 600 moduli ssh_host_dsa_key ssh_host_key ssh_host_rsa_key</span><br><span class="line">chmod 644 ssh_config ssh_host_dsa_key.pub ssh_host_key.pub ssh_host_rsa_key.pub</span><br><span class="line">chmod 640 sshd_config</span><br></pre></td></tr></table></figure>
<p>接下来, 修改 <code>/var/empty/sshd</code> 目录权限, 否则将无法重启 <code>ssh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R root.root /var/empty/sshd</span><br><span class="line">chmod 744 /var/empty/sshd</span><br></pre></td></tr></table></figure>
<p>权限更改后, 重启 <code>ssh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure>
<p>成功后就能通过 ssh 进入到系统中.</p>
<p>剩下来的事情就是, 备份需要备份的文件, 赶紧重装系统吧. 要恢复权限的地方绝壁不止 <code>ssh</code> 而已, 太多的文件要改了.</p>
<p>注意, 在其操作过程中, 切忌不可重启电脑, 直到备份文件全部拉出之后才可(虽然我没测试, 不过肯定会重启失败).</p>
<p>然而, 从修复前提来看, 如果有其他方式登入到系统或者执行后尚未退出, 其实就可以直接跳过修复 <code>ssh</code> 而是, 直接进行备份, 文中所述的需要修复 <code>ssh</code> 在备份, 就看你能不能遇到了 :)</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/linux/" class="post__tag__link">linux</a></li><li class="post__tag__item"><a href="/tags/chmod/" class="post__tag__link">chmod</a></li></ul><a href="/post/remedy-chmod-777-root/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-10-12T12:20:50.000Z" class="post__time">October 12, 2016</time><h1 class="post__title"><a href="/post/shell-boot-java-pro/">啟動 Java 程序 Shell 腳本</a></h1></header><div class="post__main echo"><p>早這之前就有寫過該腳本, 之前寫的時候也參照過別人寫的腳本, 最後的實現方式是將一些啟動時依賴打入到 jar 包中, 包括啟動類, classpath 等配置, 打包通過 maven 去實現的.<br>但是這種方式也有些許弊端, 因為 maven 中打包配置這些打包依賴真的很麻煩, 各種配置不統一, 跨項目文件移動等配置, 有興趣可以去看看 <a href="/post/nonsense-part-1/">当然, 我就是在扯淡</a> 中的 maven 案例.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">JAVA=java</span><br><span class="line">JAVA_OPTS=<span class="string">"-Xms512m -Xmx1536m -XX:PermSize=64M -XX:MaxPermSize=256m"</span></span><br><span class="line">MAIN_CLASS=com.example.project.Main</span><br><span class="line">PROCESS_NAME=ProjectName</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 脚本执行路径</span></span><br><span class="line">BIN_PATH=$(dirname $(readlink <span class="_">-f</span> <span class="variable">$0</span>))</span><br><span class="line"><span class="comment"># 项目根路径</span></span><br><span class="line">HOME_PATH=$(<span class="built_in">cd</span> <span class="variable">$&#123;BIN_PATH&#125;</span><span class="string">'/../'</span>; <span class="built_in">pwd</span>)</span><br><span class="line"><span class="comment"># 资源依赖路径</span></span><br><span class="line">LIB_PATH=<span class="variable">$&#123;HOME_PATH&#125;</span><span class="string">'/lib'</span></span><br><span class="line"><span class="comment"># 配置文件路径</span></span><br><span class="line">CONF_PATH=<span class="variable">$&#123;HOME_PATH&#125;</span><span class="string">'/conf'</span></span><br><span class="line"><span class="comment"># PID 文件</span></span><br><span class="line">PID_FILE=<span class="variable">$&#123;BIN_PATH&#125;</span><span class="string">'/'</span><span class="variable">$&#123;PROCESS_NAME&#125;</span><span class="string">'.pid'</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#echo $HOME_PATH</span></span><br><span class="line"><span class="comment">#echo $BIN_PATH</span></span><br><span class="line"><span class="comment">#echo $LIB_PATH</span></span><br><span class="line"><span class="comment">#echo $CONF_PATH</span></span><br><span class="line"><span class="comment">#echo $PID_FILE</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># ################</span></span><br><span class="line"><span class="comment"># 递归遍历所有目录加入到 classpath 中</span></span><br><span class="line"><span class="comment"># #################</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">_gcpath</span></span>()&#123;</span><br><span class="line">  res=<span class="variable">$1</span></span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> `ls <span class="variable">$1</span>`</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">local</span> path=<span class="variable">$1</span><span class="string">"/"</span><span class="variable">$file</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="_">-d</span> <span class="variable">$&#123;path&#125;</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span><span class="string">':'</span>$(_gcpath <span class="variable">$&#123;path&#125;</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span>:<span class="variable">$&#123;path&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$res</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ###########</span></span><br><span class="line"><span class="comment"># 接收需要加入到 classpath 的目录</span></span><br><span class="line"><span class="comment"># 依次拼接 classpath</span></span><br><span class="line"><span class="comment"># ###########</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">cppath</span></span>()&#123;</span><br><span class="line"> res=</span><br><span class="line"> count=<span class="variable">$#</span></span><br><span class="line"> index=0</span><br><span class="line"> <span class="keyword">for</span> parent <span class="keyword">in</span> $*</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">   ((index++))</span><br><span class="line">   res=<span class="variable">$&#123;res&#125;</span>$(_gcpath <span class="variable">$&#123;parent&#125;</span>)</span><br><span class="line">   <span class="comment">#((index&lt;count))&amp;&amp;(res=$&#123;res&#125;':')</span></span><br><span class="line">   <span class="keyword">if</span> ((index&lt;count))</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span><span class="string">':'</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="variable">$&#123;res&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line"> start)</span><br><span class="line">  <span class="built_in">echo</span> -n <span class="string">'Starting worker ... '</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="_">-f</span> <span class="variable">$&#123;PID_FILE&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">kill</span> -0 `cat <span class="variable">$&#123;PID_FILE&#125;</span>` &gt; /dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$&#123;PROCESS_NAME&#125;</span> already running as process `cat <span class="variable">$&#123;PID_FILE&#125;</span>`.</span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">## 获取项目 classpath</span></span><br><span class="line">  <span class="comment"># 取出依赖包路径</span></span><br><span class="line">  CPPATH=$(cppath <span class="variable">$&#123;LIB_PATH&#125;</span> <span class="variable">$&#123;CONF_PATH&#125;</span>)</span><br><span class="line">  <span class="comment"># cppath $LIB_PATH $CONF_PATH</span></span><br><span class="line">  <span class="comment"># echo $CPPATH</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">  COMMAND=<span class="variable">$&#123;JAVA&#125;</span><span class="string">' '</span><span class="variable">$&#123;JAVA_OPTS&#125;</span><span class="string">' '</span>-cp<span class="string">' '</span>\<span class="string">"<span class="variable">$&#123;CPPATH&#125;</span>\"' '<span class="variable">$&#123;MAIN_CLASS&#125;</span></span><br><span class="line">  # echo <span class="variable">$COMMEND</span></span><br><span class="line">  nohup <span class="variable">$&#123;COMMAND&#125;</span> &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"> </span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">   echo $!</span><br><span class="line">   if  echo -n $! &gt; "</span><span class="variable">$PID_FILE</span><span class="string">"</span><br><span class="line">   then</span><br><span class="line">    sleep 1</span><br><span class="line">    echo STARTED</span><br><span class="line">   else</span><br><span class="line">    echo FAILED TO WRITE PID</span><br><span class="line">    exit 1</span><br><span class="line">   fi</span><br><span class="line">  else</span><br><span class="line">   echo SERVER DID NOT START</span><br><span class="line">   exit 1</span><br><span class="line">  fi</span><br><span class="line"> ;;</span><br><span class="line"> stop)</span><br><span class="line">  echo -n 'Stopping worker ... '</span><br><span class="line">  if [ ! -f "</span><span class="variable">$PID_FILE</span><span class="string">" ]</span><br><span class="line">  then</span><br><span class="line">   echo "</span>no worker to stop (could not find file <span class="variable">$PID_FILE</span>)<span class="string">"</span><br><span class="line">  else</span><br><span class="line">   echo <span class="variable">$&#123;PID_FILE&#125;</span></span><br><span class="line">   kill -9 <span class="variable">$(cat "$PID_FILE")</span></span><br><span class="line">   rm "</span><span class="variable">$PID_FILE</span><span class="string">"</span><br><span class="line">   echo STOPPED</span><br><span class="line">  fi</span><br><span class="line"> ;;</span><br><span class="line"> restart)</span><br><span class="line">  shift</span><br><span class="line">  ./"</span><span class="variable">$0</span><span class="string">" stop <span class="variable">$&#123;@&#125;</span></span><br><span class="line">  sleep 3</span><br><span class="line">  ./"</span><span class="variable">$0</span><span class="string">" start <span class="variable">$&#123;@&#125;</span></span><br><span class="line"> ;;</span><br><span class="line"> status)</span><br><span class="line">  if [ ! -f "</span><span class="variable">$PID_FILE</span><span class="string">" ]</span><br><span class="line">  then</span><br><span class="line">    echo "</span>no worker is running.<span class="string">"</span><br><span class="line">  else</span><br><span class="line">    echo "</span>worker is running (pid=<span class="variable">$PID_FILE</span>)<span class="string">"</span><br><span class="line">  fi</span><br><span class="line"> ;;</span><br><span class="line"> *)</span><br><span class="line"> echo "</span>Usage: <span class="variable">$0</span> &#123;start|stop|restart|status&#125;<span class="string">" &gt;&amp;2</span><br><span class="line">esac</span></span><br></pre></td></tr></table></figure>
<p>使用的時候將腳本中的 <code>JAVA</code> <code>JAVA_OPTS</code> <code>MAIN_CLASS</code> <code>PROCESS_NAME</code> 變量值修改成自己項目的信息即可.</p>
<p>此腳本要求項目格式類似如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">├── bin</span><br><span class="line">│   └── service.sh</span><br><span class="line">├── conf</span><br><span class="line">│   └── ep.properties</span><br><span class="line">└── lib</span><br><span class="line">    └── example.jar</span><br></pre></td></tr></table></figure>
<p>bin 目錄下存放的是當前腳本<br>conf 存放項目的配置文件<br>lib 存放項目的依賴包, 並且包括啟動包</p>
<p>如果有不同的目錄結構, 修改這些配置的變量值.</p>
<p>啟動</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.sh start</span><br></pre></td></tr></table></figure>
<p>停止</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.sh stop</span><br></pre></td></tr></table></figure>
<p>重啟</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.sh restart</span><br></pre></td></tr></table></figure>
<p>狀態</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.sh status</span><br></pre></td></tr></table></figure>
<p>這個腳本中大抵上和之前使用的腳本方式類似, 只是將 clsspath 的提取從 maven 中提取到 bash 來實現, clsspath 的提取是該腳本中的兩個函數來實現</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ################</span></span><br><span class="line"><span class="comment"># 递归遍历所有目录加入到 classpath 中</span></span><br><span class="line"><span class="comment"># #################</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">_gcpath</span></span>()&#123;</span><br><span class="line">  res=<span class="variable">$1</span></span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> `ls <span class="variable">$1</span>`</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">local</span> path=<span class="variable">$1</span><span class="string">"/"</span><span class="variable">$file</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="_">-d</span> <span class="variable">$&#123;path&#125;</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span><span class="string">':'</span>$(_gcpath <span class="variable">$&#123;path&#125;</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span>:<span class="variable">$&#123;path&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$res</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ###########</span></span><br><span class="line"><span class="comment"># 接收需要加入到 classpath 的目录</span></span><br><span class="line"><span class="comment"># 依次拼接 classpath</span></span><br><span class="line"><span class="comment"># ###########</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">cppath</span></span>()&#123;</span><br><span class="line"> res=</span><br><span class="line"> count=<span class="variable">$#</span></span><br><span class="line"> index=0</span><br><span class="line"> <span class="keyword">for</span> parent <span class="keyword">in</span> $*</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">   ((index++))</span><br><span class="line">   res=<span class="variable">$&#123;res&#125;</span>$(_gcpath <span class="variable">$&#123;parent&#125;</span>)</span><br><span class="line">   <span class="comment">#((index&lt;count))&amp;&amp;(res=$&#123;res&#125;':')</span></span><br><span class="line">   <span class="keyword">if</span> ((index&lt;count))</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span><span class="string">':'</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="variable">$&#123;res&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>cppath 函數的作用是接收需要加入到 classpath 的目錄<br>_gcpath 函數用來遞歸提取這些目錄下的所有文件放入到 classpath 中</p>
<p>所有路徑都是使用在系統中的絕對路徑.</p>
<p>注意:<br>pid 文件默認是存放在 <code>bin/${PROCESS_NAME}.pid</code> 中, 在以前的使用經驗中發現將 pid 文件放在 <code>/tmp</code> 目錄是一種非常不靠譜的做法, 長時間運行後不知為何 <code>/tmp</code> 中的 pid 文件不見了, 具體使用時可根據項目需求自定義位置, 修改 <code>PID_FILE</code> 變量即可.</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/java/" class="post__tag__link">java</a></li><li class="post__tag__item"><a href="/tags/shell/" class="post__tag__link">shell</a></li></ul><a href="/post/shell-boot-java-pro/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-10-11T12:03:09.000Z" class="post__time">October 11, 2016</time><h1 class="post__title"><a href="/post/oracle-not-lonely/">《甲骨文》 夜空不寂寞 節選</a></h1></header><div class="post__main echo"><p>「妳跟其他同事說我很好色？」他說。</p>
<p>艾蜜莉說：「是。」</p>
<p>他試著勉強一笑，敷衍了事，但很明顯的，他不再喜歡艾蜜莉的存在。她開始在閒時找其他工作，不久就找到一份托兒所老師的工作。學校也在關外，但沒有台灣老闆，沒有工廠宿舍，也沒有夜班。她要去教英文。</p>
<p>六月，她提出了辭呈，老闆批評她。「你變了，」他說：「你以前很順從。自從你交了男朋友之後，完全不一樣了。」</p>
<p>「我沒變，」艾蜜莉說：「我只是更加了解你了。」</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/節選/" class="post__tag__link">節選</a></li><li class="post__tag__item"><a href="/tags/甲骨文/" class="post__tag__link">甲骨文</a></li></ul><a href="/post/oracle-not-lonely/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-09-03T18:09:38.000Z" class="post__time">September 4, 2016</time><h1 class="post__title"><a href="/post/nginx-proxy-part-1/">Nginx 反向代理不完全指南 - 1</a></h1></header><div class="post__main echo"><p>現行的開發項目中有很多都是前後端分離的方式進行開發, 因此在最終部署的時候, 前後端並不是部署在一次的, 然而, 如果是分開部署的話前端訪問時就會有跨域的問題.</p>
<p>此文所述的解決方式是使用 Nginx 的反向代理來實現</p>
<p>配置方式如下:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># example.com</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> example.com;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /home/www/wwwroot/project;</span><br><span class="line">        <span class="attribute">index</span> index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /api/ &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://local.example.com:8080/;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line"><span class="comment">#        proxy_set_header Host $host;</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span>  Host local.example.com:<span class="number">8080</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這裡配置的意思就是, 當 <code>example.com</code> 域名訪問時, 如果路徑是 <code>/api/</code> 則訪問後端接口, 否則進入前端的項目, 實現兩個項目在同域的處理.</p>
<p><code>/api/</code> 處的設置解析 </p>
<ul>
<li><code>localtion /api/</code> 後面 / 必須要, 如果沒加則會報錯(似乎是 404, 忘記了)</li>
<li><code>proxy_pass http://local.example.com:8080/</code> 這裡最後的 / 也是需要的, 沒加同樣不能正確的訪問</li>
<li><code>proxy_set_header  Host local.example.com:8080;</code> 這裡是設置轉發給目標地址的 host, 如果不設置, 將默認使用瀏覽器返回的 header 頭中的 Host 屬性值, 比如這裡就會使用 <code>example.com/api</code>, 因為大多數情況, 後臺的服務可能是個獨立的服務, 是有可能也綁定了另一個域名, 或者只是通過二級目錄訪問, 如果用的不是被綁定的域名, 則無法通過服務的解析(目前的做法是後臺部署使用 Tomcat, 綁定了另一個寫在 host 的域名(該方式在以前的博文中也提到過), 因此此處修改成在 Tomcat 中綁定的域名).</li>
<li><code>proxy_set_header X-Real-IP $remote_addr;</code> 將真實的訪問人 IP 發送給後端, 否則後端無法獲取到正確的 IP</li>
<li><code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</code> 將真實的訪問人 IP 發送給後端, 否則後端無法獲取到正確的 IP</li>
</ul>
<p>更多詳細的代理配置見:<br><a href="http://zhangge.net/5054.html" target="_blank" rel="external">http://zhangge.net/5054.html</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/nginx/" class="post__tag__link">nginx</a></li><li class="post__tag__item"><a href="/tags/proxy/" class="post__tag__link">proxy</a></li></ul><a href="/post/nginx-proxy-part-1/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-09-03T17:35:03.000Z" class="post__time">September 4, 2016</time><h1 class="post__title"><a href="/post/pg-setup-centos/">Centos postgresql 部署</a></h1></header><div class="post__main echo"><h2 id="添加源"><a href="#添加源" class="headerlink" title="添加源"></a>添加源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CentOS/RHEL 7</span><br><span class="line"><span class="comment"># rpm -Uvh http://yum.postgresql.org/9.5/redhat/rhel-7-x86_64/pgdg-centos95-9.5-2.noarch.rpm</span></span><br><span class="line"></span><br><span class="line">CentOS/RHEL 6</span><br><span class="line"><span class="comment"># rpm -Uvh http://yum.postgresql.org/9.5/redhat/rhel-6-x86_64/pgdg-redhat95-9.5-2.noarch.rpm</span></span><br><span class="line"></span><br><span class="line">CentOS/RHEL 5</span><br><span class="line"><span class="comment"># rpm -Uvh http://yum.postgresql.org/9.5/redhat/rhel-5-x86_64/pgdg-redhat95-9.5-2.noarch.rpm</span></span><br></pre></td></tr></table></figure>
<h2 id="安裝-Postgresql-服務"><a href="#安裝-Postgresql-服務" class="headerlink" title="安裝 Postgresql 服務"></a>安裝 Postgresql 服務</h2><p>選取 postgresql 9.5</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install postgresql95-server postgresql95</span></span><br></pre></td></tr></table></figure>
<h2 id="初始化數據庫"><a href="#初始化數據庫" class="headerlink" title="初始化數據庫"></a>初始化數據庫</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/pgsql-9.5/bin/postgresql95-setup initdb</span></span><br></pre></td></tr></table></figure>
<p>Postgresql 數據目錄 <code>/var/lib/pgsql/9.5/data/</code></p>
<h2 id="啟動-Postgresql-服務"><a href="#啟動-Postgresql-服務" class="headerlink" title="啟動 Postgresql 服務"></a>啟動 Postgresql 服務</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">開啟服務</span><br><span class="line"><span class="comment"># systemctl start postgresql-9.5</span></span><br><span class="line">開機啟動</span><br><span class="line"><span class="comment"># systemctl enable postgresql-9.5</span></span><br></pre></td></tr></table></figure>
<h2 id="驗證"><a href="#驗證" class="headerlink" title="驗證"></a>驗證</h2><p>切換 postgres 賬戶<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># su - postgres</span></span><br></pre></td></tr></table></figure></p>
<p>進入數據庫<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ psql</span><br></pre></td></tr></table></figure></p>
<h2 id="修改密碼"><a href="#修改密碼" class="headerlink" title="修改密碼"></a>修改密碼</h2><p>使用 <code>psql</code> 進入數據庫後</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\password postgres</span><br></pre></td></tr></table></figure>
<h2 id="創建新的賬戶"><a href="#創建新的賬戶" class="headerlink" title="創建新的賬戶"></a>創建新的賬戶</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> uname <span class="keyword">with</span> <span class="keyword">password</span> <span class="string">'passwd'</span>;</span><br></pre></td></tr></table></figure>
<h2 id="創建賬戶所屬庫"><a href="#創建賬戶所屬庫" class="headerlink" title="創建賬戶所屬庫"></a>創建賬戶所屬庫</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> dbname owner uname;</span><br></pre></td></tr></table></figure>
<h2 id="為創建庫賦權"><a href="#為創建庫賦權" class="headerlink" title="為創建庫賦權"></a>為創建庫賦權</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> <span class="keyword">database</span> dbname <span class="keyword">to</span> uname;</span><br></pre></td></tr></table></figure>
<h2 id="賬戶登錄數據庫"><a href="#賬戶登錄數據庫" class="headerlink" title="賬戶登錄數據庫"></a>賬戶登錄數據庫</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U uname -d dbname -h 127.0.0.1 -p 5432</span><br></pre></td></tr></table></figure>
<h2 id="允許遠程登錄"><a href="#允許遠程登錄" class="headerlink" title="允許遠程登錄"></a>允許遠程登錄</h2><p>修改在 postgresql 數據目錄下的 <code>pg_hba.conf</code> 文件, 將</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host all all 127.0.0.1/32 trust</span><br></pre></td></tr></table></figure>
<p>改成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host all all 0.0.0.0/0 md5</span><br></pre></td></tr></table></figure>
<p>允許的 IP 以及網段視具體情況而定</p>
<h2 id="本地無法登入"><a href="#本地無法登入" class="headerlink" title="本地無法登入"></a>本地無法登入</h2><p>同樣修改 <code>pg_hba.conf</code> 配置文件, 找到 local 行配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local all all peer</span><br></pre></td></tr></table></figure>
<p>將 peer 改成 md5</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/deploy/" class="post__tag__link">deploy</a></li><li class="post__tag__item"><a href="/tags/postgresql/" class="post__tag__link">postgresql</a></li></ul><a href="/post/pg-setup-centos/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-07-14T13:42:58.000Z" class="post__time">July 14, 2016</time><h1 class="post__title"><a href="/post/lose-ability/">能力的丧失</a></h1></header><div class="post__main echo"><p>今天来说一说能力的丧失</p>
<p>在这之前先说几则可能很多人都听说过的故事</p>
<ol>
<li><p>烧饼 OR 西瓜 </p>
<blockquote>
<p>妻子对正要上班出门程序员丈夫说: “晚上回来时买两个烧饼,如果看到卖西瓜的,买一个.”<br>转眼到了下午下班,丈夫回到家把一个烧饼放到桌上,妻子怒问: “为什么就买一个烧饼?!”<br>丈夫答曰: “因为我看到了卖西瓜的.”</p>
</blockquote>
</li>
<li><p>摧毁</p>
<blockquote>
<p>一个合格的程序员是不会写出诸如“摧毁地球”这样的程序的,他们会写一个函数叫”摧毁行星”,而把地球当一个参数传进去.</p>
</blockquote>
</li>
<li><p>1024</p>
<blockquote>
<p>店主: 1050, 不还价.<br>码农: 便宜点, 凑个整吧.<br>店主: 1000?<br>码农: 1024. </p>
</blockquote>
</li>
</ol>
<p>故事到这, 想必应该知道要说的是什么了.</p>
<p>那么再说一个我的故事</p>
<p>店主: 共 22.5<br>我: 掏出 23<br>我: 再拿一个 x<br>店主: 共 38.5<br>我: 一脸茫然<br>我: 掏出 15<br>我: 一脸茫然<br>我: 再掏出 5<br>店主: 打包<br>店主: 找 4.5<br>我: 一脸茫然<br>我: 开门走人</p>
<p>好, 到这里, 可能看我说完, 应该是会觉得一脸茫然是因为数学没学好 (不否认).<br>然而我的一脸茫然却是因为, 我是把这当作两件事情看待, 因为长期的工作中, 思维方式潜移默化的会将复杂的事情分开做, 每件事情都应该独立完成, 而并非是交叉的方式.<br>人脑其实和 Javscript 的解析器很相似, 都是单线程运行的, 无法同时运作多件事情.<br>如果店主的处理方式是</p>
<p>店主: 共 22.5<br>我: 掏出 23<br>我: 再拿一个 x<br>店主: 找 0.5<br>店主: 打包<br>我: 掏出 20<br>店主: 找 4<br>我: 开门走人</p>
<p>这应该才是最简单直接以及便于理解的方案.</p>
<p>这时<br>店主: 错!</p>
<p>没错, 对于商铺来说, 这效率是非常低下的, 这期间会浪费掉很多的时间, 因此也就造成了各个店铺收银员强大的点钞技能, 能够在很短的时间内就可以合并多次计算的结果.</p>
<p>最后, 题目所说的能力的丧失(或者说其实压根就没有获得过该能力), 就是 1024 凑整的事情真的有可能发生的身边.</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/lose/" class="post__tag__link">lose</a></li></ul><a href="/post/lose-ability/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-07-11T15:04:53.000Z" class="post__time">July 11, 2016</time><h1 class="post__title"><a href="/post/moan-part-1/">呻吟</a></h1></header><div class="post__main echo"><p>實際上, 這篇才是今天想要寫的文章, 然而就連我自己都不知道要寫一些什麼, 有的只是對自己的不滿以及和自己抗爭失敗的情緒. </p>
<p>過來已經一月有餘了, 那篇在扯淡的廢文就已經在這裡, 之所以有那篇廢文其實也是自己的一些牴觸情緒, 如果說現在有什麼理由能讓我去學習 Spring MVC, MyBatis 等的動力, 唯一有可能的就是讓我來發現這中結合方式到底哪裡不足, 哪裡用的不爽, 哪裡有問題.<br>最終, 我還是放棄了, 理由其一不願意, 再者時間緊迫也無心花大把時間來深入研究, 當然這就是自己浮躁的地方了, 對, 已經浮躁了很久, 在加上以前的爛攤子, 每天都覺得時間不夠用, 但是又每天都會被很多很多無關緊要的事情分散注意力, 壓根就沒有好好的認真做事, 待反映過來的時候, 才悄然發現, 已經這麼久了, 接下來要做什麼, 已經完全沒有心情了.</p>
<p>然而很矛盾的是, 真的很有想要閒下來的時候, 而現在做的這些事情就像是在反抗自己, 以至於玩的不高興, 做事情不高興, 就沒真正認真做過一件事情.</p>
<p>然而還有飄忽不定的心情.</p>
<p>放不下<br>放不下<br>放不下啊!</p>
<p>很多時候, 我們都高估了自己, 高估了自己的自制力, 高估了自己的能力, 高估了自己的所有.<br>只有在失控的時候, 才會察覺到.</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/moan/" class="post__tag__link">moan</a></li></ul><a href="/post/moan-part-1/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-07-11T14:16:58.000Z" class="post__time">July 11, 2016</time><h1 class="post__title"><a href="/post/deploy-hackpad/">Hackpad 部署</a></h1></header><div class="post__main echo"><p>其實這篇就算不寫想要部署的你也應該能夠完成, 因為只需要看官方文檔就已經完全能夠成功部署, 那麼就當作記事吧.</p>
<p>首先, 如果你還不知道 Hackpad 是何物, 建議到 <a href="https://hackpad.com/" target="_blank" rel="external">Hackpad 官網</a> 試用.</p>
<p>然後 Hackpad 源碼地址: <a href="https://github.com/dropbox/hackpad" target="_blank" rel="external">Hackpad GIT</a> .</p>
<p>部署也很簡單, 參見 <a href="https://github.com/dropbox/hackpad/blob/master/INSTALL" target="_blank" rel="external">INSTALL</a>, 完全按照文檔中的流程操作即可.<br>該安裝文檔所贅述的安裝方式是在 Mac 環境下的部署方式, Linux 上部署流程也是相同.</p>
<ol>
<li>首先安裝 JDK 與 Scala, 只需要在其官網下載, 並且配置環境變量即可.</li>
<li><p>關於 MySQL 可以通過 <code>apt-get</code> <code>yum</code> 等方式安裝, 視你的操作系統.</p>
</li>
<li><p>修改 <code>bin/exports.sh</code> 將其中的 JAVA 以及 Scala 路徑修改成你部署的環境, 需要注意 Scala 的配置中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> SCALA_LIBRARY_JAR=<span class="string">"<span class="variable">$SCALA_HOME</span>/libexec/lib/scala-library.jar"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>此處的路徑, 可能在 Mac 中 Scala 有 libexec 這個路徑, 如果你是通過下載配置環境變量的方式, 在 Linux 中, 是沒有 libexec 路徑的, 直接 /lib 即可.</p>
</li>
<li><p>執行 <code>bin/build.sh</code></p>
</li>
<li><p>執行 <code>contrib/scripts/setup-mysql-db.sh</code> 創建數據庫</p>
</li>
<li><p>複製 <code>etherpad/etc/etherpad.localdev-default.properties</code> 為 <code>etherpad/etc/etherpad.local.properties</code><br>且修改複製的文件將一些配置信息改為你的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果按照默認方式配置 MySQL 庫 (`contrib/scripts/setup-mysql-db.sh`) 這裡無需更改</span></span><br><span class="line">etherpad.SQL_JDBC_URL = jdbc:mysql://localhost:3306/hackpad</span><br><span class="line">etherpad.SQL_PASSWORD = password</span><br><span class="line">etherpad.SQL_USERNAME = hackpad</span><br><span class="line"></span><br><span class="line"><span class="comment"># hackpad 最終運行時的域名</span></span><br><span class="line">etherpad.canonicalDomain = localhost:9000</span><br><span class="line"></span><br><span class="line"><span class="comment"># smtp 服務器設置</span></span><br><span class="line">smtpServer = __smtp_server__</span><br><span class="line">smtpUser = __smtp_user__</span><br><span class="line">smtpPass = __smtp_password__</span><br><span class="line"></span><br><span class="line"><span class="comment"># 管理員賬戶郵箱</span></span><br><span class="line">etherpad.superUserEmailAddresses = name1@example.com,name2@example.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>emoji 支持<br>下載 <a href="https://github.com/github/gemoji/tree/master/images/emoji/unicode" target="_blank" rel="external">https://github.com/github/gemoji/tree/master/images/emoji/unicode</a> 圖片 並複製到 <code>etherpad/src/static/img/emoji/unicode/</code> 即可</p>
</li>
<li><p>執行 <code>bin/run.sh</code> 啟動, 訪問 <a href="http://localhost:9000" target="_blank" rel="external">http://localhost:9000</a> 查看部署成功的 Hackpad</p>
</li>
<li><p>關於 Chrome 無法登錄問題<br>編輯 <code>infrastructure/framework-src/modules/global/response.js</code> 文件<br>將如下行註釋 <a href="https://hackpad.com/ep/pad/static/lM3FdARmrGD" target="_blank" rel="external">https://hackpad.com/ep/pad/static/lM3FdARmrGD</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// domain</span></span><br><span class="line"><span class="comment">//  if (c.domain) &#123; x += (’; domain=’+c.domain); &#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>同步 Dropbox 以及 Google Facebook 賬戶登錄<br>如果你在天朝, 那就別想了, 否則就在 <code>etherpad/etc/etherpad.local.properties</code> 相應的配置上填入相應值 (我沒試).</p>
</li>
</ol>
<p>題外:<br>MySQL 的安裝, 也可以通過手工安裝方式, 參照 <a href="http://www.jcore.cn/2015/11/30/install-cmake-mysql" target="_blank" rel="external">MySQL5.6源码安装</a> 該系列, 絕壁可以成功的方式.</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/hackpad/" class="post__tag__link">hackpad</a></li><li class="post__tag__item"><a href="/tags/deploy/" class="post__tag__link">deploy</a></li></ul><a href="/post/deploy-hackpad/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2016 iaceob</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><a title="Next" href="/page/2/" class="page-menu__link icon-arrow-right"></a></li></menu></footer></body></html>
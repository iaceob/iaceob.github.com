<!doctype html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/favicon.svg"> <title>role - 生物烯丙菊</title> <link rel="stylesheet" href="/css/style.css"> </head> <body> <header class="head"> <h1 class="head-title"><a href="/">生物烯丙菊</a></h1> <h3 class="head-description"> <span class="flashlight">达文西手电筒</span> </h3> <ul class="head-nav"> <li><a href="/">Home</a></li> <li><a href="/archives">Archives</a></li> <li><a href="http://blog.3u3.me">幾文山</a></li> </ul> </header> <main class="main"> <article class="post"> <header class="post-head"> <time datetime="2015-10-18T22:29:10.000Z">October 18, 2015</time> <h1><a href="/post/user-rights-assignment-design/">用户权限分配设计</a></h1> </header> <section class="post-main"><p>匆匆忙忙这这个月也过了大半了, 真没什么可说, 基本上都是在苦力活, 颇为无趣, 而且时间还各种紧, 就在前几天, 用了一天不到的时间写好一个工程(COPY), 原因是第二天就得要, 也就是在前一天通知要做, 这怎么可能把事做好....</p> <p>既然没什么说, 就谈谈以前的事情, 刚好这段时间, 同事在做权限管理的东西, 问我 <a title="Apache Shiro | Java Security Framework" href="http://shiro.apache.org" target="_blank">Shiro</a> 会不会使, 当然我并不会.</p> <p>Shiro 就是一个角色权限管理的方案, 在之前开发 Forevermark 的陈列系统时, 我是有考虑使用这玩意来控制权限的, 可最终抛弃了这个方案, 因为这个并不能满足需求, 那么就来说说为什么没用 Shiro 和权限分配的方式.</p> <p>那么开始.</p> <p>Shiro 的权限其实和 RBAC (我不知道这个是一种设计模式还是具体实现) 所实现的方式相同, 同是根据角色来判断用户的权限, 其核心思想如下:</p> <img src="/img/user-rights-assignment-design/1.png"> <p> </p> <p>这样的设计在实现权限管理时非常方便, 只需要将最终权限赋予某一个角色便可以, 所有这个角色下的用户都有这个角色的权限, Shiro 的实现便是如此, 人的权限控制完全依赖于角色(据我所知).</p> <p>其实按照上方的模式已经基本能实现权限的管理了, 不过毕竟天下尚未大同, 各种情况还是有的.</p> <p>譬如现在你要做一套某个公司的人事管理系统, 对权限的问题很敏感, 而且公司的各个部门只能划分非常明细, 这时候如果有一个新进的同事添加账户时, 就直接根据其所在的部门和所属的角色进行权限分配, 这时候还拿角色去分配权限就会导致问题.</p> <p>举个例子的话, 有三层部门结构, dep1&gt;dep2&gt;dep3, 这三个部门的人分别角色是 role1,role2,role3 所有的汇报工作都是依次向上级部门汇报, d2 这个部门的人都能够向 d1 汇报这个人所管理的下辖信息, d3 部门的人又只能汇报他自己的信息给自己的头, 类似于下图:</p> <img src="/img/user-rights-assignment-design/2.png"> <p>整套系统这么正常的运行着, 一段时间后 dep2 部门的 usr2 这个人觉得最近太累了, 想要休个长假, 公司也视 usr2 最近表现出色, 决定同意这个假期, 之后过了一周, 公司又接手一个项目, 决定交给蓝色方阵来完成, 恰好 usr2 休假了, 通过观察发现蓝色方阵的 uy 工作很认真, 遂决定临时交由 uy 代为管理蓝色方阵来实施这个项目, 当晚便将事项告知 uy</p> <p>到了第二天, uy 到了公司之后, 准备开始接手这个项目, 可是确发现 "唉..... 我收集不到蓝色方阵的问题啊", 遂, 找到公司的技术人员, 技术说会给你弄好的, 稍等, uy 就回去等待了.</p> <p>好, 就是这么个事情, 接下来就是问题的所在了, 技术前思后想之后发现, 这没法做啊, usr2 的角色 role2 有公司财务管理的权限, 但是 uy 只是临时管理蓝色方阵和这个项目, 不能让其有公司的财务管理操作啊, 又不能给 uy 所属的 role3 添加项目管理的权限, 一加的话蓝色方阵所有人不都有权限了, 这时候技术范难了, 不知道要怎么办才好, 最后和其他同事讨论, 给出的解决方案是, 新增了个 role4 给予 role3 的所有权限, 和 role2 中的项目管理权限, 把 uy 的角色转变为 role4 , 待项目结束或者 usr2 休假结束了在把 uy 的角色还原为 role3, 同时 role4 这个角色也留着, 以应对还有可能出现这种情况, 也就是如下关系</p> <img src="/img/user-rights-assignment-design/3.png"> <p> </p> <p>专门给 uy 开了个小灶, 最后功能也完成了, usr2 安心的休假, uy 专心做这个项目, usr1 也能时时跟进这个项目,技术也能实现了这样的需求, 可谓皆大欢喜.</p> <p>又过了不久, usr3 也觉到要很累, 想休个长假, 公司也同意了(良心企业), 又发生了和 uy 一样的情况, 黄色方阵中的某个员工又找到技术, 本来了技术惯性的想到要和 uy 的实现一样, 可是和这个员工沟通发现, 原来并不是这么简单, usr3 对于工作真的很认真, 就算是休假也会关心这边的工作, 所以实际情况是这位员工只是管理实际公司中遇到的问题, 并给 usr3 , 最终还是 usr3 提给 usr1........</p> <p>技术只好又开一个角色, 给予新的权限, 而且为了保证这个员工能收到黄色方针的问题, 只能把所有黄色方阵的所有人给将一级保证这个员工的权限要大于整个黄色方阵的且能够提交给 usr3, 最后问题也解决了.</p> <p>好, 例子说完了, 最后事情也算是完满解决了, 可是这种解决是建立在人为了程式的功能而进行了现实的改变为基础的, 而不是程式为了解决现实问题的结果, 创造了一个子虚无有的角色来满足实际情况, 虽然 uy 这个人可能什么都察觉不到, 只知道技术实现了这么个功能, 对现实而言这并没有错, 本来解决问题的方案就不是一种, 就成本而言这种方案是最简单最快速的.</p> <p>如果多次出现这种情况的话, 这个系统的权限管理就会变得非常乱.</p> <p>但这里讨论的重点不是这个.</p> <blockquote> <p>注意: 上方引入部门的概念其实只是为了更容易的区分, 实际上部门并不参与权限和管理, 因为在大多数人员管理的系统中肯定会有部门这个设定, 权限依然是在角色中, 比如 dep3 这个部门的所有人的角色都是 role3 , 角色和部门在这个案例中其实并无太大关联, 而且这只是个很简单的案例, 还有更为复杂的, 比如一个人可能属于多个角色, 也有可能属于多个部门, 更有甚着 同时是多个部门多个角色而且还有角色之间的交叉管理, 当然这就是具体的业务逻辑的问题了</p> </blockquote> <p> </p> <p>那么 如何解决这种问题了, 也就是本文所要说的方式, 将最终权限分配落入到每个人而不是角色, 针对角色的权限管理随着业务的变动有可能会出现各种问题.</p> <p>权限制定到每个人的核心思想如下图</p> <img src="/img/user-rights-assignment-design/4.png"> <p>这样就不必要使用到角色的权限分配了, 如果是这样的权限管理, 在来应对上方的案例, uy 这个人临时需要项目管理和跳级汇报就直接给他加项目管理的和汇报权限, 黄色方阵的那个员工临时需要项目管理就给项目管理的权限, 但是汇报的权限不给, 只能汇报给 usr3 这个人, 这样的问题就很简单的解决了.</p> <p>是不是逻辑非常清晰, 某个人需要什么就给他什么, 不需要就不给.</p> <p>同时这里也可以引入角色的概念, 不过角色不参与具体的权限分配, 而仅仅是标记作用, 告知用户所属的角色, 而且角色也可以选择权限, 但是这个权限不是最终作为权限管理使用, 而只是作为默认值, 意思就是说在添加用户的时候选择角色, 读取这个角色的权限, 然后把这个角色的权限写入到 用户 权限 关联表 中, 而不是 角色 权限 关联表, 如下图</p> <img src="/img/user-rights-assignment-design/5.png"> <p> </p> <p>实际权限管理使用的是 用户 权限 关联表, 角色 权限 关联表 只不过是参照作用, 没添加一个用户的时候每个权限都要选择这个很烦, 而且没有角色的话对用户的归类也不是很好, 因此, 加入角色这个概念, 添加用户的时候, 把其所选的所有的角色的权限 (角色 权限 关联表) 都赋给这个用户(用户 权限 关联表), 最终的权限管理从 用户的权限中读取即可.</p> <p> </p> <p>以上便是所说的权限管理方案了, 相对来说最后所提的 用户 权限 管理方案更加灵活, 可你变, 并不是说角色管理方案不可行, 像 Shiro , RBAC 的实现都是经过实际验证可行的, 而且记得在那听说过 Linux 的权限管理就是 RBAC 的技术实现, 也依稀记得以前在讨论 ThikPHP 的 RBAC 类是提过这事情.</p> <p>如果说 Linux 的权限管理是通过类 RBAC 也就是 角色权限管理实现的话, 这是可行的, 因为 Linux 的系统中的组, 比如 sudo www-data 等, 这些组是不会发生上述案例中的这种特殊情况, Linux 中的用户组不会有出现休假情况, 因此使用角色的权限管理当然是最好的方案, 为何还要通过针对到每个人了? 像 sudo 的用户组(角色)权限, 若添加多个用户都要给其付权限是多烦额一件事, 不如把账户添加好统一赋予 sudo 这个角色即可, 反正权限在角色中都已经赋好了, 用户直接继承这些权限就是.</p> <p>所以最初提到的没用 Shiro 控制权限的原因也就是因为出现来前文提到的案例, 其实 Forevermark 的陈列系统出现的案例比上文提到的还复杂些, 究其原因还是 Forevermark 自身的人员管理问题, 所以程式就得跟着这业务逻辑做改变咯.</p> <p>这个陈列系统运行最深的感受是, 用系统的人可能比开发系统的人更熟悉系统怎么使用, 这是题外话了, 有时间来说说这件趣事.</p> <p>所以说没有最好的方案, 只有最合适的方案, 解决问题的思路不止一种, 程式要根据具体业务逻辑来实现.</p> <p> </p> <p>啊, 总算写完了, 这个月不知还能不能在写一篇- -</p> <p> </p> <p> </p></section> <footer class="post-foot"> <ul class="post-tags"> <li><a href="/tag/design">design</a></li> <li><a href="/tag/linux">linux</a></li> <li><a href="/tag/permission">permission</a></li> <li><a href="/tag/rbac">rbac</a></li> <li><a href="/tag/role">role</a></li> <li><a href="/tag/shiro">shiro</a></li> <li><a href="/tag/user">user</a></li> </ul> </footer> </article> <menu class="page"> </menu> </main> <footer class="foot"> <div>&copy;2017 iaceob</div> </footer> </body> </html>
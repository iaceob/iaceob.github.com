<!doctype html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/favicon.svg"> <title>生物烯丙菊 - 达文西手电筒</title> <link rel="stylesheet" href="/css/style.css"> </head> <body> <header class="head"> <h1 class="head-title"><a href="/">生物烯丙菊</a></h1> <h3 class="head-description"> <span class="flashlight">达文西手电筒</span> </h3> <ul class="head-nav"> <li><a href="/">Home</a></li> <li><a href="/archives">Archives</a></li> <li><a href="http://blog.3u3.me">幾文山</a></li> </ul> </header> <main class="main"> <article class="post"> <header class="post-head"> <time datetime="2016-01-03T20:43:58.000Z">January 3, 2016</time> <h1><a href="/post/the-end/">这可能是最后了</a></h1> </header> <section class="post-main"><p>其实偶尔看看这里, 还是很有些感触的, 起初做这个博客是为了一个产品的维护支持而建的. <a href="/post/place-vpivci-search/">各地 VPI/VCI 查询</a> 可是最终这个产品也没什么卵用, 甚至连我自己都不知道这是个什么玩意, 完全就是为了做这个而做. 后来慢慢觉得维护一个博客也不错, 所以就一直坚持到现在, 开始那是 2013 年, 现在是 2015 年.</p> <p>两年过去了, 看看之前写的, 能够感觉到自己在进步, 这是值得高兴的.</p> <p>两年经历了很多, 期间也想过要放弃这里. 还专门写了最终篇, 可是最终还是没发出去, 放在私有文章中, 不舍是真.</p> <p>毕竟是花费了心血在做的.</p> <p>这里有记录一些学习感触, 也有些自己的情绪.</p> <p>最后并不是要放弃, 博客还是会继续下去, 不过不是在这里了, 考虑将这里的所有文章静态化, 域名也不变更 (今年 2 月, 不久之后域名便到期了, 考虑还是否在之前那注册商续费, 如果不的话 可能很久这里才会再次开放).</p> <p>所以这里不会在更新了.</p> <p>那么 再见.</p></section> <footer class="post-foot"> <ul class="post-tags"> <li><a href="/tag/end/">end</a></li> <li><a href="/tag/undefined/">undefined</a></li> </ul> </footer> </article> <article class="post"> <header class="post-head"> <time datetime="2015-12-24T22:18:01.000Z">December 24, 2015</time> <h1><a href="/post/original-interpretation-sql-group-by-with-rollup/">原文解讀 – SQL GROUP BY WITH ROLLUP</a></h1> </header> <section class="post-main"><p>现有表 test 如下数据:</p> <pre>continent           country                 sales
------   -------  -----
North America        Northwest            123237.00
North America        Northwest             37534.00
North America        Northwest             48003.00
North America        Southwest            164232.00
North America        Southeast             39667.00
North America        Southeast            105810.00
Europe               France                74569.00
Europe               Germany               59456.00
Pacific              Australia             93403.00
Europe               United Kingdom        78327.00</pre> <p><strong>需求一: 统计出各洲各国的总销售额</strong></p> <p><em>分析: 总销售额采用 sum(sales) 来获取, 然后使用 group by 来将各个国家合并<br/> </em></p> <pre>select continent, country, sum(sales) as total from test group by continent, country</pre> <p>结果:</p> <pre>continent                country                 total
------   ------   ------
Europe               France                74569.00
Europe               Germany               59456.00
Europe               United Kingdom        78327.00
North America        Northwest            208774.00
North America        Southeast            145477.00
North America        Southwest            164232.00
Pacific              Australia             93403.00</pre> <p>满足需求.</p> <p> </p> <p><strong>需求二: 在需求一的基础上, 增加各洲的销售总额, 以及所有国家 (所有州)的销售总额</strong></p> <p><em>分析: 逐个分析, 在需求一中已分析出各国的销售总额, 在计算出各州 以及 所有国家的总销售额, 使用 union 连接</em></p> <pre>select continent, country, sum(sales) as total from test group by continent, country
union

select continent, null, total from (
  select continent, sum(sales) as total from test group by continent
) as cyj

union
select null, null, total from (
  select sum(sales) as total from test
) as ct</pre> <p>结果:</p> <pre>continent                country                 total
-------  -------  -------
Europe               France                74569.00
Europe               Germany               59456.00
Europe               United Kingdom        78327.00
North America        Northwest            208774.00
North America        Southeast            145477.00
North America        Southwest            164232.00
Pacific              Australia             93403.00
Europe               &lt;null&gt;                 212352.00
North America        &lt;null&gt;                 518483.00
Pacific              &lt;null&gt;                  93403.00
&lt;null&gt;                 &lt;null&gt;                 824238.00</pre> <p>满足需求.</p> <p> </p> <p>另一种方案, 也是本文介绍的方案 GROUP BY WITH ROLLUP</p> <pre>select continent, country, sum(sales) as total from test
group by continent, country
with rollup</pre> <p>结果</p> <pre>continent                country                 total
-------  -------  -------
Europe               France                74569.00
Europe               Germany               59456.00
Europe               United Kingdom        78327.00
Europe               &lt;null&gt;                 212352.00
North America        Northwest            208774.00
North America        Southeast            145477.00
North America        Southwest            164232.00
North America        &lt;null&gt;                 518483.00
Pacific              Australia             93403.00
Pacific              &lt;null&gt;                  93403.00
&lt;null&gt;                 &lt;null&gt;                 824238.00</pre> <p>满足需求.</p> <p>-</p> <p>到这里, 基本上本文算是完毕了. group by with rollup 其实做的就是上面和 union 出来的结果一样的工作, 只不过更简洁有力.</p> <p>原文中还介绍了 grouping 这么个函数, 这个函数的作用就是判断查询的字段是否是 with rollup 出来的结果, 如果是就返回 1 不是就返回 0, 这样就能够用 case when 来给这个 with rollup 出来的 null 赋予一个期望值, 或者其他操作, 实际上, 这是不必要的, 倒是可用用 grouping 单独做一个字段来供程序判断, 若要给 null 赋值的话, 可以使用 isnull(continent,’xxx’) 这种方式 (MySQL 是 ifnull) 即可. grouping 的使用方式就不写了, 直接去看原文吧.</p> <p> </p> <p> </p> <p>原文链接: http://sqlandme.com/2011/07/07/sql-server-tsql-group-by-with-rollup/</p> <p>测试: http://sqlfiddle.com/#!9/225c3/7</p></section> <footer class="post-foot"> <ul class="post-tags"> <li><a href="/tag/database/">database</a></li> <li><a href="/tag/groupby/">groupby</a></li> <li><a href="/tag/mssql/">mssql</a></li> <li><a href="/tag/mysql/">mysql</a></li> <li><a href="/tag/rollup/">rollup</a></li> <li><a href="/tag/sql/">sql</a></li> <li><a href="/tag/with/">with</a></li> </ul> </footer> </article> <article class="post"> <header class="post-head"> <time datetime="2015-12-03T20:28:39.000Z">December 3, 2015</time> <h1><a href="/post/test-wordpress-feed/">測試 wordpress feed &lt;好暴力的過濾方式 ~&lt;.[[-_-]].&gt;~</a></h1> </header> <section class="post-main"><p>感覺這會出事 = =<br/> ~&lt;[[-_-]]&gt;~<br/> 不知道<br/> 搞不好還是大事 - -<br/> 但是從品牌效應來說, 覺得又不會,<br/> 我發了啊</p> <p> </p> <p>啊哈~, 果然沒事.</p> <p> </p> <pre>&lt;![CDATA[&lt;p&gt;感覺這會出事= =&lt;br /&gt;
~&lt;[[-_-]]&amp;gt;~&lt;br /&gt;
不知道&lt;br /&gt;
搞不好還是大事 &amp;#8211; &amp;#8211;&lt;br /&gt;
但是從品牌效應來說, 覺得又不會,&lt;br /&gt;
我發了啊&lt;/p&gt;
]]&gt;</pre> <p> </p> <p>看吧 果然出事了 哈哈哈哈</p> <p>各種閱讀器估計得有段時間看不到我這發佈的文章了~</p> <p> </p> <p> </p> <p>那剛好就趁着這篇文章來說說怎麼了, 其實很簡單, 就只是個 xss 攻擊</p> <p>前文中說沒事因爲是在正文中使用了 ]]&gt; , wordpress 會過濾掉, 但是 wordpress 的 feed 中有個 description 標籤, 是文章摘要. 這個會從 title 中取內容, 也就是文章表示, 而且使用了 CDATA 這玩意能讓 xml 標籤裏面能正常嵌入 &lt;&gt; , CDATA 區域的所有字符都會當作是文章, 而不是標籤, 區域從 &lt;![CDATA[ 開始, 直到第一次出現]]&gt; 結束.</p> <p>所以標題中出現了 ]]&gt; 但是沒過濾, 就導致 整個 xml 分析失敗, feed 就失效了~</p> <p>在有, 標題中其實也有過濾, 而且非常暴力, 如果標題出現了 &lt;/ &lt;ss&gt;, 這樣的 xml 的標記符, 會強制刪掉 = =</p> <p>只能說 wordpress 做的不徹底, 不過不是找虐估計也沒人會這麼發 ..</p> <p> </p> <p>我這先不改了就 等 pancake-blog 完工後導入這的文章在把標題改掉, 不然我自己就導入不鳥了 = =</p> <p> </p></section> <footer class="post-foot"> <ul class="post-tags"> <li><a href="/tag/feed/">feed</a></li> <li><a href="/tag/test/">test</a></li> <li><a href="/tag/undefined/">undefined</a></li> <li><a href="/tag/wordpress/">wordpress</a></li> </ul> </footer> </article> <article class="post"> <header class="post-head"> <time datetime="2015-11-25T21:00:25.000Z">November 25, 2015</time> <h1><a href="/post/this-time-to-talk-about-the-experience-of-doing-performance-optimization/">谈谈这段时间做的效能优化经历以及千奇百怪的时间提取方案</a></h1> </header> <section class="post-main"><p>如前些天的<a title="日常" href="/post/daily-part-1/">日常</a>说的那样, 要解决各式各样的时间解析问题, 最终在原有的提取方式上又加入了一层提取方式.</p> <p>说性能之前先谈谈网页具体时间获取的方式, 使用了四种途径获取.</p> <p>1. 首先会从各搜索引擎的结果页中提取时间</p> <img src="/img/this-time-to-talk-about-the-experience-of-doing-performance-optimization/1.png"> <p>这个时间有着非常高的不确定性, 并非所有都存在时间, 而且时间格式还不固定, 在有这个时间也并非就一定是内页的发布时间.</p> <p>2. 使用 url 来获取时间, 类似如下的 url</p> <p>http://example.com/2015/1125/test.html</p> <p>依此来获取时间就能得到很准确的具体发布时间了, 通常格式也就那么几种, 做提取也很容易.</p> <p>同样这也会存在问题, 譬如下面俩个链接</p> <p>http://example.com/2015/11/29812.html</p> <p>http://example.com/2015/11/75632.html</p> <p>若是不能分析好的话, 可能会造成第一个链接获取时间错误得到了 2015-11-29, 这并不是正确的.</p> <p>但是并非所有的站点链接都会有发布的时间, 而且不能精确到具体的时间, 只能够到某天.</p> <p>3. 使用大批量的正则在网页中来匹配时间格式.</p> <p>通常这种方式能够获取带很准确的时间信息, 只要是有存在时间, 并且有对应的正则匹配, 就能获取到详细的时间, 不过带来的问题是严重的性能消耗, 这也是下面将要提到的问题.</p> <p>4. 不靠谱的时间提取器</p> <p>这个了其实也是依赖正则匹配来提取, 实质上也和方案 3 类似, 不过类似与这种提取器所提取的时间, 错误率非常高, 通常会返回很多时间给你, 其中或许确实存在正确的时间, 但是无从判断哪个才是正确的, 与买彩票形式差不多.</p> <p>最终权衡, 这四种方式都作为时间提取的方案一并考虑, 优先的原则是, 2&gt;3&gt;4&gt;1 , 将从 url 中获取的时间作为最优先选择, 在而使用定向规则匹配, 在考虑提取器 最后考虑搜索结果页中的时间, 若都不能获取, 那只能说 byebye.</p> <p>按照上述的方式获取基本山是能够提取出千奇百怪的时间了</p> <p> </p> <p>接下来说说性能这事</p> <p>如上方说的第二种方案, 利用大批量正则匹配时间, 正则是非常消耗性能的, 拿具体的代码来演示性能这事吧.</p> <pre>List&lt;String&gt; regexList; // 假设这里面存在 n 多个正则表达式
</pre> <p> </p> <pre>public String extraTime(String content, String regex){
    Pattern p = Pattern.compile(regex);
    Matcher m = p.matcher(content);
    if (!m.find()) return null;
    return m.group("name");
}

public void extra(){
    String content = ""; // 假设这就是要提取的文本
    for (Integer i=0; i&lt;regexList.size(); i++) {
        this.extraTime(content, regexList.get(i));
    }
}
</pre> <p>另一种方式</p> <pre>public String mergeRegex(){
    StringBuilder sb = new StringBuilder();
    for (Integer i=0; i&lt;regexList.size(); i++) {
        sb.append("(").append(regesList.get(i))
             .append(i+1==regexList.size() ? ")" : ")|");
    }
    return sb.toString();
}
public void extra(){
    String content = "";
    Pattern p = Pattern.compile(this.mergeRegex());
    Matcher m = p.matcher(content);
    if (!m.find()) return;
    m.group("name");
}
</pre> <p>优化方式只是把每个正则分别提取改为了把所有正则合并为一个正则用或的关系放在一次, 减少了多次创建 Pattern 类, 从而提高匹配的效率, 这个结果是非常明显的.</p> <p>其实道理大家都懂= = 也听说过正则很慢, 可是从第一反映仍然是使用逐个遍历的方案, 也有不想思考的原因, 只有到问题出现了才会去想办法解决....<br/> 正则真的很慢, 而且性能开销非常大, 能不用就不用.</p> <p>(文中代码并不具有实际作用, 只是实现逻辑而已)</p></section> <footer class="post-foot"> <ul class="post-tags"> <li><a href="/tag/extra/">extra</a></li> <li><a href="/tag/java/">java</a></li> <li><a href="/tag/pattern/">pattern</a></li> <li><a href="/tag/time/">time</a></li> </ul> </footer> </article> <article class="post"> <header class="post-head"> <time datetime="2015-11-23T21:48:07.000Z">November 23, 2015</time> <h1><a href="/post/enemy-friend/">敵人 朋友</a></h1> </header> <section class="post-main"><p> </p> <p>有一次我問王雪松, 誰是中國的敵人. 我們的這一段交談是我在涪陵比較值得回味的一次交談.</p> <p>"英國," 他立即回答</p> <p>"爲什麼?"</p> <p>"因爲鴉片戰爭, 他們從我們中國偷走了香港."</p> <p>我問他, 除了英國還有其他的敵人嗎?</p> <p>他再度立刻回答.</p> <p>"日本, 因爲他們發動了南京大屠殺."</p> <p>"還有了?"</p> <p>"葡萄牙."</p> <p>我問爲什麼, 這一次他得想一會兒.</p> <p>"因爲他們拿走了廣州."</p> <p>我不理會這個錯誤, 只假定他想說的是澳門. 我再度問他一個問題.</p> <p>"誰是中國的朋友?"</p> <p>他皺皺眉頭, 把頭歪向一邊, 最後, 他聳聳肩誰: "我不知道."</p> <p>- 摘自《消失的江城》- 暴風雨</p></section> <footer class="post-foot"> <ul class="post-tags"> <li><a href="/tag/article/">article</a></li> </ul> </footer> </article> <article class="post"> <header class="post-head"> <time datetime="2015-11-19T23:17:31.000Z">November 19, 2015</time> <h1><a href="/post/daily-part-1/">日常</a></h1> </header> <section class="post-main"><p>今天是 2015-11 月 19周肆. 明天是 15-11.20 周五, 明年的今天是 2016-11-19周?</p> <p>我這麼做完全就是在報復社會.....</p> <p>真的 - - 這回給很多人造成麻煩, 相信我..</p> <p>----</p> <p>說實話, 最近真的很累, 要解決很多問題, 並且也很投入, 基本上在段時間內, 對自己的代碼重構, 優化了很多次, 甚至是整個項目結構的轉變, 當然這也應該吐槽, 一個成功的項目絕對不應該會出現這種情況, 這也是起初自己沒考慮好的原因造成的.</p> <p>可是這也只是沉浸在自我陶醉中, 現實結果也確實有些問題, 某些處理確實不到位, 可是換回來的確實一句不負責任的話語 = = , 原因就是我爲什麼要報復社會. 因爲這真的很苦惱, 沒有任何一種解決方案能處理這種情況, 若是但看這篇文章的話, 能獲取到正確時間的機率非常小, 甚至不可能(並不考慮單獨此頁面).</p> <p>雖然能理解, 在 ( 他們 ) 的眼裏, 這是意見非常簡單的事情, 邏輯不同, 思維方式不同.</p> <p>總之</p> <p>玩不下去了</p> <p>這也是社會, 不會存在教科書的社會, 一個你正處在的社會.</p> <p>這也就是所謂的利益了.</p></section> <footer class="post-foot"> <ul class="post-tags"> <li><a href="/tag/daily/">daily</a></li> <li><a href="/tag/undefined/">undefined</a></li> </ul> </footer> </article> <article class="post"> <header class="post-head"> <time datetime="2015-10-18T22:29:10.000Z">October 18, 2015</time> <h1><a href="/post/user-rights-assignment-design/">用户权限分配设计</a></h1> </header> <section class="post-main"><p>匆匆忙忙这这个月也过了大半了, 真没什么可说, 基本上都是在苦力活, 颇为无趣, 而且时间还各种紧, 就在前几天, 用了一天不到的时间写好一个工程(COPY), 原因是第二天就得要, 也就是在前一天通知要做, 这怎么可能把事做好....</p> <p>既然没什么说, 就谈谈以前的事情, 刚好这段时间, 同事在做权限管理的东西, 问我 <a title="Apache Shiro | Java Security Framework" href="http://shiro.apache.org" target="_blank">Shiro</a> 会不会使, 当然我并不会.</p> <p>Shiro 就是一个角色权限管理的方案, 在之前开发 Forevermark 的陈列系统时, 我是有考虑使用这玩意来控制权限的, 可最终抛弃了这个方案, 因为这个并不能满足需求, 那么就来说说为什么没用 Shiro 和权限分配的方式.</p> <p>那么开始.</p> <p>Shiro 的权限其实和 RBAC (我不知道这个是一种设计模式还是具体实现) 所实现的方式相同, 同是根据角色来判断用户的权限, 其核心思想如下:</p> <img src="/img/user-rights-assignment-design/1.png"> <p> </p> <p>这样的设计在实现权限管理时非常方便, 只需要将最终权限赋予某一个角色便可以, 所有这个角色下的用户都有这个角色的权限, Shiro 的实现便是如此, 人的权限控制完全依赖于角色(据我所知).</p> <p>其实按照上方的模式已经基本能实现权限的管理了, 不过毕竟天下尚未大同, 各种情况还是有的.</p> <p>譬如现在你要做一套某个公司的人事管理系统, 对权限的问题很敏感, 而且公司的各个部门只能划分非常明细, 这时候如果有一个新进的同事添加账户时, 就直接根据其所在的部门和所属的角色进行权限分配, 这时候还拿角色去分配权限就会导致问题.</p> <p>举个例子的话, 有三层部门结构, dep1&gt;dep2&gt;dep3, 这三个部门的人分别角色是 role1,role2,role3 所有的汇报工作都是依次向上级部门汇报, d2 这个部门的人都能够向 d1 汇报这个人所管理的下辖信息, d3 部门的人又只能汇报他自己的信息给自己的头, 类似于下图:</p> <img src="/img/user-rights-assignment-design/2.png"> <p>整套系统这么正常的运行着, 一段时间后 dep2 部门的 usr2 这个人觉得最近太累了, 想要休个长假, 公司也视 usr2 最近表现出色, 决定同意这个假期, 之后过了一周, 公司又接手一个项目, 决定交给蓝色方阵来完成, 恰好 usr2 休假了, 通过观察发现蓝色方阵的 uy 工作很认真, 遂决定临时交由 uy 代为管理蓝色方阵来实施这个项目, 当晚便将事项告知 uy</p> <p>到了第二天, uy 到了公司之后, 准备开始接手这个项目, 可是确发现 "唉..... 我收集不到蓝色方阵的问题啊", 遂, 找到公司的技术人员, 技术说会给你弄好的, 稍等, uy 就回去等待了.</p> <p>好, 就是这么个事情, 接下来就是问题的所在了, 技术前思后想之后发现, 这没法做啊, usr2 的角色 role2 有公司财务管理的权限, 但是 uy 只是临时管理蓝色方阵和这个项目, 不能让其有公司的财务管理操作啊, 又不能给 uy 所属的 role3 添加项目管理的权限, 一加的话蓝色方阵所有人不都有权限了, 这时候技术范难了, 不知道要怎么办才好, 最后和其他同事讨论, 给出的解决方案是, 新增了个 role4 给予 role3 的所有权限, 和 role2 中的项目管理权限, 把 uy 的角色转变为 role4 , 待项目结束或者 usr2 休假结束了在把 uy 的角色还原为 role3, 同时 role4 这个角色也留着, 以应对还有可能出现这种情况, 也就是如下关系</p> <img src="/img/user-rights-assignment-design/3.png"> <p> </p> <p>专门给 uy 开了个小灶, 最后功能也完成了, usr2 安心的休假, uy 专心做这个项目, usr1 也能时时跟进这个项目,技术也能实现了这样的需求, 可谓皆大欢喜.</p> <p>又过了不久, usr3 也觉到要很累, 想休个长假, 公司也同意了(良心企业), 又发生了和 uy 一样的情况, 黄色方阵中的某个员工又找到技术, 本来了技术惯性的想到要和 uy 的实现一样, 可是和这个员工沟通发现, 原来并不是这么简单, usr3 对于工作真的很认真, 就算是休假也会关心这边的工作, 所以实际情况是这位员工只是管理实际公司中遇到的问题, 并给 usr3 , 最终还是 usr3 提给 usr1........</p> <p>技术只好又开一个角色, 给予新的权限, 而且为了保证这个员工能收到黄色方针的问题, 只能把所有黄色方阵的所有人给将一级保证这个员工的权限要大于整个黄色方阵的且能够提交给 usr3, 最后问题也解决了.</p> <p>好, 例子说完了, 最后事情也算是完满解决了, 可是这种解决是建立在人为了程式的功能而进行了现实的改变为基础的, 而不是程式为了解决现实问题的结果, 创造了一个子虚无有的角色来满足实际情况, 虽然 uy 这个人可能什么都察觉不到, 只知道技术实现了这么个功能, 对现实而言这并没有错, 本来解决问题的方案就不是一种, 就成本而言这种方案是最简单最快速的.</p> <p>如果多次出现这种情况的话, 这个系统的权限管理就会变得非常乱.</p> <p>但这里讨论的重点不是这个.</p> <blockquote> <p>注意: 上方引入部门的概念其实只是为了更容易的区分, 实际上部门并不参与权限和管理, 因为在大多数人员管理的系统中肯定会有部门这个设定, 权限依然是在角色中, 比如 dep3 这个部门的所有人的角色都是 role3 , 角色和部门在这个案例中其实并无太大关联, 而且这只是个很简单的案例, 还有更为复杂的, 比如一个人可能属于多个角色, 也有可能属于多个部门, 更有甚着 同时是多个部门多个角色而且还有角色之间的交叉管理, 当然这就是具体的业务逻辑的问题了</p> </blockquote> <p> </p> <p>那么 如何解决这种问题了, 也就是本文所要说的方式, 将最终权限分配落入到每个人而不是角色, 针对角色的权限管理随着业务的变动有可能会出现各种问题.</p> <p>权限制定到每个人的核心思想如下图</p> <img src="/img/user-rights-assignment-design/4.png"> <p>这样就不必要使用到角色的权限分配了, 如果是这样的权限管理, 在来应对上方的案例, uy 这个人临时需要项目管理和跳级汇报就直接给他加项目管理的和汇报权限, 黄色方阵的那个员工临时需要项目管理就给项目管理的权限, 但是汇报的权限不给, 只能汇报给 usr3 这个人, 这样的问题就很简单的解决了.</p> <p>是不是逻辑非常清晰, 某个人需要什么就给他什么, 不需要就不给.</p> <p>同时这里也可以引入角色的概念, 不过角色不参与具体的权限分配, 而仅仅是标记作用, 告知用户所属的角色, 而且角色也可以选择权限, 但是这个权限不是最终作为权限管理使用, 而只是作为默认值, 意思就是说在添加用户的时候选择角色, 读取这个角色的权限, 然后把这个角色的权限写入到 用户 权限 关联表 中, 而不是 角色 权限 关联表, 如下图</p> <img src="/img/user-rights-assignment-design/5.png"> <p> </p> <p>实际权限管理使用的是 用户 权限 关联表, 角色 权限 关联表 只不过是参照作用, 没添加一个用户的时候每个权限都要选择这个很烦, 而且没有角色的话对用户的归类也不是很好, 因此, 加入角色这个概念, 添加用户的时候, 把其所选的所有的角色的权限 (角色 权限 关联表) 都赋给这个用户(用户 权限 关联表), 最终的权限管理从 用户的权限中读取即可.</p> <p> </p> <p>以上便是所说的权限管理方案了, 相对来说最后所提的 用户 权限 管理方案更加灵活, 可你变, 并不是说角色管理方案不可行, 像 Shiro , RBAC 的实现都是经过实际验证可行的, 而且记得在那听说过 Linux 的权限管理就是 RBAC 的技术实现, 也依稀记得以前在讨论 ThikPHP 的 RBAC 类是提过这事情.</p> <p>如果说 Linux 的权限管理是通过类 RBAC 也就是 角色权限管理实现的话, 这是可行的, 因为 Linux 的系统中的组, 比如 sudo www-data 等, 这些组是不会发生上述案例中的这种特殊情况, Linux 中的用户组不会有出现休假情况, 因此使用角色的权限管理当然是最好的方案, 为何还要通过针对到每个人了? 像 sudo 的用户组(角色)权限, 若添加多个用户都要给其付权限是多烦额一件事, 不如把账户添加好统一赋予 sudo 这个角色即可, 反正权限在角色中都已经赋好了, 用户直接继承这些权限就是.</p> <p>所以最初提到的没用 Shiro 控制权限的原因也就是因为出现来前文提到的案例, 其实 Forevermark 的陈列系统出现的案例比上文提到的还复杂些, 究其原因还是 Forevermark 自身的人员管理问题, 所以程式就得跟着这业务逻辑做改变咯.</p> <p>这个陈列系统运行最深的感受是, 用系统的人可能比开发系统的人更熟悉系统怎么使用, 这是题外话了, 有时间来说说这件趣事.</p> <p>所以说没有最好的方案, 只有最合适的方案, 解决问题的思路不止一种, 程式要根据具体业务逻辑来实现.</p> <p> </p> <p>啊, 总算写完了, 这个月不知还能不能在写一篇- -</p> <p> </p> <p> </p></section> <footer class="post-foot"> <ul class="post-tags"> <li><a href="/tag/design/">design</a></li> <li><a href="/tag/linux/">linux</a></li> <li><a href="/tag/permission/">permission</a></li> <li><a href="/tag/rbac/">rbac</a></li> <li><a href="/tag/role/">role</a></li> <li><a href="/tag/shiro/">shiro</a></li> <li><a href="/tag/user/">user</a></li> </ul> </footer> </article> <article class="post"> <header class="post-head"> <time datetime="2015-09-27T22:48:33.000Z">September 27, 2015</time> <h1><a href="/post/jget-local-offline-download-service/">jget 本地离线下载服务</a></h1> </header> <section class="post-main"><p>几个月前入手了一台树苺派, 可是一直没能派上用场, 在那闲置, 当初买这是想做点更有科技感的事情, 可是不太现实...</p> <p>本人是个 acg 爱好者, 但苦于上不鸟 4鸡 又想在每天工作和下班路上打发打发时间, 看点动漫, 可又得提前缓存好, 若哪天忘了缓存, 那路上的时间就得无聊的望着窗外.</p> <p>遂, 就有了个想法, 做一个下载服务, 我提供一个地址, 让下载程序去慢慢下载, 等到家之后就把下载的视频 copy 到抓机, 这样就不用担心遗忘, 或者网络连接慢没下载完了, 我可以随时都添加一个任务, 让其慢慢下载去, 刚好这个树苺派也闲着, 就做了这么个 jget.</p> <p>jget 主要是两套程序, 一个 web 服务, 供添加任务, 账户信息, 另一个就是本地的下载程序.</p> <p>web 页面主要提供账户信息和账户所有的下载机信息, 这些信息是作为下载机器接入的条件, 如果并非是认证的机器接入是不允许的, 提供一个心跳服务接口, 实时刷新下载机的状态更新下载机器信息, 如果超出了所限定的时间仍然没有心跳连接, 那创建下载任务时将不出现这台机器, 可能是下载机器的网络有问题或者下载程序挂了. 每次下载机和 web 通信都应带上所需的账户验证信息, 否则将不能识别这台机器,从而不能够进行任务的处理.</p> <p>本地下载程序的主要做的事情就俩件: 服务中心心跳 和 任务获取解析, 在启动任务之前要先从 web 服务中心获取账户验证以及下载机器的验证信息, 验证通过后, 保存账户信息, 用于之后的 服务中心信息交互使用, 下载服务机的名称是作为这个账户下机器的唯一标识, 名称重复的将不会被添加当作新的机器而是当作心跳更新这个下载机的信息. 文件下载的处理俩中方式, 多线程下载和单线程下载, 首选多线程下载, 若目标服务器不支持则转为单线程, 下载模块使用的 java 实现的 <a title="Wget" href="https://github.com/axet/wget" target="_blank">wget</a> 库, 就使用而言 wget 基本上能满足下载的需求, 但是也有诸多问题, 不能设置 Cookie , 单线程下载无法获取进度(这个可能是我没发现怎么用).</p> <p>现已成功部署至树苺派并投入使用, 仍然有很多细节需要去优化, 具体代码实现在:</p> <p>http://iaceob.name:8528/gitbucket/iaceob/jget</p> <p>目前 web 界面尚未完整提供, 和尚准备来搞这界面, 搞完后会放入到 github 中.</p> <p>仍然还有很多细节处理要优化, 用着先</p></section> <footer class="post-foot"> <ul class="post-tags"> <li><a href="/tag/download/">download</a></li> <li><a href="/tag/java/">java</a></li> <li><a href="/tag/jget/">jget</a></li> <li><a href="/tag/offline/">offline</a></li> <li><a href="/tag/raspberry/">raspberry</a></li> <li><a href="/tag/wget/">wget</a></li> </ul> </footer> </article> <article class="post"> <header class="post-head"> <time datetime="2015-09-19T16:33:05.000Z">September 19, 2015</time> <h1><a href="/post/environment-variables-config/">环境变量配置</a></h1> </header> <section class="post-main"><p>关于 linux 的环境变量配置, 可以统一在 <code>/etc/profile.d/</code> 目录下建立相应的文件, 便于做统一管理</p> <p>例如 若要配置 java 环境变量 则建立 /etc/profile.d/java.sh</p> <pre>export JAVA_HOME=/opt/jdk
export CLASSPATH=${JAVA_HOME}/lib
export PATH=${JAVA_HOME}/bin:${PATH}</pre> <p>之后执行 <code>source /etc/profile.d/java.sh 使之立即生效 </code></p> <p> </p></section> <footer class="post-foot"> <ul class="post-tags"> <li><a href="/tag/env/">env</a></li> <li><a href="/tag/java/">java</a></li> <li><a href="/tag/linux/">linux</a></li> </ul> </footer> </article> <article class="post"> <header class="post-head"> <time datetime="2015-08-04T19:55:22.000Z">August 4, 2015</time> <h1><a href="/post/sql-cross-join-and-inner-join/">SQL CROSS JOIN & INNER JOIN</a></h1> </header> <section class="post-main"><p>七月过去了已经, 工作也有了着落(可是似乎并不是座理想的城市...).</p> <p>这段时间在看前人留下的代码, 发现和自己的编码习惯大相径庭(当然这是肯定的),用的都是我感觉并不是很好的技术实现的(当然也只是我认为而已),像 <a title="再来谈谈 ORM" href="/post/come-to-talk-about-orm/" target="_blank">HIBERNATE </a>SPRING .</p> <p>因此, 代码中的 SQL 简直稀烂...数据库的设计也不是很好.</p> <p>SO, 这里要说的就是 SQL 的问题了.</p> <p>在未使用 HIBERNATE 的地方, 操作数据库有像这样的一句 SQL:</p> <pre>select * from tab1, tab2
where tab1.id=tab2.id and tab2.name=?</pre> <p>第一眼看到认为是 tab1 inner join tab2 这样的关系, 但又不确定, 因为我从来不会这么写, 通常都会根据主表进行关联.</p> <p>待<a title="sql多表连接查询inner join, left join , right join ,full join ,cross join" href="http://www.cnblogs.com/china-liuyang/archive/2008/05/07/1187461.html" target="_blank">查询</a>后得知, from tab1, tab2 这种形式的 SQL 语句就相当于 进行 CROSS JOIN , 看到傻了- - 就没用过啊, 又是找资料, 看到了<a title="SQL Join的一些总结" href="http://www.cnblogs.com/rush/archive/2012/03/27/2420246.html" target="_blank">这个</a>,所以, 总结如下:</p> <p>INNER JOIN (内关联):</p> <p>关联出所关联的表中相同的数据.</p> <pre>select * from tab1
inner join tab2 on tab1.id=tab2.id
where tab2.name=?
</pre> <p>CROSS JOIN(交叉关联):</p> <p>执行所关联表的笛卡尔积, 也就是所关联表的 N*M 的组合.</p> <pre>select * from tab1, tab2 where tab2.name=?</pre> <p>对的. 这样才是一个交叉关联查询, 而</p> <pre>select * from tab1, tab2
where tab1.id=tab2.id and tab2.name=?</pre> <p>这样的语句是和 INNER JOIN 的作用是一样的, 也就是说当 CROSS JOIN 指定俩表中的某个字段相同, 就相当于 INNER JOIN .</p> <p> </p> <p>===</p> <p>CROSS JOIN 尽量不要使用, 代价非常昂贵, 另外 CROSS JOIN 俩表字段相同时相当于 INNER JOIN ,尽量使用 INNER JOIN 而不是使用 CROSS JOIN 来实现.</p></section> <footer class="post-foot"> <ul class="post-tags"> <li><a href="/tag/cross/">cross</a></li> <li><a href="/tag/database/">database</a></li> <li><a href="/tag/inner/">inner</a></li> <li><a href="/tag/join/">join</a></li> <li><a href="/tag/sql/">sql</a></li> </ul> </footer> </article> <menu class="page"> <li class="page-next"> <a href="/page/2" title="Next">Next</a> </li> </menu> </main> <footer class="foot"> <div>&copy;2017 iaceob</div> </footer> </body> </html>
<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="幾文山" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>啟動 Java 程序 Shell 腳本 - 幾文山</title>
<link rel="stylesheet" href="/css/main.css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><meta name="generator" content="Hexo 4.2.1"></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">幾文山</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/interesting" class="head-nav__link">Interesting</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2016-10-12T20:20:50.000Z" class="post__time">October 12, 2016</time><h1 class="post__title"><a href="/post/shell-boot-java-pro/">啟動 Java 程序 Shell 腳本</a></h1></header><div class="post__main echo"><p>早這之前就有寫過該腳本, 之前寫的時候也參照過別人寫的腳本, 最後的實現方式是將一些啟動時依賴打入到 jar 包中, 包括啟動類, classpath 等配置, 打包通過 maven 去實現的.<br>但是這種方式也有些許弊端, 因為 maven 中打包配置這些打包依賴真的很麻煩, 各種配置不統一, 跨項目文件移動等配置, 有興趣可以去看看 <a href="/post/nonsense-part-1/">当然, 我就是在扯淡</a> 中的 maven 案例.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">JAVA=java</span><br><span class="line">JAVA_OPTS=<span class="string">"-Xms512m -Xmx1536m -XX:PermSize=64M -XX:MaxPermSize=256m"</span></span><br><span class="line">MAIN_CLASS=com.example.project.Main</span><br><span class="line">PROCESS_NAME=ProjectName</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 脚本执行路径</span></span><br><span class="line">BIN_PATH=$(dirname $(readlink -f <span class="variable">$0</span>))</span><br><span class="line"><span class="comment"># 项目根路径</span></span><br><span class="line">HOME_PATH=$(<span class="built_in">cd</span> <span class="variable">$&#123;BIN_PATH&#125;</span><span class="string">'/../'</span>; <span class="built_in">pwd</span>)</span><br><span class="line"><span class="comment"># 资源依赖路径</span></span><br><span class="line">LIB_PATH=<span class="variable">$&#123;HOME_PATH&#125;</span><span class="string">'/lib'</span></span><br><span class="line"><span class="comment"># 配置文件路径</span></span><br><span class="line">CONF_PATH=<span class="variable">$&#123;HOME_PATH&#125;</span><span class="string">'/conf'</span></span><br><span class="line"><span class="comment"># PID 文件</span></span><br><span class="line">PID_FILE=<span class="variable">$&#123;BIN_PATH&#125;</span><span class="string">'/'</span><span class="variable">$&#123;PROCESS_NAME&#125;</span><span class="string">'.pid'</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#echo $HOME_PATH</span></span><br><span class="line"><span class="comment">#echo $BIN_PATH</span></span><br><span class="line"><span class="comment">#echo $LIB_PATH</span></span><br><span class="line"><span class="comment">#echo $CONF_PATH</span></span><br><span class="line"><span class="comment">#echo $PID_FILE</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># ################</span></span><br><span class="line"><span class="comment"># 递归遍历所有目录加入到 classpath 中</span></span><br><span class="line"><span class="comment"># #################</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">_gcpath</span></span>()&#123;</span><br><span class="line">  res=<span class="variable">$1</span></span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> `ls <span class="variable">$1</span>`</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">local</span> path=<span class="variable">$1</span><span class="string">"/"</span><span class="variable">$file</span></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="variable">$&#123;path&#125;</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span><span class="string">':'</span>$(_gcpath <span class="variable">$&#123;path&#125;</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span>:<span class="variable">$&#123;path&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$res</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ###########</span></span><br><span class="line"><span class="comment"># 接收需要加入到 classpath 的目录</span></span><br><span class="line"><span class="comment"># 依次拼接 classpath</span></span><br><span class="line"><span class="comment"># ###########</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">cppath</span></span>()&#123;</span><br><span class="line"> res=</span><br><span class="line"> count=<span class="variable">$#</span></span><br><span class="line"> index=0</span><br><span class="line"> <span class="keyword">for</span> parent <span class="keyword">in</span> $*</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">   ((index++))</span><br><span class="line">   res=<span class="variable">$&#123;res&#125;</span>$(_gcpath <span class="variable">$&#123;parent&#125;</span>)</span><br><span class="line">   <span class="comment">#((index&lt;count))&amp;&amp;(res=$&#123;res&#125;':')</span></span><br><span class="line">   <span class="keyword">if</span> ((index&lt;count))</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span><span class="string">':'</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="variable">$&#123;res&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line"> start)</span><br><span class="line">  <span class="built_in">echo</span> -n <span class="string">'Starting worker ... '</span></span><br><span class="line">  <span class="keyword">if</span> [ -f <span class="variable">$&#123;PID_FILE&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">kill</span> -0 `cat <span class="variable">$&#123;PID_FILE&#125;</span>` &gt; /dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$&#123;PROCESS_NAME&#125;</span> already running as process `cat <span class="variable">$&#123;PID_FILE&#125;</span>`.</span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">## 获取项目 classpath</span></span><br><span class="line">  <span class="comment"># 取出依赖包路径</span></span><br><span class="line">  CPPATH=$(cppath <span class="variable">$&#123;LIB_PATH&#125;</span> <span class="variable">$&#123;CONF_PATH&#125;</span>)</span><br><span class="line">  <span class="comment"># cppath $LIB_PATH $CONF_PATH</span></span><br><span class="line">  <span class="comment"># echo $CPPATH</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">  COMMAND=<span class="variable">$&#123;JAVA&#125;</span><span class="string">' '</span><span class="variable">$&#123;JAVA_OPTS&#125;</span><span class="string">' '</span>-cp<span class="string">' '</span>\"<span class="variable">$&#123;CPPATH&#125;</span>\"<span class="string">' '</span><span class="variable">$&#123;MAIN_CLASS&#125;</span></span><br><span class="line">  <span class="comment"># echo $COMMEND</span></span><br><span class="line">  nohup <span class="variable">$&#123;COMMAND&#125;</span> &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> $!</span><br><span class="line">   <span class="keyword">if</span>  <span class="built_in">echo</span> -n $! &gt; <span class="string">"<span class="variable">$PID_FILE</span>"</span></span><br><span class="line">   <span class="keyword">then</span></span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">echo</span> STARTED</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> FAILED TO WRITE PID</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">   <span class="built_in">echo</span> SERVER DID NOT START</span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"> ;;</span><br><span class="line"> stop)</span><br><span class="line">  <span class="built_in">echo</span> -n <span class="string">'Stopping worker ... '</span></span><br><span class="line">  <span class="keyword">if</span> [ ! -f <span class="string">"<span class="variable">$PID_FILE</span>"</span> ]</span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"no worker to stop (could not find file <span class="variable">$PID_FILE</span>)"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="variable">$&#123;PID_FILE&#125;</span></span><br><span class="line">   <span class="built_in">kill</span> -9 $(cat <span class="string">"<span class="variable">$PID_FILE</span>"</span>)</span><br><span class="line">   rm <span class="string">"<span class="variable">$PID_FILE</span>"</span></span><br><span class="line">   <span class="built_in">echo</span> STOPPED</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"> ;;</span><br><span class="line"> restart)</span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line">  ./<span class="string">"<span class="variable">$0</span>"</span> stop <span class="variable">$&#123;@&#125;</span></span><br><span class="line">  sleep 3</span><br><span class="line">  ./<span class="string">"<span class="variable">$0</span>"</span> start <span class="variable">$&#123;@&#125;</span></span><br><span class="line"> ;;</span><br><span class="line"> status)</span><br><span class="line">  <span class="keyword">if</span> [ ! -f <span class="string">"<span class="variable">$PID_FILE</span>"</span> ]</span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"no worker is running."</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"worker is running (pid=<span class="variable">$PID_FILE</span>)"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"> ;;</span><br><span class="line"> *)</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> &#123;start|stop|restart|status&#125;"</span> &gt;&amp;2</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>


<p>使用的時候將腳本中的 <code>JAVA</code> <code>JAVA_OPTS</code> <code>MAIN_CLASS</code> <code>PROCESS_NAME</code> 變量值修改成自己項目的信息即可.</p>
<p>此腳本要求項目格式類似如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">├── bin</span><br><span class="line">│   └── service.sh</span><br><span class="line">├── conf</span><br><span class="line">│   └── ep.properties</span><br><span class="line">└── lib</span><br><span class="line">    └── example.jar</span><br></pre></td></tr></table></figure>

<p>bin 目錄下存放的是當前腳本<br>conf 存放項目的配置文件<br>lib 存放項目的依賴包, 並且包括啟動包</p>
<p>如果有不同的目錄結構, 修改這些配置的變量值.</p>
<p>啟動</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.sh start</span><br></pre></td></tr></table></figure>

<p>停止</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.sh stop</span><br></pre></td></tr></table></figure>

<p>重啟</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.sh restart</span><br></pre></td></tr></table></figure>

<p>狀態</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.sh status</span><br></pre></td></tr></table></figure>

<p>這個腳本中大抵上和之前使用的腳本方式類似, 只是將 clsspath 的提取從 maven 中提取到 bash 來實現, clsspath 的提取是該腳本中的兩個函數來實現</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ################</span></span><br><span class="line"><span class="comment"># 递归遍历所有目录加入到 classpath 中</span></span><br><span class="line"><span class="comment"># #################</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">_gcpath</span></span>()&#123;</span><br><span class="line">  res=<span class="variable">$1</span></span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> `ls <span class="variable">$1</span>`</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">local</span> path=<span class="variable">$1</span><span class="string">"/"</span><span class="variable">$file</span></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="variable">$&#123;path&#125;</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span><span class="string">':'</span>$(_gcpath <span class="variable">$&#123;path&#125;</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span>:<span class="variable">$&#123;path&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$res</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ###########</span></span><br><span class="line"><span class="comment"># 接收需要加入到 classpath 的目录</span></span><br><span class="line"><span class="comment"># 依次拼接 classpath</span></span><br><span class="line"><span class="comment"># ###########</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">cppath</span></span>()&#123;</span><br><span class="line"> res=</span><br><span class="line"> count=<span class="variable">$#</span></span><br><span class="line"> index=0</span><br><span class="line"> <span class="keyword">for</span> parent <span class="keyword">in</span> $*</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">   ((index++))</span><br><span class="line">   res=<span class="variable">$&#123;res&#125;</span>$(_gcpath <span class="variable">$&#123;parent&#125;</span>)</span><br><span class="line">   <span class="comment">#((index&lt;count))&amp;&amp;(res=$&#123;res&#125;':')</span></span><br><span class="line">   <span class="keyword">if</span> ((index&lt;count))</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      res=<span class="variable">$&#123;res&#125;</span><span class="string">':'</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="variable">$&#123;res&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>cppath 函數的作用是接收需要加入到 classpath 的目錄<br>_gcpath 函數用來遞歸提取這些目錄下的所有文件放入到 classpath 中</p>
<p>所有路徑都是使用在系統中的絕對路徑.</p>
<p>注意:<br>pid 文件默認是存放在 <code>bin/${PROCESS_NAME}.pid</code> 中, 在以前的使用經驗中發現將 pid 文件放在 <code>/tmp</code> 目錄是一種非常不靠譜的做法, 長時間運行後不知為何 <code>/tmp</code> 中的 pid 文件不見了, 具體使用時可根據項目需求自定義位置, 修改 <code>PID_FILE</code> 變量即可.</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/java/" class="post__tag__link">java</a></li><li class="post__tag__item"><a href="/tags/shell/" class="post__tag__link">shell</a></li></ul><a href="/post/shell-boot-java-pro/#disqus_thread" class="post__foot-link u-fr"></a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2021 fewensa</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/post/remedy-chmod-777-root/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/post/oracle-not-lonely/" class="page-menu__link icon-arrow-right"></a></li></menu></footer></body></html>
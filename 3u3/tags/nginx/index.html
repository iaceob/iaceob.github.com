<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="幾文山" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>nginx - 幾文山</title>
<link rel="stylesheet" href="/css/main.css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><meta name="generator" content="Hexo 4.2.1"></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">幾文山</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="https://iaceob.3u3.me" target="_blank" rel="noopener" class="head-nav__link">生物烯丙菊</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2017-01-07T23:49:40.000Z" class="post__time">January 7, 2017</time><h1 class="post__title"><a href="/post/nginx-strange-403-forbidden-bug/">Nginx 奇怪的 403 Forbidden 問題</a></h1></header><div class="post__main echo"><p>說是要將原博客內容靜態化的嘛, 為了在解析原博的文章時能夠快速的獲取, 用 <code>wget</code> 將原博客的所有內容都下載到本地了, 但是本地之前從沒安裝過 web 服務, 因此就現安裝了個 nginx, 安裝過程都很順利, 但是在配置訪問路徑卻遇到了 <code>403 Forbidden</code> 的錯誤, 能出現這個錯誤, 無非就是在 nginx 的網站配置中未指定 <code>index</code> (或者配置的路徑沒有 index 文件), 再有就是配置的路徑權限問題.</p>
<p>然而, 我測試了很多次, <code>index</code> 是有設置的, 且配置的路徑中也就 index 文件, 那就不應該是這個問題.</p>
<p>那很有可能是路徑權限的問題, 我看了下 nginx 安裝後默認生成的 web 目錄下的權限, 和我的 web 目錄權限, 發現都是一樣的, 差別就是 nginx 的 web 目錄所屬人和組是 <code>root</code> 而我的 web 目錄是當前賬戶的.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ ls -la /usr/share/nginx/html</span><br><span class="line">drwxr-xr-x 2 root root 4096 11月 19 04:14 .</span><br><span class="line">drwxr-xr-x 3 root root 4096 11月 19 04:14 ..</span><br><span class="line">-rw-r--r-- 1 root root  537 11月 19 04:14 50x.html</span><br><span class="line">-rw-r--r-- 1 root root  612 11月 19 04:14 index.html</span><br><span class="line"></span><br><span class="line">~$ ls -la dev/wwwroot/</span><br><span class="line">drwxr-xr-x 4 iaceob iaceob 4096  1月  7 23:46 .</span><br><span class="line">drwxr-xr-x 3 iaceob iaceob 4096  1月  7 23:44 ..</span><br><span class="line">-rw-r--r-- 1 iaceob iaceob    7  1月  7 23:18 index.html</span><br><span class="line">drwxr-xr-x 6 iaceob iaceob 4096  6月 25  2016 store</span><br></pre></td></tr></table></figure>

<p>然後就測試將這個 web 目錄所屬改成 root, 但是仍然是 403.</p>
<p>去搜索 nginx 403 錯誤出來的結果, 解決方案, 大致幾種</p>
<ul>
<li>給 web 目錄 www-data(nginx) 賬戶權限<br>在安裝 nginx 後, 壓根就沒給我建立這個賬戶</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ id www-data</span><br><span class="line">id: ‘www-data’: no such user</span><br><span class="line">~$ id nginx</span><br><span class="line">id: ‘nginx’: no such user</span><br></pre></td></tr></table></figure>

<ul>
<li><p>給 web 目錄 775 權限<br>測試後發現仍然不行, 甚至設置 777 權限也不行 = =</p>
</li>
<li><p>修改 nginx 啟動賬戶</p>
</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#user html;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br></pre></td></tr></table></figure>

<p>上面這個是安裝後的默認配置, <code>user</code> 這個配置是直接被註釋的, 那也就是不可能是啟動賬戶的問題, 拿 <code>systemctl</code> 啟動的 nginx 那默認賬戶應該就是 root.</p>
<p>那看似也不是目錄權限的問題了…</p>
<p>最後, 在測試了次, 把目錄建立在非當前賬戶目錄下, 平時為了方便, 所有工程都是放在自己賬戶根目錄下的, 測試時在 /opt 下建立了一個 web 目錄, 將 nginx 配置指向到該目錄, 竟然就可以了 (╯°Д°)╯ ┻━┻<br>在 opt 建立目錄需要用 root 賬戶才行, 為了測試是不是自己賬戶的所屬目錄不能作為 web 目錄, 將該目錄屬主和屬組都改成自己賬戶, 發現仍然可以 (╯°Д°)╯ ┻━┻</p>
<p>之所以優先設置自己賬戶目錄, 一是方便, 在一個另外一台線上的服務器就是這麼配置的都沒有發生問題, 不知道是不是新版本問題還是怎樣.<br>現在我能想到的問題有可能是跨硬盤的問題, 機器上有兩塊硬盤, 一個是 ssd 掛載的是 /home 也就是平時用的, 另一塊是機械硬盤, 掛了好幾個節點(純屬瞎猜).</p>
<p>問題算是解決了 = =</p>
<p>之後就將 opt 的 web 目錄, 放了一個軟鏈接到 home 來, 後面又測試了下, 將 nginx 的配置路徑改成 home 的軟鏈接也不行, 但是其他位置的就可以 (還放了一個 <code>/data/www -&gt; /opt/www</code> 的軟鏈接), <code>/opt/www</code> 和 <code>/data/www</code> 都可以, 就是軟鏈接到 home 的又變成 403 了.</p>
<p>奇怪 = =</p>
<p>該怎麼解釋這個問題了 .</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/nginx/" class="post__tag__link">nginx</a></li><li class="post__tag__item"><a href="/tags/403/" class="post__tag__link">403</a></li></ul><a href="/post/nginx-strange-403-forbidden-bug/#disqus_thread" class="post__foot-link u-fr"></a></footer></article><article class="post"><header class="post__head"><time datetime="2016-09-04T02:09:38.000Z" class="post__time">September 4, 2016</time><h1 class="post__title"><a href="/post/nginx-proxy-part-1/">Nginx 反向代理不完全指南 - 1</a></h1></header><div class="post__main echo"><p>現行的開發項目中有很多都是前後端分離的方式進行開發, 因此在最終部署的時候, 前後端並不是部署在一次的, 然而, 如果是分開部署的話前端訪問時就會有跨域的問題.</p>
<p>此文所述的解決方式是使用 Nginx 的反向代理來實現</p>
<p>配置方式如下:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># example.com</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> example.com;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /home/www/wwwroot/project;</span><br><span class="line">        <span class="attribute">index</span> index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /api/ &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://local.example.com:8080/;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line"><span class="comment">#        proxy_set_header Host $host;</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span>  Host local.example.com:<span class="number">8080</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡配置的意思就是, 當 <code>example.com</code> 域名訪問時, 如果路徑是 <code>/api/</code> 則訪問後端接口, 否則進入前端的項目, 實現兩個項目在同域的處理.</p>
<p><code>/api/</code> 處的設置解析 </p>
<ul>
<li><code>localtion /api/</code> 後面 / 必須要, 如果沒加則會報錯(似乎是 404, 忘記了)</li>
<li><code>proxy_pass http://local.example.com:8080/</code> 這裡最後的 / 也是需要的, 沒加同樣不能正確的訪問</li>
<li><code>proxy_set_header  Host local.example.com:8080;</code> 這裡是設置轉發給目標地址的 host, 如果不設置, 將默認使用瀏覽器返回的 header 頭中的 Host 屬性值, 比如這裡就會使用 <code>example.com/api</code>, 因為大多數情況, 後臺的服務可能是個獨立的服務, 是有可能也綁定了另一個域名, 或者只是通過二級目錄訪問, 如果用的不是被綁定的域名, 則無法通過服務的解析(目前的做法是後臺部署使用 Tomcat, 綁定了另一個寫在 host 的域名(該方式在以前的博文中也提到過), 因此此處修改成在 Tomcat 中綁定的域名).</li>
<li><code>proxy_set_header X-Real-IP $remote_addr;</code> 將真實的訪問人 IP 發送給後端, 否則後端無法獲取到正確的 IP</li>
<li><code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</code> 將真實的訪問人 IP 發送給後端, 否則後端無法獲取到正確的 IP</li>
</ul>
<p>更多詳細的代理配置見:<br><a href="http://zhangge.net/5054.html" target="_blank" rel="noopener">http://zhangge.net/5054.html</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/nginx/" class="post__tag__link">nginx</a></li><li class="post__tag__item"><a href="/tags/proxy/" class="post__tag__link">proxy</a></li></ul><a href="/post/nginx-proxy-part-1/#disqus_thread" class="post__foot-link u-fr"></a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2020 iaceob</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><span title="Next" class="page-menu__link icon-arrow-right page-menu__link--disabled"></span></li></menu></footer></body></html>
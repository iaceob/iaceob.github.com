<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="幾文山" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>jfinal - 幾文山</title>
<link rel="stylesheet" href="/css/main.css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><meta name="generator" content="Hexo 4.2.1"></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">幾文山</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/interesting" class="head-nav__link">Interesting</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2017-03-18T16:10:28.000Z" class="post__time">March 18, 2017</time><h1 class="post__title"><a href="/post/jfinal-restful/">JFinal RESTful</a></h1></header><div class="post__main echo"><p>在阅读之前, 先参考</p>
<ol>
<li><a href="http://www.jfinal.com/project/1" target="_blank" rel="noopener">JFinal 极速开发框架</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html" target="_blank" rel="noopener">RESTful API 设计指南</a></li>
<li><a href="https://www.oschina.net/question/552061_249032" target="_blank" rel="noopener">JFinal实现严格的Restful</a></li>
</ol>
<p>当看完这些之后, 大概应该就能理解, RESTful 的规范, 以及 JFinal 的路由实现方式.</p>
<p>首先, 先看下 JFinal 目前的 RESTful 风格路由实现.</p>
<p>翻开 <code>com.jfinal.core.ActionMapping#getAction</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Support four types of url</span></span><br><span class="line"><span class="comment"> * 1: http://abc.com/controllerKey                 ---&gt; 00</span></span><br><span class="line"><span class="comment"> * 2: http://abc.com/controllerKey/para            ---&gt; 01</span></span><br><span class="line"><span class="comment"> * 3: http://abc.com/controllerKey/method          ---&gt; 10</span></span><br><span class="line"><span class="comment"> * 4: http://abc.com/controllerKey/method/para     ---&gt; 11</span></span><br><span class="line"><span class="comment"> * The controllerKey can also contains "/"</span></span><br><span class="line"><span class="comment"> * Example: http://abc.com/uvw/xyz/method/para</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Action <span class="title">getAction</span><span class="params">(String url, String[] urlPara)</span> </span>&#123;</span><br><span class="line">  Action action = mapping.get(url);</span><br><span class="line">  <span class="keyword">if</span> (action != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> action;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// --------</span></span><br><span class="line">  <span class="keyword">int</span> i = url.lastIndexOf(SLASH);</span><br><span class="line">  <span class="keyword">if</span> (i != -<span class="number">1</span>) &#123;</span><br><span class="line">    action = mapping.get(url.substring(<span class="number">0</span>, i));</span><br><span class="line">    urlPara[<span class="number">0</span>] = url.substring(i + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> action;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有说明, 目前 JFinal 支持的路由格式, 在此之外, JFinal 还提供了一个 <code>Restful</code> 的拦截器, 来达到严格的 RESTful url 风格实现.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invocation 中添加 Method method</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment">  The standard definition is as follows:</span></span><br><span class="line"><span class="comment">  index - GET - A view of all (or a selection of) the records</span></span><br><span class="line"><span class="comment">  show - GET - A view of a single record</span></span><br><span class="line"><span class="comment">  add - GET - A form to post to create</span></span><br><span class="line"><span class="comment">  save - POST - Create a new record</span></span><br><span class="line"><span class="comment">  edit - GET - A form to edit a single record</span></span><br><span class="line"><span class="comment">  update - PUT - Update a record</span></span><br><span class="line"><span class="comment">  delete - DELETE - Delete a record</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * GET    /user      ---&gt;  index</span></span><br><span class="line"><span class="comment"> * GET    /user/id    ---&gt;  show  </span></span><br><span class="line"><span class="comment"> * GET    /user/add    ---&gt;  add</span></span><br><span class="line"><span class="comment"> * POST    /user      ---&gt;  save</span></span><br><span class="line"><span class="comment"> * GET    /user/edit/id  ---&gt;  edit</span></span><br><span class="line"><span class="comment"> * PUT    /user/id    ---&gt;  update</span></span><br><span class="line"><span class="comment"> * DELETE  /user/id    ---&gt;  delete</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Restful</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当看完这些之后, 进入到正题.</p>
<p>首先, JFinal 基本上已经可以很好的实现 RESTful 风格的 url 了, 但是仍然有不足, 无论是默认的路由实现, 或者是 Restful 拦截器的实现, 仍然无法做到全可控的 RESTful 实现.<br>Restful 拦截器的实现实际上是匹配链接以及 Request method, 然后进行 forward 到相应的 action 中.</p>
<p>例如, 参考链接 <a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html" target="_blank" rel="noopener">RESTful API 设计指南</a> 文章中的</p>
<blockquote>
<p>DELETE /zoos/ID/animals/ID：删除某个指定动物园的指定动物</p>
</blockquote>
<p>就没办法通过 Restful 拦截器来实现了.</p>
<p>那么, 所有问题都抛出来了.</p>
<p>因此, 这里要说的就是, 把 JFinal 的路由机制给改了下, 达到完美兼容 RESTful 链接, 并且保留 JFinal 的默认实现.</p>
<p>具体实现代码已提交至 <a href="https://github.com/iaceob/jfinal/tree/restful" target="_blank" rel="noopener">iaceob/jfinal</a></p>
<p>先不讨论怎么实现, 其实原理也很简单, 看看代码很容易理解. 这里主要说说使用方式, 以及一些问题.</p>
<p>使用的时候非常简单, 首先在你的 AppConfig.configConstant 中, 设置开启 RESTful 模式.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configConstant</span><span class="params">(Constants constants)</span> </span>&#123;</span><br><span class="line">    constants.setRestful(<span class="keyword">true</span>);</span><br><span class="line">    constants.setXxx();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当设置了 <code>constants.setRestful(true);</code> 之后, 路由解析就是 RESTful 风格实现的, 默认是 false, 也就是目前 JFinal 自身的路由实现.</p>
<p>接下来就是定义你的 RESTful 链接格式就好, 下面是一个测试案例.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jfinal.test.restful.test.ctl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jfinal.core.ActionKey;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.core.Controller;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.plugin.activerecord.Record;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.restful.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by iaceob on 2017/3/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooCtl</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Record&gt; <span class="title">getAttrs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Record&gt; rets = <span class="keyword">new</span> ArrayList&lt;Record&gt;();</span><br><span class="line">        Enumeration&lt;String&gt; ens = <span class="keyword">super</span>.getAttrNames();</span><br><span class="line">        <span class="keyword">while</span> (ens.hasMoreElements()) &#123;</span><br><span class="line">            String key = ens.nextElement();</span><br><span class="line">            rets.add(<span class="keyword">new</span> Record().set(key, <span class="keyword">super</span>.getAttr(key)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rets;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Record <span class="title">buildRet</span><span class="params">(String intro)</span> </span>&#123;</span><br><span class="line">        Record ret = <span class="keyword">new</span> Record();</span><br><span class="line">        ret.set(<span class="string">"intro"</span>, intro)</span><br><span class="line">                .set(<span class="string">"attrs"</span>, <span class="keyword">this</span>.getAttrs())</span><br><span class="line">                .set(<span class="string">"paras"</span>, <span class="keyword">super</span>.getParaMap());</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(<span class="string">"/zoo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"zoo list"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(value = <span class="string">"/zoo"</span>, method = Method.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addZoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"add zoo"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(<span class="string">"/zoo/:id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getZoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"get zoo by id"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(value = <span class="string">"/zoo/:id"</span>, method = Method.PUT)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putZoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"put zoo by id"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(value = <span class="string">"/zoo/:id"</span>, method = Method.PATCH)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">patchZoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"patch zoo by id"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(value = <span class="string">"/zoo/:id"</span>, method = Method.DELETE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteZoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"delete zoo by id"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(<span class="string">"/zoo/:id/animals"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">animals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"show zoo animals"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(<span class="string">"/zoo/:zooId/animal/:animalId"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getAnimal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"show zoo animal by id"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(<span class="string">"/zoo/:zid/animal2/:aid"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getAnimal2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"show zoo animal by id, 2"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用时也是使用 <code>@ActionKey</code> 注解, url 中的值通过 <code>:name</code> 来标识, ActionKey 注解中的另外一个参数就是绑定相应的请求 method.</p>
<p>获取参数也未作改变, 表单传递的参数仍然通过 <code>getPara()</code> 来获取, 使用方式详细见 JFinal 文档.</p>
<p>但是需要注意的是:</p>
<ol>
<li><p>开启 RESTful 模式后, <code>getPara()</code> 方法按索引取值的方法将失去效果<br>例如, <code>/zoo/:id/1-3</code> 若这样的请求则会直接返回 404 错误, 因为 RESTful 模式采用的匹配规则较严格(可查看代码实现, 或对该处进行修改令其支持), 另外若是采用 RESTful 风格链接, 应该也不会使用此方式传参.</p>
</li>
<li><p>存放在 url 中的参数标识无法通过 <code>getPara()</code> 取值.<br>若要获取 url 中指定的参数值, 需要通过 <code>getAttr()</code> 获取, 例如 <code>/zoo/:id</code> 获取这个 id 时, 使用 <code>getAttr(&quot;id&quot;)</code>.</p>
</li>
<li><p>RESTful 模式与非 RESTful 的 ActionKey 是不可共用的.<br>这个描述可能比较模糊, 但是要表达的意思是, 如果 ActionKey 中的 url 是采用 RESTful 风格写的, 但是却没有开启 RESTful 模式, 就会发生问题, 非 RESTful 模式是不去分析 url 中参数的.</p>
</li>
<li><p>无需再使用 POST GET 拦截器<br>JFinal 提供了 GET POST 拦截器, 用以指定某个路由只能某中请求, 但是开启 RESTful 模式后, 在路由匹配是就已经限定了指定的 method 访问, 因此无需再使用 <code>@Before(POST.class)</code> 这样的代码.</p>
</li>
</ol>
<p>使用方式大抵如此, 剩下还有一些可能会令人不爽的小问题.</p>
<ol>
<li><p>使用 <code>getAttr()</code> 获取 url 中参数时, 获取到的值都是 String 类型.<br>因 <code>HttpServletRequest</code> 自身的设计, 在解析完 url 后无法将值写入到 <code>parameter</code> 中, 因此无法使用 JFinal 提供的 <code>getPara()</code> 取值. 后续也考虑过做一个类型自动识别, 但是最终抛弃了, 在不同的系统中, 参数的类型都不同, 自动识别是不靠谱的, 因此建议使用中, 在获取这个参数时都写一个 <code>validator</code> 对这个值进行验证, <code>controller</code> 中就可以对该值进行强转类型.</p>
</li>
<li><p>性能问题<br>也不要想得太过与悲观, 这里说的性能只是相对于 JFinal 自身的路由实现. JFinal 的路由实现非常简单, 甚至可以就简单的看成是字符串匹配, 但是这里的 RESTful 模式, 匹配时使用了正则, 因此效能肯定会比 JFinal 自身实现要来的低一些. 后续会做相关方面性能测试.</p>
</li>
<li><p>非插拔式<br>意思是, 并非提供扩展, 而是通过修改内核实现, 其原因其实看看 JFinal 提供 <code>Restful</code> 拦截器就知道了 = =, 以及 JFinal 的极简的设计缘故. 首先, JFinal 的路由实现, 路由最初加载进来时, 就通过 ActionMapping 隐射到具体的 Action 中, 随后只要有请求就通过 ActionHandler 找到具体的 Action, 因此想要在此基础上实现 RESTful 几乎是不可能, Restful 拦截器的实现也只能通过 forward 来实现, 且无法在 url 中指定参数. 也就是说, 无论你是加自己的过滤器, 甚至创建一个新的注解, 在请求进来时最先经过的 ActionHandler 就以及拒绝了请求, 无法进入到新定义的路由处理中. 因此要实现就只能从 ActionMapping 中入手, 修改路由实现方式.</p>
</li>
</ol>
<p>基本就这样.</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/jfinal/" class="post__tag__link">jfinal</a></li><li class="post__tag__item"><a href="/tags/restful/" class="post__tag__link">restful</a></li></ul><a href="/post/jfinal-restful/#disqus_thread" class="post__foot-link u-fr"></a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2021 fewensa</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><span title="Next" class="page-menu__link icon-arrow-right page-menu__link--disabled"></span></li></menu></footer></body></html>
<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="幾文山" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>幾文山</title>
<link rel="stylesheet" href="/css/main.css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/assets/css/APlayer.min.css" class="aplayer-style-marker">
<script src="/assets/js/APlayer.min.js" class="aplayer-script-marker"></script>
</head><body><header class="head"><h1 class="head-title u-fl"><a href="/">幾文山</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/interesting" class="head-nav__link">Interesting</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2020-11-14T22:48:40.000Z" class="post__time">November 14, 2020</time><h1 class="post__title"><a href="/post/dispersed/">走散了</a></h1></header><div class="post__main echo"><p>還是走散了.</p>

        <div id="aplayer-PsJUynlc" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>
			  <script>
				  var options = {"narrow":false,"autoplay":true,"showlrc":3,"mode":"order","mutex":true,"theme":"#e6d0b2","preload":"auto","listmaxheight":"513px","music":[{"title":"Always","author":"瀧川ありさ","url":"https://mio.0u0.me/music/Always%20-%20%E7%80%A7%E5%B7%9D%E3%81%82%E3%82%8A%E3%81%95.m4a","pic":"https://p1.music.126.net/hm82nYiAhA-ZglW5T8_8rA==/109951163886169752.jpg?param=500y500","lrc":"https://mio.0u0.me/music/Always%20-%20%E7%80%A7%E5%B7%9D%E3%81%82%E3%82%8A%E3%81%95.lrc.txt"},{"title":"Always (Instrumental)","author":"瀧川ありさ","url":"https://mio.0u0.me/music/Always%20(Instrumental)%20-%20%E7%80%A7%E5%B7%9D%E3%81%82%E3%82%8A%E3%81%95.mp3","pic":"https://p1.music.126.net/hm82nYiAhA-ZglW5T8_8rA==/109951163886169752.jpg?param=500y500"}]};
				  options.element = document.getElementById("aplayer-PsJUynlc");
				  var ap = new APlayer(options);
			    window.aplayers || (window.aplayers = []);
				  window.aplayers.push(ap);
			  </script>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/dispersed/" class="post__tag__link">dispersed</a></li></ul><a href="/post/dispersed/#disqus_thread" class="post__foot-link u-fr"></a></footer></article><article class="post"><header class="post__head"><time datetime="2020-01-04T21:05:26.000Z" class="post__time">January 4, 2020</time><h1 class="post__title"><a href="/post/websocket-protocol/">WebSocket 协议</a></h1></header><div class="post__main echo"><p>WebSocket 是 HTMl5 所引入的协议, 使得浏览器具备了实时双向通信的能力. 这里将详细介绍 WebSocket 协议实现. 在网路中已有不少文章介绍此协议, 但是并没有很详细的展开说明, 本文将完整的描述此协议, 并且给出案例数据做详细说明.</p>
<p>WebSocket 协议总共分为两个部分, 第一部分透过 HTTP 协议, 进行协议升级到 WebSocket, 这一部分本文将不会做叙述 (详细见后续 HTTP 协议相关文章), 第二部分则是 WebSocket 帧数据传输协议, 也就是 WebSocket 协议重要的部分.</p>
<h2 id="数据帧"><a href="#数据帧" class="headerlink" title="数据帧"></a>数据帧</h2><p>在开始进行详细说明之前, 来看一下经过处理的 (需开启 Javascript) <a href="https://tools.ietf.org/html/rfc6455#section-5.2" target="_blank" rel="noopener">rfc</a> 给出的图示.</p>
<template>
原始档案:

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16&#x2F;64)           |</span><br><span class="line">|N|V|V|V|       |S|             |   (if payload len&#x3D;&#x3D;126&#x2F;127)   |</span><br><span class="line">| |1|2|3|       |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len &#x3D;&#x3D; 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |          Payload Data         |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
</template>

<!--

 <span class="ws-byte ws-byte0">0 1 2 3 4 5 6 7</span> <span class="ws-byte ws-byte1">8 9 0 1 2 3 4 5</span> <span class="ws-byte ws-byte2">6 7 8 9 0 1 2 3</span> <span class="ws-byte ws-byte3">4 5 6 7 8 9 0 1</span>

 #00 1 2 3 4 5 6 7#! #2#18#! #39 0 1 2 3 4 5#!! #46 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1#!
-->


<template>
<pre id="pre_ws_protocol">
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
#0+-+-+-+-+-------#!#2#0#1+#!!#1-#!#3#1+#!-------------#!!#4#3+#!-------------------------------+#!
#0|F|R|R|R| opcode#!#2#0#1|#!!#1M#!#3#1|#! Payload len #!!#4#3|#!    Extended payload length    |#!
#0|I|S|S|S|  (4)  #!#2#0#1|#!!#1A#!#3#1|#!     (7)     #!!#4#3|#!             (16/64)           |#!
#0|N|V|V|V|       #!#2#0#1|#!!#1S#!#3#1|#!             #!!#4#3|#!   (if payload len==126/127)   |#!
#0| |1|2|3|       #!#2#0#1|#!!#1K#!#3#1|#!             #!!#4#3|#!                               |#!
#4#0+-+-+-+-+-------#!#2#0#1+#!!#1-#!#3#1+#!-------------#!!#3+#! - - - - - - - - - - - - - - - +#!
#4|     Extended payload length continued, if payload len == 127  |#!
#4+ - - - - - - - - - - - - - - - #!#5#4+#!#4-------------------------------+#!!
#4|                               #!#5#4|#!Masking-key, if MASK set to 1  |#!
#5#4+-------------------------------#6+#!!#6-------------------------------+#!!
#5| Masking-key (continued)       #!#5#6|#!!#6          Payload Data         |#!
#5+--------------------------------#!#6 - - - - - - - - - - - - - - - +#!
#6:                     Payload Data continued ...                :#!
#6+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +#!
#6|                     Payload Data continued ...                |#!
#6+---------------------------------------------------------------+#!
</pre>
<pre>
  #4 extended payload length
  #5 masking key
  #6 payload data
</pre>
<script>
  !(function(window){
    'use strict';

<pre><code>var pre = document.getElementById(&apos;pre_ws_protocol&apos;);

// fill tag
function fill_tag() {
  var art_pic = pre.innerText;
  art_pic = art_pic.replace(/#!!/gi, &apos;&lt;/span&gt;&lt;/span&gt;&apos;);
  art_pic = art_pic.replace(/#!/gi, &apos;&lt;/span&gt;&apos;);
  art_pic = art_pic.replace(/#0/gi, &apos;&lt;span class=&quot;ws-block-0&quot;&gt;&apos;);
  art_pic = art_pic.replace(/#1/gi, &apos;&lt;span class=&quot;ws-block-1&quot;&gt;&apos;);
  art_pic = art_pic.replace(/#2/gi, &apos;&lt;span class=&quot;ws-block-2&quot;&gt;&apos;);
  art_pic = art_pic.replace(/#3/gi, &apos;&lt;span class=&quot;ws-block-3&quot;&gt;&apos;);
  art_pic = art_pic.replace(/#4/gi, &apos;&lt;span class=&quot;ws-block-4&quot;&gt;&apos;);
  art_pic = art_pic.replace(/#5/gi, &apos;&lt;span class=&quot;ws-block-5&quot;&gt;&apos;);
  art_pic = art_pic.replace(/#6/gi, &apos;&lt;span class=&quot;ws-block-6&quot;&gt;&apos;);
  console.log(art_pic);
  pre.innerHTML = art_pic;
}

fill_tag();</code></pre><p>  })(window);<br></script><br></template></p>
<!-- <template> -->
<pre id="pre_ws_protocol"> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
<span class="ws-block-0">+-+-+-+-+-------</span><span class="ws-block-2"><span class="ws-block-0"><span class="ws-block-1">+</span></span><span class="ws-block-1">-</span><span class="ws-block-3"><span class="ws-block-1">+</span>-------------</span></span><span class="ws-block-4"><span class="ws-block-3">+</span>-------------------------------+</span>
<span class="ws-block-0">|F|R|R|R| opcode</span><span class="ws-block-2"><span class="ws-block-0"><span class="ws-block-1">|</span></span><span class="ws-block-1">M</span><span class="ws-block-3"><span class="ws-block-1">|</span> Payload len </span></span><span class="ws-block-4"><span class="ws-block-3">|</span>    Extended payload length    |</span>
<span class="ws-block-0">|I|S|S|S|  (4)  </span><span class="ws-block-2"><span class="ws-block-0"><span class="ws-block-1">|</span></span><span class="ws-block-1">A</span><span class="ws-block-3"><span class="ws-block-1">|</span>     (7)     </span></span><span class="ws-block-4"><span class="ws-block-3">|</span>             (16/64)           |</span>
<span class="ws-block-0">|N|V|V|V|       </span><span class="ws-block-2"><span class="ws-block-0"><span class="ws-block-1">|</span></span><span class="ws-block-1">S</span><span class="ws-block-3"><span class="ws-block-1">|</span>             </span></span><span class="ws-block-4"><span class="ws-block-3">|</span>   (if payload len==126/127)   |</span>
<span class="ws-block-0">| |1|2|3|       </span><span class="ws-block-2"><span class="ws-block-0"><span class="ws-block-1">|</span></span><span class="ws-block-1">K</span><span class="ws-block-3"><span class="ws-block-1">|</span>             </span></span><span class="ws-block-4"><span class="ws-block-3">|</span>                               |</span>
<span class="ws-block-4"><span class="ws-block-0">+-+-+-+-+-------</span><span class="ws-block-2"><span class="ws-block-0"><span class="ws-block-1">+</span></span><span class="ws-block-1">-</span><span class="ws-block-3"><span class="ws-block-1">+</span>-------------</span></span><span class="ws-block-3">+</span> - - - - - - - - - - - - - - - +</span>
<span class="ws-block-4">|     Extended payload length continued, if payload len == 127  |</span>
<span class="ws-block-4">+ - - - - - - - - - - - - - - - </span><span class="ws-block-5"><span class="ws-block-4">+</span><span class="ws-block-4">-------------------------------+</span></span>
<span class="ws-block-4">|                               </span><span class="ws-block-5"><span class="ws-block-4">|</span>Masking-key, if MASK set to 1  |</span>
<span class="ws-block-5"><span class="ws-block-4">+-------------------------------<span class="ws-block-6">+</span></span><span class="ws-block-6">-------------------------------+</span></span>
<span class="ws-block-5">| Masking-key (continued)       </span><span class="ws-block-5"><span class="ws-block-6">|</span></span><span class="ws-block-6">          Payload Data         |</span>
<span class="ws-block-5">+--------------------------------</span><span class="ws-block-6"> - - - - - - - - - - - - - - - +</span>
<span class="ws-block-6">:                     Payload Data continued ...                :</span>
<span class="ws-block-6">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span>
<span class="ws-block-6">|                     Payload Data continued ...                |</span>
<span class="ws-block-6">+---------------------------------------------------------------+</span>
</pre>
<!-- </template> -->

<style>
  /*.ws-block-0:hover, .ws-block-1:hover, 
  .ws-block-2:hover, .ws-block-3:hover, 
  .ws-block-4:hover, .ws-block-5:hover, 
  .ws-block-6:hover {
    color: red;
  }*/
</style>
<script>
!(function(window, $){
  'use strict';


  function listen(i) {
    for (var i=0; i<7; i++) {
      (function() {
        var blocks = document.getElementsByClassName('ws-block-' + i);
        bindE(blocks, 'mouseover', function() {
          $.setStyle(blocks, 'color: red')
        });
        bindE(blocks, 'mouseleave', function() {
          $.setStyle(blocks, '')
        });
      })(i)
    }
  }

  function bindE(doms, type, fn) {
    for (var i=0; i<doms.length; i++) {
      var dom = doms[i];
      $.addListener(dom, type, fn, true);
    }
  }

  listen();

})(window, (function(window) {
  return {
    addListener: function(element, type, fun, useCapture) {
      if(document.addEventListener){
        /* ie9以上正常使用addEventListener */
        element.addEventListener(type, fun, useCapture ? useCapture : false);
      }else{
        /* ie7、ie8使用attachEvent */
        if(!fun.prototype._bindFun){
            fun.prototype._bindFun = [];
        }
        // 判断当前的element是否已经绑定过该事件
        var s = true;
        for(var i in fun.prototype._bindFun){
            if(fun.prototype._bindFun[i].type === type && fun.prototype._bindFun[i].element === element){
                s = false;
                break;
            }
        }
        // 没有绑定事件
        if(s === true){
            var f = {
                type: type,
                element: element,
                Function: function(event){
                    fun.call(element, event);
                }
            };
            fun.prototype._bindFun.push(f);
            element.attachEvent('on' + type, f.Function);
        }
      }
    },
    removeListener: function(element, type, fun) {
      if(document.addEventListener){
        /* ie9以上正常使用removeEventListener */
        element.removeEventListener(type, fun);
      }else{
        /* ie7、ie8使用detachEvent */
        for(var i in fun.prototype._bindFun){
          if(fun.prototype._bindFun[i].type === type && fun.prototype._bindFun[i].element === element){
            element.detachEvent('on' + type, fun.prototype._bindFun[i].Function);
            fun.prototype._bindFun.splice(i, 1);
            break;
          }
        }
      }
    },
    setStyle: function(elements, style) {
      for (var i=0; i<elements.length; i++) {
        var element = elements[i];
        element.style = style;
      }
    }
  }
})(window));
</script>



<p>接下来, 回顾一条基础知识:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1 byte  &#x3D; 8 bit</span><br><span class="line">0x0     &#x3D; 0000 0000</span><br><span class="line">0xff    &#x3D; 1111 1111</span><br></pre></td></tr></table></figure>

<p>那么, 继续回到这张图;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br></pre></td></tr></table></figure>

<p>在图的上方所列出来的数字就是一位 (1 bit), 透过处理后的图中可以看出, 一个帧是由四或五个部分的数据所拼凑而成的:</p>
<ol>
<li>包含 <a href="#FIN">FIN</a> <a href="#RSV">RSV1</a> <a href="#RSV">RSV2</a> <a href="#RSV">RSV3</a> 以及 <a href="#OPCODE">OPCODE</a></li>
<li><a href="#MASK">MASK</a> 以及 <a href="#PAYLOAD-LEN">PAYLOAD LEN</a></li>
<li><a href="#PAYLOAD-LEN">PAYLOAD LEN</a></li>
<li><a href="#MASKING-KEY">MASKING KEY</a>, Masking key 只有在 <a href="#MASK">MASK</a> 为 1 时才会存在的 4 <ruby><rb>字节</rb><rp>(</rp><rt>bytes</rt><rp>)</rp></ruby>数据</li>
<li><a href="#PAYLOAD">PAYLOAD</a></li>
</ol>
<h3 id="FIN"><a href="#FIN" class="headerlink" title="FIN"></a>FIN</h3><pre>
 <span style="color: red">0</span> 1 2 3 4 5 6 7 
<span style="color: red">+-+</span>-+-+-+-------+
<span style="color: red">|F|</span>R|R|R| opcode|
<span style="color: red">|I|</span>S|S|S|  (4)  |
<span style="color: red">|N|</span>V|V|V|       |
<span style="color: red">| |</span>1|2|3|       |
<span style="color: red">+-+</span>-+-+-+-------+
 <span style="color: green">1</span> # 结束帧
 <span style="color: green">0</span> # 连续帧
</pre>

<p>表示该帧是不是消息的最后一帧, 1 表示结束, 0 表示连续帧, 还有下一帧.</p>
<h3 id="RSV"><a href="#RSV" class="headerlink" title="RSV"></a>RSV</h3><pre>
 0 <span style="color: red">1 2 3</span> 4 5 6 7 
+-<span style="color: red">+-+-+-+</span>-------+
|F<span style="color: red">|R|R|R|</span> opcode|
|I<span style="color: red">|S|S|S|</span>  (4)  |
|N<span style="color: red">|V|V|V|</span>       |
| <span style="color: red">|1|2|3|</span>       |
+-<span style="color: red">+-+-+-+</span>-------+
   <span style="color: green">0 0 0</span> # 默认情况
</pre>


<p>WebSocket 预留扩展字段, 共有 3 位 (bit) (RSV1, RSV2, RSV3), 无任何扩展应该都为 0, 若没有定义协议扩展而收到了不为 0 的数据, 那么应该断开 WebSocket 连接.</p>
<h3 id="OPCODE"><a href="#OPCODE" class="headerlink" title="OPCODE"></a>OPCODE</h3><pre>
 0 1 2 3 <span style="color: red">4 5 6 7</span> 
+-+-+-+-<span style="color: red">+-------+</span>
|F|R|R|R<span style="color: red">| opcode|</span>
|I|S|S|S<span style="color: red">|  (4)  |</span>
|N|V|V|V<span style="color: red">|       |</span>
| |1|2|3<span style="color: red">|       |</span>
+-+-+-+-<span style="color: red">+-------+</span>
         <span style="color: green">0 0 0 0</span> # 连续帧
         <span style="color: green">0 0 0 1</span> # 数据帧 文字类型
         <span style="color: green">0 0 1 0</span> # 数据帧 二进制类型
         <span style="color: green">0 0 1 1</span> | ----------------
         <span style="color: green">. . . .</span> | 0x3-0x7 保留数据帧
         <span style="color: green">0 1 1 1</span> | ----------------
         <span style="color: green">1 0 0 0</span> # 控制帧 <a href="#关闭连接">关闭连接</a>
         <span style="color: green">1 0 0 1</span> # 控制帧 <a href="#心跳">ping</a>
         <span style="color: green">1 0 1 0</span> # 控制帧 <a href="#心跳">pong</a>
         <span style="color: green">1 0 1 1</span> | ----------------
         <span style="color: green">. . . .</span> | 0xb-0xf 保留控制帧
         <span style="color: green">1 1 1 1</span> | ----------------
</pre>


<p>描述 <code>Payload data</code> 数据定义类型, 4 bit, 一个错误但是很容易理解的方向是, 很类似于 HTTP 协议中的 <code>Content-Type</code> Header 头 (错误的地方在于 <code>OPCODE</code> 标识的不仅仅只有类型, 还可以作为控制帧的标识). 协议定义了以下值:</p>
<ul>
<li>0x0<br>表示连续的帧, 连续帧于 <a href="#FIN">FIN</a> 是有关联的;<br>FIN 表示是否结束帧, 1 是结束, 那么如果 FIN 是 0 对应的 OPCODE 也是 0x0, 当 FIN 是 1 表明帧结束, OPCODE 应该对应着结束的值 (0x1, 0x2, 0x3-7)</li>
</ul>
<div id="flowchart-0" class="flow-chart"></div>

<ul>
<li>0x1<br>表示 text 帧</li>
<li>0x2<br>表示二进制帧</li>
<li>0x3-7<br>预留给<ruby><rb>非控制帧</rb><rp>(</rp><rt>数据帧, 非指令类型数据, 用来描述 Payload 数据类型</rt><rp>)</rp></ruby></li>
<li>0x8<br>表示关闭连接帧</li>
<li>0x9<br>表示 ping</li>
<li>0xA<br>表示 pong</li>
<li>0xB-F<br>预留给<ruby><rb>控制帧</rb><rp>(</rp><rt>指令类型数据, 用来操控 Websocket 状态</rt><rp>)</rp></ruby></li>
</ul>
<h3 id="MASK"><a href="#MASK" class="headerlink" title="MASK"></a>MASK</h3><p>表示 Playload data 是否要加掩码, 从客户端发到服务端的帧都要加掩码, 因此客户端构造协议数据此位永远为 1 并且需要赋值 <a href="#MASKING-KEY">Masking key</a>. 而服务端返回的数据不需要掩码, 因此此位永远为 0.</p>
<pre>
 <span style="color: red">8</span> 9 0 1 2 3 4 5 
<span style="color: red">+-+</span>-------------+
<span style="color: red">|M|</span> Payload len |
<span style="color: red">|A|</span>     (7)     |
<span style="color: red">|S|</span>             |
<span style="color: red">|K|</span>             |
<span style="color: red">+-+</span>-------------+
 <span style="color: green">1</span> # 包含 masking key
 <span style="color: green">0</span> # 不包含 masking key
</pre>

<h3 id="PAYLOAD-LEN"><a href="#PAYLOAD-LEN" class="headerlink" title="PAYLOAD LEN"></a>PAYLOAD LEN</h3><p>数据长度, 在 WebSocket 协议中, 长度是相对比较复杂的部分. 此处的长度是 Payload data 数据长度, 在 WebSocket 协议中, 长度共分三种情况. 小于 126 (<code>7 bits</code>) 以及 126 (<code>7 + 16 bits</code>) 和 127 (<code>7 + 64 bits</code>). </p>
<p>首先, 最重要的就是当前 byte 中所遗留下来的 7 位 (bit), 最高可表示 <ruby><rb>127</rb><rp>(</rp><rt>111 1111</rt><rp>)</rp></ruby>, 为了剩下的两种情况, 要保留 2 位, 因此第一种情况最高可表示的长度为 <ruby><rb>125</rb><rp>(</rp><rt>111 1101</rt><rp>)</rp></ruby>, 如果长度超过 125 采用第二种情况. 当数据超过 <code><ruby><rb>0xffff</rb><rp>(</rp><rt>2 bytes, 16 bits</rt><rp>)</rp></ruby></code> 采用第三种情况.</p>
<pre>
 8 <span style="color: red">9 0 1 2 3 4 5</span> 
+-<span style="color: red">+-------------+</span>
|M<span style="color: red">| Payload len |</span>
|A<span style="color: red">|     (7)     |</span>
|S<span style="color: red">|             |</span>
|K<span style="color: red">|             |</span>
+-<span style="color: red">+-------------+</span>
   <span style="color: green">0 0 0 0 0 0 0</span> # 数据长度 <ruby><rb>0x0</rb><rp>(</rp><rt>0</rt><rp>)</rp></ruby>
   <span style="color: green">. . . . . . .</span> #
   <span style="color: green">1 1 1 1 1 0 1</span> # 数据长度 <ruby><rb>0x7d</rb><rp>(</rp><rt>125</rt><rp>)</rp></ruby>
</pre>


<p>第二种情况, 前 7 位表示为 <code>126</code>, 实际长度采用后面的 <ruby><rb>2 bytes</rb><rp>(</rp><rt>16 bits</rt><rp>)</rp></ruby>. 最高可表示 <code>0xffff</code>, 如果超过这个长度将采用第三种情况.</p>
<pre>
 0 1 2 3 4 5 6 7 8 <span style="color: red">9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
+-+-+-+-+-------+-<span style="color: red">+-------------+-------------------------------+</span>
|F|R|R|R| opcode|M<span style="color: red">| Payload len |    Extended payload length    |</span>
|I|S|S|S|  (4)  |A<span style="color: red">|     (7)     |             (16/64)           |</span>
|N|V|V|V|       |S<span style="color: red">|             |   (if payload len==126/127)   |</span>
| |1|2|3|       |K<span style="color: red">|             |                               |</span>
+-+-+-+-+-------+-<span style="color: red">+-------------+ - - - - - - - - - - - - - - - +</span>
                   <span style="color: orange">1 1 1 1 1 1 0</span> <span style="color: green">0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 0</span>
                 # |           | |                             |
                 #  -----------   -----------------------------
                 #   0x7e 126             0x7e 126
                 #
                   <span style="color: orange">1 1 1 1 1 1 0</span> <span style="color: green">1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span>
                 # |           | |                             |
                 #  -----------   -----------------------------
                 #   0x7e 126            0xffff 65535
</pre>

<p>第三种情况, 长度超过 <code>0xffff</code>, 前 7 位表示为 <code>127</code>, 实际长度采用后面的 <ruby><rb>8 bytes</rb><rp>(</rp><rt>64 bits</rt><rp>)</rp></ruby>. 最高可表示 <code>0xffffffffffffffff</code></p>
<pre>
 0 1 2 3 4 5 6 7 8 <span style="color: red">9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
+-+-+-+-+-------+-<span style="color: red">+-------------+-------------------------------+</span>
|F|R|R|R| opcode|M<span style="color: red">| Payload len |    Extended payload length    |</span>
|I|S|S|S|  (4)  |A<span style="color: red">|     (7)     |             (16/64)           |</span>
|N|V|V|V|       |S<span style="color: red">|             |   (if payload len==126/127)   |</span>
| |1|2|3|       |K<span style="color: red">|             |                               |</span>
+-+-+-+-+-------+-<span style="color: red">+-------------+ - - - - - - - - - - - - - - - +</span>
                   <span style="color: orange">1 1 1 1 1 1 1</span> <span style="color: green">0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span>
                 # |           | |
                 #  -----------   -----------------------------
                 #   0x7f 127
                 #
                   <span style="color: orange">1 1 1 1 1 1 1</span> <span style="color: green">1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span>
                 # |           | |
                 #  -----------   -----------------------------
                 #   0x7f 127

 <span style="color: red">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
<span style="color: red">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span>
<span style="color: red">|     Extended payload length continued, if payload len == 127  |</span>
<span style="color: red">+ - - - - - - - - - - - - - - - +-------------------------------+</span>
 <span style="color: green">0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1</span>
#---------------------------------------------------------------
                     0x10000  65536

 <span style="color: green">1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span>
#---------------------------------------------------------------
                    0xffffffffffffffff

 <span style="color: red">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5</span> 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
<span style="color: red">+ - - - - - - - - - - - - - - - +</span>-------------------------------+
<span style="color: red">|                               |</span>Masking-key, if MASK set to 1  |
<span style="color: red">+-------------------------------+</span>-------------------------------+
 <span style="color: green">0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span>
#                               |
#-------------------------------

 <span style="color: green">1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span>
#                               |
#-------------------------------
</pre>


<p>至此, Payload length 计算就结束了, 如果你的数据是超过第三种情况的, 那么应该直接抛出异常. 从各种角度出发都不应该发出这么长的内容, 应该视具体情况, 采用连续帧来分段发布一个较长的内容.</p>
<h3 id="MASKING-KEY"><a href="#MASKING-KEY" class="headerlink" title="MASKING KEY"></a>MASKING KEY</h3><p>如果 <a href="#MASK">MASK</a> 是 1, 需要设置 Masking key, Masking key 长度是 4 个字节, 生成 4 个字节的随机值, 接着用这 4 个字节的随机值对 Payload data 进行<ruby><rb>异或运算</rb><rp>(</rp><rt>^=</rt><rp>)</rp></ruby>. 反之服务端使用相反的运算根据 Masking key 的值对数据进行还原.</p>
<pre>
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 <span style="color: red">6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
+ - - - - - - - - - - - - - - - <span style="color: red">+-------------------------------+</span>
|                               <span style="color: red">|Masking-key, if MASK set to 1  |</span>
+-------------------------------<span style="color: red">+-------------------------------+</span>
                                 <span style="color: green">1 0 1 1 1 1 0 1 1 0 0 1 0 0 1 1</span>

 <span style="color: red">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5</span> 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
<span style="color: red">+-------------------------------+</span>-------------------------------+
<span style="color: red">| Masking-key (continued)       |</span>          Payload Data         |
<span style="color: red">+--------------------------------</span> - - - - - - - - - - - - - - - +
 <span style="color: green">1 0 1 1 1 1 0 1 1 0 0 1 0 0 1 1</span>
</pre>

<h3 id="PAYLOAD"><a href="#PAYLOAD" class="headerlink" title="PAYLOAD"></a>PAYLOAD</h3><p>Payload data 如果不需要进行掩码直接将数据拼入到最后即可. 如果需要, 可以先对数据进行掩码, 然后拼入到帧.</p>
<h4 id="数据掩码算法"><a href="#数据掩码算法" class="headerlink" title="数据掩码算法"></a>数据掩码算法</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data; <span class="comment">// Payload data</span></span><br><span class="line"><span class="keyword">let</span> masking_key; <span class="comment">// 随机 4 字节</span></span><br><span class="line"><span class="keyword">let</span> len = data.length;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">  <span class="keyword">let</span> j = i % <span class="number">4</span>; <span class="comment">// 取模, 得到在 masking_key 中的索引</span></span><br><span class="line">  data[i] ^= masking_key[j];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="控制帧"><a href="#控制帧" class="headerlink" title="控制帧"></a>控制帧</h2><h3 id="心跳"><a href="#心跳" class="headerlink" title="心跳"></a>心跳</h3><p>心跳的机制主要是为了保证 WebSocket 的服务端和客户端的实时双向连接不被断开. 每次心跳都是一个控制帧, 发送方 <a href="#OPCODE">OPCODE</a> 使用 <code>ping</code> 接收方响应 <code>pong</code> 控制帧.</p>
<h3 id="关闭连接"><a href="#关闭连接" class="headerlink" title="关闭连接"></a>关闭连接</h3><p>关闭连接分两种: 服务端发起 和 客户端主动关闭. 两种方式处理方式相同, 例如当服务端发起关闭, 会发送一个关闭帧(OPCODE 为 <code>0x8</code>), 客户端在收到帧的时候, 会响应一个关闭帧给服务端.</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>当然这并不是 WebSocket 的全貌, 但这里是协议里面最重要的部分, 剩下的都是对协议的完善, 更完善的协议内容参考 <a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">rfc</a></p>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">st=>start: FIN
cond=>condition: 1 (yes) or 0 (no)
opcode_countinue=>operation: opcode: 0x0
opcode_other=>operation: opcode: 0x1 or 0x2 or 0x3-7

st->cond
cond(no, right)->opcode_countinue
cond(yes)->opcode_other</textarea><textarea id="flowchart-0-options" style="display: none">{"theme":"simple","scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/protocol/" class="post__tag__link">protocol</a></li><li class="post__tag__item"><a href="/tags/websocket/" class="post__tag__link">websocket</a></li></ul><a href="/post/websocket-protocol/#disqus_thread" class="post__foot-link u-fr"></a></footer></article><article class="post"><header class="post__head"><time datetime="2018-03-20T23:43:27.000Z" class="post__time">March 20, 2018</time><h1 class="post__title"><a href="/post/akagami/">赤紙</a></h1></header><div class="post__main echo"><blockquote>
<p>作曲 : 黒木渚<br>作词 : 黒木渚</p>
</blockquote>
<p>うちに赤紙が届いて<br>「喜べ」と言った父上</p>
<p>白い骨だけ帰って来た<br>娯楽も知らぬまま死んだ<br>貴方が「下らぬ」と言った<br>場末の歌劇団に入り<br>私は今や舞踊界のナンバーワン</p>
<p>袴から覗く上品な脚も<br>竹のよに真っ直ぐな背も<br>どれも貴方から受け継いだX染色体</p>
<p>被害者ヅラして生きてくなど<br>到底できない性分で<br>今日も舞うのです<br>喝采の中 狂ったように</p>
<p>向かいの公爵夫人の<br>旦那様も戦死なさって<br>ヒステリックな大正琴の音<br>止むこともなく聴こえて来ます<br>青い目をした軍人が<br>何気なくくれたキャラメルは<br>罪なほど甘い宿敵の味</p>
<p>可愛げの無い切れ長の目も<br>病的なほど強い野心も<br>どれも貴方から受け継いだX染色体</p>
<p>被害者ヅラして生きてくなど<br>到底できない性分で<br>今日も泣くのです<br>ライトの影 悟られぬように</p>
<p>この想い叫べば<br>「非国民」後ろ指刺され<br>兄上は石つぶて受け<br>母上も悪く言われましょう</p>
<p>袴から覗く上品な脚も<br>竹のよに真っ直ぐな背も<br>どれも貴方から受け継いだX染色体</p>
<p>被害者ヅラして生きてくなど<br>到底できない性分で<br>今日も舞うのです<br>喝采の中 狂ったように</p>
<p>袴から覗く上品な脚も<br>竹のよに真っ直ぐな背も<br>どれも貴方から受け継いだX染色体</p>
<p>被害者ヅラして生きてくなど<br>到底できない性分で<br>今日も舞うのです<br>喝采の中 狂ったように</p>
<p>おわり</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/lirc/" class="post__tag__link">lirc</a></li></ul><a href="/post/akagami/#disqus_thread" class="post__foot-link u-fr"></a></footer></article><article class="post"><header class="post__head"><time datetime="2017-07-18T01:35:05.000Z" class="post__time">July 18, 2017</time><h1 class="post__title"><a href="/post/july/">July</a></h1></header><div class="post__main echo"><p>有些时间没来发牢骚.</p>
<p>莫名其妙.</p>
<p>就现在来看, 一切都不是按照预定的走向发展.</p>
<p>长时间在外, 最初定的计划, 算是完成的就只有是旧博新开吧; 这一次, 真的可以说是没时间, 不过这个没时间, 并不是真正意义上的忙, 老实说全在瞎忙活, 说是要找一个靠谱的团队, 真的靠谱了吗. 仍然是毫无规划的在做事情.</p>
<p>又到极限.</p>
<p>有了更多的爱好, 或者说, 对目前的各种不满. </p>
<p>车厢不是闷热的, 窗外也称不上风景, 没有太多感触, 你不在底站等我.</p>
<p>完成今年的书单吧. 算上上次意外的那本, 到现在已经有三本, 这次又购置两本.</p>
<p><img src="https://raw.githubusercontent.com/iaceob/gallery/master/moan/moan-book-the-underground-railroadss.jpg" alt="The UNDERGROUND RAILROAD"></p>
<p>还有就是银河便车指南第二本. </p>
<p>让阅读成为习惯吧.</p>
<p>对了, 前段时间, 和尚推荐的数读还是很不错的. 虽然早就知道有数读, 从未玩过. 当学会怎么去玩之后, 还是很有意思的.</p>
<p><img src="https://raw.githubusercontent.com/iaceob/gallery/master/moan/moan-july-sudo-1.png" alt="SUDO 1"></p>
<p><img src="https://raw.githubusercontent.com/iaceob/gallery/master/moan/moan-july-sudo-2.png" alt="SUDO 2"></p>
<p>蛤, 最简单的关卡.</p>
<p>Hnn, 雨都不会停, 又在开始.</p>
<p>不用常常联络, 波长对的才会走在一起.</p>
<p>总之, 七月来了, 七月又要去了. 短暂.</p>
<p>接下来</p>
<p>是怎样</p>
<p>晚安.</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/moan/" class="post__tag__link">moan</a></li></ul><a href="/post/july/#disqus_thread" class="post__foot-link u-fr"></a></footer></article><article class="post"><header class="post__head"><time datetime="2017-05-30T00:54:34.000Z" class="post__time">May 30, 2017</time><h1 class="post__title"><a href="/post/which-city/">奔波的人 留不住的城</a></h1></header><div class="post__main echo"><p>车厢里有点闷热 不坐到底站的人来来走走 跟窗外的风景一样 慢慢流逝旧的又被填充上新的 邻座不知要走向哪里的年轻母亲轻轻的哄着怀里的婴孩 声音细软 跟现在窗外的阳光一样温柔 一切都不是特别深刻 但有值得怀念 你在底站等我</p>
<p>超喜欢走在寂静的夜晚, 一首爱上已久的音乐, 一个人, 一直走着.</p>
<p>等我死了以后, 请吧我的骨灰带在身边, 遇到坏人就扬出去. 让我最后, 再保护你一次.</p>
<p>雖然很不甘心, 但是如果只做正確的事情, 是無法迎來最圓滿的結局的. 大家越是相信自己的做法正確, 就會變得越股指, 讓幸福離自己越來越遠.</p>
<p>等生活中真的有了生老病死這樣的大事, 你才知道以前的憂傷都是狗屁.</p>
<p>沒有哪段感情是真正完美無缺的, 所以要找一個和你脾氣相投的人, 因爲這樣就足夠完美了.</p>
<p>你 真的有認真聽一首歌嗎?</p>
<p>聽着, 寶貝, 這個星球除了我和其他人就沒有更多的人了, 快, 進去吧.</p>
<p>“「不是回不去了， 而是都過去了」和那個階段的你說再見. 不會忘了你, 你曾是我生命里重要的一部分, 只是, 都結束了, 我們該好好道別.”</p>
<p>我們都是在爲了什麼</p>
<p>我啊, 已经不能哭了. 所以你来替我哭吧, Horizon.</p>
<p>改變一生只需要那麼一點點時間, 領悟那改變卻要耗費一生.</p>
<p>是很忙, 但是并不充实.</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/moan/" class="post__tag__link">moan</a></li></ul><a href="/post/which-city/#disqus_thread" class="post__foot-link u-fr"></a></footer></article><article class="post"><header class="post__head"><time datetime="2017-05-04T22:19:50.000Z" class="post__time">May 4, 2017</time><h1 class="post__title"><a href="/post/moan-part-7/">意外</a></h1></header><div class="post__main echo"><p>应该说, 到现在, 所发生的一切都是一连串的意外所产生的.</p>
<p>现在还不想回忆这些意外, 真的, 太多了, 以至于我无法说清; 而且也还没到该回忆的时候 (年长六年那个就不知道了_(:3 」∠ )_ ); 鬼知道还会有多少意外.</p>
<p>前些天, 就很意外的买了本书, 就在今天, 就已经全部看完了. </p>
<p><a href="https://book.douban.com/subject/26242908/" target="_blank" rel="noopener">如果世上不再有猫</a></p>
<p>很惭愧, 我无法写出独到的见解; 每个人都有自己的见解和感受, 如果你想了解, 你就应该自己去做.</p>
<p>当然, 意外也包括来自生活中的惊喜, 很喜欢在你毫无预兆的情况下有一个未知的惊喜在等着你, 那么先让自己成为那个发出惊喜的人吧 ~</p>
<p>还有, 不知道会不会再一次意外的回到最初的地方.</p>
<p>又停下来了.</p>
<p>说不上的感觉.</p>
<p>就这样.</p>
<div id="aplayer-GoDAAQEs" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;">
				<pre class="aplayer-lrc-content">[00:19.71]君に見せたいものがあるんだ
[00:25.40]孤独な夜にもきっと
[00:29.32]遠くで輝き続ける
[00:35.67]幾千の星を
[00:40.42]失うこと
[00:42.73]割り切れぬこと　
[00:45.22]弾かれること　
[00:47.74]叶わないこと　
[00:50.32]でも足掻くこと　
[00:52.87]信じぬくこと
[00:55.44]上を向いて
[00:57.99]歩き出すこと
[01:03.21]僕らの手には何もないけど
[01:08.08]かわりに　つなぎあえるから
[01:13.73]ひとりきりで　迷わないで
[01:18.73]どんな日もこの手を離さないから　
[01:33.80]君にあげたいものがあるんだ
[01:39.35]凍える夜にはいつも　
[01:43.39]もう何も心配等せず
[01:49.75]眠れる毛布を
[01:54.20]忘れられぬこと
[01:56.60]耐えきれぬこと
[01:59.31]術がないこと　
[02:01.76]奪われること
[02:04.33]でも気付くこと　
[02:06.70]君がいること
[02:09.39]守りたいものが
[02:11.91]強くさせること
[02:17.27]自分の色を誇れるように
[02:22.08]自由に色を足せばいい
[02:27.25]ぼやけていた　この世界を
[02:32.83]この手が彩ってゆくんだ
[02:39.04]認めてくれる人がいなくても　
[02:43.37]サマになる肩書きがなくても　
[02:48.34]僕らの小さな手は明日きっと
[02:53.51]誰かを笑顔にできるから
[03:00.83]僕らの手には何もないけど
[03:05.64]かわりに　つなぎあえるから
[03:10.90]ひとりきりで　迷わないで
[03:16.26]どんな日もこの手を離さないから
[03:41.75]君に見せたいものがあるんだ
[03:47.36]孤独な夜にもきっと
[03:51.38]遠くで輝き続ける
[03:57.82]幾千の星を</pre>
			</div>
			<script>
				var ap = new APlayer({
					element: document.getElementById("aplayer-GoDAAQEs"),
					narrow: false,
					autoplay: false,
					showlrc: 2,
					music: {
						title: "僕らの手には何もないけど、",
						author: "RAM WIRE",
						url: "https://mio.0u0.me/music/RAM%20WIRE%20-%20%E5%83%95%E3%82%89%E3%81%AE%E6%89%8B%E3%81%AB%E3%81%AF%E4%BD%95%E3%82%82%E3%81%AA%E3%81%84%E3%81%91%E3%81%A9%E3%80%81.mp3",
						pic: "https://p1.music.126.net/V1o9XDhAnI1ayWW5elJwFQ==/109951163338252165.jpg?param=500y500",
					}
				});
				window.aplayers || (window.aplayers = []);
				window.aplayers.push(ap);
			</script>



</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/moan/" class="post__tag__link">moan</a></li></ul><a href="/post/moan-part-7/#disqus_thread" class="post__foot-link u-fr"></a></footer></article><article class="post"><header class="post__head"><time datetime="2017-05-04T21:58:57.000Z" class="post__time">May 4, 2017</time><h1 class="post__title"><a href="/post/if-this-world-cat-disappears/">世界から貓が消えたなら</a></h1></header><div class="post__main echo"><p>“人类和猫共同生活了一万年, 所以, 长时间和猫想处, 就会渐渐了解, 不是人类饲养猫, 只是猫愿意陪伴在人类身旁而已.”</p>
<hr>
<p>“你一直都戴那只表, 有什么特别意义吗?”<br>“那是你爸第一次送我的礼物.”<br>“原来是这样.”<br>“那是你爸用他搜集的古董表的零件组装的手表.”<br>“原来他会做这种事.”<br>“他会做这种事.”<br>老妈说完, 像少女般笑了起来.<br>“你爸上个星期来看我时, 我说手表不动了, 他没有吭气, 就带回家了. 原来他打算拿回去修理.”<br>“但没必要偏偏现在修理啊.”<br>“没关系. 你在这里陪我, 我当然高兴, 但有时候人会用不同的方式表达内心的爱.”<br>“是这样吗?”<br>“就是这样啊.”</p>
<hr>
<p>“没错. 我猜想由你内心我数个小小的后悔, 想要这么做, 用另一种方式活到今天, 就会形成我现在这个样子. 这事某种理想, 又同时带有魔鬼的性质, 虽然想要成为那样的自己, 却又无法真的做到, 是离自己最近的遥远存在. 差不多就是这样吧.”<br>“我做的决定对吗?”<br>“请不要问我.”<br>“临终的时候会后悔吗?”<br>“一定会. 我还想活下去! 想要把魔鬼找回来! 你应该会有这种想法. 人类总是从自己选择的人生看向自己没有选择的另一种人生, 感到羡慕, 感到后悔.”</p>
<hr>
<p>但是, 当我获得可以让某些东西从这个世界消失的权利后, 发现这种后悔正是一种美, 因为这正是我活过的证明.<br>我不会再让任何东西从这个世界消失.<br>也许我会在临死之际后悔, 为了活命, 可以让猫或是任何东西消失. 但是, 及时如此也无妨, 反正我的人生本就充满后悔.<br>原以为此生活出了自我, 但其实并没有活出自我.<br>我的人生, 终究没有找到自我.<br>无数的失败和后悔, 没有完成的梦想, 相见的人, 想吃的食物, 和想去的地方. 我将带着这些无数的东西走向死亡, 但是, 这也无妨, 我觉得现在的自己很好. 我很庆幸自己走到了这里, 而不是走到不是这里的另一个地方.</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/book/" class="post__tag__link">book</a></li></ul><a href="/post/if-this-world-cat-disappears/#disqus_thread" class="post__foot-link u-fr"></a></footer></article><article class="post"><header class="post__head"><time datetime="2017-04-02T17:27:33.000Z" class="post__time">April 2, 2017</time><h1 class="post__title"><a href="/post/moan-part-6/">10 年後この木の下で</a></h1></header><div class="post__main echo"><p>不出意外的又踩到屎.</p>
<p>是說現在的企業, 公司只會提出很前衛的理念和想法, 但是去實作的人全是渣?</p>
<p>不談, 不想談, 越是追究, 到最後變成了自己看什麼都不爽, 看什麼都不舒服.</p>
<p>還是頭一次公休假期沒有回家了.</p>
<p>發現自己的 <code>阿Q精神</code> 最近越來越爆棚, 恩, 總感覺這一切都將慢慢的好起來, 變的越來越不悲觀. 其實所有的問題又一次如以前一樣被深深地埋了起來, 又一次選擇了逃避.</p>
<p>再一次燃起熱血準備做一件事, 對, 就是在今天, 不出意外的忽然間又產生了 <strong>我特麼還要不要做下去</strong> 的念頭.</p>
<p>// 不想放棄, 已經為了這個拋棄了好多了, 怎麼能就這樣放棄.</p>
<p>喜歡的事物很多, 慢慢的, 多了好興趣, 對閱讀書本漸漸多了很多耐心, 不會顯得煩躁, 拿起筆的次數變多, 願意拿更多的時間放在更加真實的現在.</p>
<p>可惜, 說要學習日語到現在都還沒什麼進展, 當然和這次又踩到屎有關.</p>
<p>接下來,</p>
<p>準備入手 Chromebook , 看好久了. 還是很心動.</p>
<p>等待夏末的到來~</p>
<p>還有昂.</p>
<p>做下去, 繼續做下去, 我到要看看自己到底能維持做一件事能有多久.</p>
<p>歌單該換啦, 老實說, 人真的會在潛移默化中改變, 歌單最早的歌曲已經有 3 Year+ 現在每次打開歌單做的第一件事請就是 滑 滑 滑, 直到最近新加的曲子.</p>
<blockquote>
<p>種一顆樹最好的時間是十年前, 其次是現在.</p>
</blockquote>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/moan/" class="post__tag__link">moan</a></li></ul><a href="/post/moan-part-6/#disqus_thread" class="post__foot-link u-fr"></a></footer></article><article class="post"><header class="post__head"><time datetime="2017-03-19T21:59:30.000Z" class="post__time">March 19, 2017</time><h1 class="post__title"><a href="/post/moan-part-5/">我尽力了!</a></h1></header><div class="post__main echo"><p><img src="https://raw.githubusercontent.com/iaceob/gallery/master/moan/moan-clean-before-1.jpg" alt="Before"></p>
<p><img src="https://github.com/iaceob/gallery/blob/master/moan/moan-clean-after-1.jpg?raw=true" alt="After"></p>
<p>手疼.</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/moan/" class="post__tag__link">moan</a></li></ul><a href="/post/moan-part-5/#disqus_thread" class="post__foot-link u-fr"></a></footer></article><article class="post"><header class="post__head"><time datetime="2017-03-18T16:10:28.000Z" class="post__time">March 18, 2017</time><h1 class="post__title"><a href="/post/jfinal-restful/">JFinal RESTful</a></h1></header><div class="post__main echo"><p>在阅读之前, 先参考</p>
<ol>
<li><a href="http://www.jfinal.com/project/1" target="_blank" rel="noopener">JFinal 极速开发框架</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html" target="_blank" rel="noopener">RESTful API 设计指南</a></li>
<li><a href="https://www.oschina.net/question/552061_249032" target="_blank" rel="noopener">JFinal实现严格的Restful</a></li>
</ol>
<p>当看完这些之后, 大概应该就能理解, RESTful 的规范, 以及 JFinal 的路由实现方式.</p>
<p>首先, 先看下 JFinal 目前的 RESTful 风格路由实现.</p>
<p>翻开 <code>com.jfinal.core.ActionMapping#getAction</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Support four types of url</span></span><br><span class="line"><span class="comment"> * 1: http://abc.com/controllerKey                 ---&gt; 00</span></span><br><span class="line"><span class="comment"> * 2: http://abc.com/controllerKey/para            ---&gt; 01</span></span><br><span class="line"><span class="comment"> * 3: http://abc.com/controllerKey/method          ---&gt; 10</span></span><br><span class="line"><span class="comment"> * 4: http://abc.com/controllerKey/method/para     ---&gt; 11</span></span><br><span class="line"><span class="comment"> * The controllerKey can also contains "/"</span></span><br><span class="line"><span class="comment"> * Example: http://abc.com/uvw/xyz/method/para</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Action <span class="title">getAction</span><span class="params">(String url, String[] urlPara)</span> </span>&#123;</span><br><span class="line">  Action action = mapping.get(url);</span><br><span class="line">  <span class="keyword">if</span> (action != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> action;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// --------</span></span><br><span class="line">  <span class="keyword">int</span> i = url.lastIndexOf(SLASH);</span><br><span class="line">  <span class="keyword">if</span> (i != -<span class="number">1</span>) &#123;</span><br><span class="line">    action = mapping.get(url.substring(<span class="number">0</span>, i));</span><br><span class="line">    urlPara[<span class="number">0</span>] = url.substring(i + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> action;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有说明, 目前 JFinal 支持的路由格式, 在此之外, JFinal 还提供了一个 <code>Restful</code> 的拦截器, 来达到严格的 RESTful url 风格实现.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invocation 中添加 Method method</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment">  The standard definition is as follows:</span></span><br><span class="line"><span class="comment">  index - GET - A view of all (or a selection of) the records</span></span><br><span class="line"><span class="comment">  show - GET - A view of a single record</span></span><br><span class="line"><span class="comment">  add - GET - A form to post to create</span></span><br><span class="line"><span class="comment">  save - POST - Create a new record</span></span><br><span class="line"><span class="comment">  edit - GET - A form to edit a single record</span></span><br><span class="line"><span class="comment">  update - PUT - Update a record</span></span><br><span class="line"><span class="comment">  delete - DELETE - Delete a record</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * GET    /user      ---&gt;  index</span></span><br><span class="line"><span class="comment"> * GET    /user/id    ---&gt;  show  </span></span><br><span class="line"><span class="comment"> * GET    /user/add    ---&gt;  add</span></span><br><span class="line"><span class="comment"> * POST    /user      ---&gt;  save</span></span><br><span class="line"><span class="comment"> * GET    /user/edit/id  ---&gt;  edit</span></span><br><span class="line"><span class="comment"> * PUT    /user/id    ---&gt;  update</span></span><br><span class="line"><span class="comment"> * DELETE  /user/id    ---&gt;  delete</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Restful</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当看完这些之后, 进入到正题.</p>
<p>首先, JFinal 基本上已经可以很好的实现 RESTful 风格的 url 了, 但是仍然有不足, 无论是默认的路由实现, 或者是 Restful 拦截器的实现, 仍然无法做到全可控的 RESTful 实现.<br>Restful 拦截器的实现实际上是匹配链接以及 Request method, 然后进行 forward 到相应的 action 中.</p>
<p>例如, 参考链接 <a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html" target="_blank" rel="noopener">RESTful API 设计指南</a> 文章中的</p>
<blockquote>
<p>DELETE /zoos/ID/animals/ID：删除某个指定动物园的指定动物</p>
</blockquote>
<p>就没办法通过 Restful 拦截器来实现了.</p>
<p>那么, 所有问题都抛出来了.</p>
<p>因此, 这里要说的就是, 把 JFinal 的路由机制给改了下, 达到完美兼容 RESTful 链接, 并且保留 JFinal 的默认实现.</p>
<p>具体实现代码已提交至 <a href="https://github.com/iaceob/jfinal/tree/restful" target="_blank" rel="noopener">iaceob/jfinal</a></p>
<p>先不讨论怎么实现, 其实原理也很简单, 看看代码很容易理解. 这里主要说说使用方式, 以及一些问题.</p>
<p>使用的时候非常简单, 首先在你的 AppConfig.configConstant 中, 设置开启 RESTful 模式.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configConstant</span><span class="params">(Constants constants)</span> </span>&#123;</span><br><span class="line">    constants.setRestful(<span class="keyword">true</span>);</span><br><span class="line">    constants.setXxx();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当设置了 <code>constants.setRestful(true);</code> 之后, 路由解析就是 RESTful 风格实现的, 默认是 false, 也就是目前 JFinal 自身的路由实现.</p>
<p>接下来就是定义你的 RESTful 链接格式就好, 下面是一个测试案例.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jfinal.test.restful.test.ctl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jfinal.core.ActionKey;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.core.Controller;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.plugin.activerecord.Record;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.restful.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by iaceob on 2017/3/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooCtl</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Record&gt; <span class="title">getAttrs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Record&gt; rets = <span class="keyword">new</span> ArrayList&lt;Record&gt;();</span><br><span class="line">        Enumeration&lt;String&gt; ens = <span class="keyword">super</span>.getAttrNames();</span><br><span class="line">        <span class="keyword">while</span> (ens.hasMoreElements()) &#123;</span><br><span class="line">            String key = ens.nextElement();</span><br><span class="line">            rets.add(<span class="keyword">new</span> Record().set(key, <span class="keyword">super</span>.getAttr(key)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rets;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Record <span class="title">buildRet</span><span class="params">(String intro)</span> </span>&#123;</span><br><span class="line">        Record ret = <span class="keyword">new</span> Record();</span><br><span class="line">        ret.set(<span class="string">"intro"</span>, intro)</span><br><span class="line">                .set(<span class="string">"attrs"</span>, <span class="keyword">this</span>.getAttrs())</span><br><span class="line">                .set(<span class="string">"paras"</span>, <span class="keyword">super</span>.getParaMap());</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(<span class="string">"/zoo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"zoo list"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(value = <span class="string">"/zoo"</span>, method = Method.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addZoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"add zoo"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(<span class="string">"/zoo/:id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getZoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"get zoo by id"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(value = <span class="string">"/zoo/:id"</span>, method = Method.PUT)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putZoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"put zoo by id"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(value = <span class="string">"/zoo/:id"</span>, method = Method.PATCH)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">patchZoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"patch zoo by id"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(value = <span class="string">"/zoo/:id"</span>, method = Method.DELETE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteZoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"delete zoo by id"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(<span class="string">"/zoo/:id/animals"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">animals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"show zoo animals"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(<span class="string">"/zoo/:zooId/animal/:animalId"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getAnimal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"show zoo animal by id"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActionKey</span>(<span class="string">"/zoo/:zid/animal2/:aid"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getAnimal2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.renderJson(<span class="keyword">this</span>.buildRet(<span class="string">"show zoo animal by id, 2"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用时也是使用 <code>@ActionKey</code> 注解, url 中的值通过 <code>:name</code> 来标识, ActionKey 注解中的另外一个参数就是绑定相应的请求 method.</p>
<p>获取参数也未作改变, 表单传递的参数仍然通过 <code>getPara()</code> 来获取, 使用方式详细见 JFinal 文档.</p>
<p>但是需要注意的是:</p>
<ol>
<li><p>开启 RESTful 模式后, <code>getPara()</code> 方法按索引取值的方法将失去效果<br>例如, <code>/zoo/:id/1-3</code> 若这样的请求则会直接返回 404 错误, 因为 RESTful 模式采用的匹配规则较严格(可查看代码实现, 或对该处进行修改令其支持), 另外若是采用 RESTful 风格链接, 应该也不会使用此方式传参.</p>
</li>
<li><p>存放在 url 中的参数标识无法通过 <code>getPara()</code> 取值.<br>若要获取 url 中指定的参数值, 需要通过 <code>getAttr()</code> 获取, 例如 <code>/zoo/:id</code> 获取这个 id 时, 使用 <code>getAttr(&quot;id&quot;)</code>.</p>
</li>
<li><p>RESTful 模式与非 RESTful 的 ActionKey 是不可共用的.<br>这个描述可能比较模糊, 但是要表达的意思是, 如果 ActionKey 中的 url 是采用 RESTful 风格写的, 但是却没有开启 RESTful 模式, 就会发生问题, 非 RESTful 模式是不去分析 url 中参数的.</p>
</li>
<li><p>无需再使用 POST GET 拦截器<br>JFinal 提供了 GET POST 拦截器, 用以指定某个路由只能某中请求, 但是开启 RESTful 模式后, 在路由匹配是就已经限定了指定的 method 访问, 因此无需再使用 <code>@Before(POST.class)</code> 这样的代码.</p>
</li>
</ol>
<p>使用方式大抵如此, 剩下还有一些可能会令人不爽的小问题.</p>
<ol>
<li><p>使用 <code>getAttr()</code> 获取 url 中参数时, 获取到的值都是 String 类型.<br>因 <code>HttpServletRequest</code> 自身的设计, 在解析完 url 后无法将值写入到 <code>parameter</code> 中, 因此无法使用 JFinal 提供的 <code>getPara()</code> 取值. 后续也考虑过做一个类型自动识别, 但是最终抛弃了, 在不同的系统中, 参数的类型都不同, 自动识别是不靠谱的, 因此建议使用中, 在获取这个参数时都写一个 <code>validator</code> 对这个值进行验证, <code>controller</code> 中就可以对该值进行强转类型.</p>
</li>
<li><p>性能问题<br>也不要想得太过与悲观, 这里说的性能只是相对于 JFinal 自身的路由实现. JFinal 的路由实现非常简单, 甚至可以就简单的看成是字符串匹配, 但是这里的 RESTful 模式, 匹配时使用了正则, 因此效能肯定会比 JFinal 自身实现要来的低一些. 后续会做相关方面性能测试.</p>
</li>
<li><p>非插拔式<br>意思是, 并非提供扩展, 而是通过修改内核实现, 其原因其实看看 JFinal 提供 <code>Restful</code> 拦截器就知道了 = =, 以及 JFinal 的极简的设计缘故. 首先, JFinal 的路由实现, 路由最初加载进来时, 就通过 ActionMapping 隐射到具体的 Action 中, 随后只要有请求就通过 ActionHandler 找到具体的 Action, 因此想要在此基础上实现 RESTful 几乎是不可能, Restful 拦截器的实现也只能通过 forward 来实现, 且无法在 url 中指定参数. 也就是说, 无论你是加自己的过滤器, 甚至创建一个新的注解, 在请求进来时最先经过的 ActionHandler 就以及拒绝了请求, 无法进入到新定义的路由处理中. 因此要实现就只能从 ActionMapping 中入手, 修改路由实现方式.</p>
</li>
</ol>
<p>基本就这样.</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/jfinal/" class="post__tag__link">jfinal</a></li><li class="post__tag__item"><a href="/tags/restful/" class="post__tag__link">restful</a></li></ul><a href="/post/jfinal-restful/#disqus_thread" class="post__foot-link u-fr"></a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2021 fewensa</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><a title="Next" href="/page/2/" class="page-menu__link icon-arrow-right"></a></li></menu></footer></body></html>
<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="幾文山" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>letsencrypt 交互式脚本 - 幾文山</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">幾文山</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="http://old.3u3.me" class="head-nav__link">Old</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2016-12-04T08:35:14.000Z" class="post__time">December 4, 2016</time><h1 class="post__title"><a href="/post/letsencrypt-auto-shell/">letsencrypt 交互式脚本</a></h1></header><div class="post__main echo"><h2 id="赘述"><a href="#赘述" class="headerlink" title="赘述"></a>赘述</h2><blockquote>
<p>随着国内网络环境的持续恶化，各种篡改和劫持层出不穷，越来越多的网站选择了全站 HTTPS。就在今天，免费提供证书服务的 <a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a> 项目也正式开放，HTTPS 很快就会成为 WEB 必选项。HTTPS 通过 TLS 层和证书机制提供了内容加密、身份认证和数据完整性三大功能，可以有效防止数据被查看或篡改，以及防止中…</p>
</blockquote>
<p><a href="https://imququ.com/post/sth-about-switch-to-https.html" target="_blank" rel="external">不抄了</a>…</p>
<p>这里要说的是, 使用脚本去开启 https 认证.</p>
<p>此脚本是根据 <a href="https://imququ.com/post/letsencrypt-certificate.html" target="_blank" rel="external">Let’s Encrypt，免费好用的 HTTPS 证书</a> 所阐述的内容而进行修改的交互式执行脚本.</p>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p><strong>ecpt.sh</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span><br><span class="line"></span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 自动设定 Let's Encrypt https</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 脚本执行路径</span></span><br><span class="line">BIN_PATH=$(dirname $(readlink <span class="_">-f</span> <span class="variable">$0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">## 证书存储目录</span></span><br><span class="line">F_CERT_STORE=</span><br><span class="line"><span class="comment">## nginx ssl 验证目录</span></span><br><span class="line">F_NGINX_VERIFY=</span><br><span class="line"><span class="comment">## nginx 自定义配置文件目录</span></span><br><span class="line">F_NGINX_CONF=</span><br><span class="line"><span class="comment">## 私钥类型</span></span><br><span class="line">CSR_TYPE=</span><br><span class="line"><span class="comment">## ecc 私钥加密算法</span></span><br><span class="line">ECC_ALGO=</span><br><span class="line"><span class="comment">## 域名</span></span><br><span class="line">DOMAINLIST=</span><br><span class="line"><span class="comment">## openssl 配置文件</span></span><br><span class="line">OPENSSLCONFIG=</span><br><span class="line">OPENSSLCONFIGPATHETC=/etc/ssl/openssl.cnf</span><br><span class="line">OPENSSLCONFIGPATHUSR=/usr/<span class="built_in">local</span>/openssl/ssl/openssl.cnf</span><br><span class="line">OPENSSLCONFIGPATHPKI=/etc/pki/tls/openssl.cnf</span><br><span class="line"><span class="comment">## 预定义文件名</span></span><br><span class="line">SSL_VERIFY_CONF=ssl_verify.conf</span><br><span class="line">SYNC_SH=sync.sh</span><br><span class="line"></span><br><span class="line">ACCOUNT_KEY=account.key</span><br><span class="line">DOMAIN_KEY=domain.key</span><br><span class="line">DOMAIN_CSR=domain.csr</span><br><span class="line">DOMAIN_LIST_BACK=domain.list</span><br><span class="line">SIGNED_CRT=signed.crt</span><br><span class="line">CHAINED_PEM=chained.pem</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log</span></span>()&#123;</span><br><span class="line">    TYPE=`tr <span class="string">'[a-z]'</span> <span class="string">'[A-Z]'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$1</span>"</span>`</span><br><span class="line">    <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"[<span class="variable">$&#123;TYPE&#125;</span>]: <span class="variable">$2</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">isRoot</span></span>()&#123;</span><br><span class="line">  <span class="keyword">if</span> [ `id -u` <span class="_">-eq</span> 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">return</span>  0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">userInput</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'* 选择证书存储目录: '</span> F_CERT_STORE</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$F_CERT_STORE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'请输入目录'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">    <span class="comment"># xTODO 测试临时使用</span></span><br><span class="line">    <span class="comment"># F_CERT_STORE=/tmp/cert</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$F_CERT_STORE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    mkdir -p <span class="variable">$F_CERT_STORE</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'* 选择 nginx ssl 验证目录: '</span> F_NGINX_VERIFY</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$F_NGINX_VERIFY</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'请输入 nginx ssl 验证目录'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">    <span class="comment"># xTODO 测试临时使用</span></span><br><span class="line">    <span class="comment"># F_NGINX_VERIFY=/tmp/cert/verify/</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$F_NGINX_VERIFY</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    mkdir -p <span class="variable">$F_NGINX_VERIFY</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'* 选择 nginx 自定义配置文件目录: '</span> F_NGINX_CONF</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$F_NGINX_CONF</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'请输入 nginx 自定义配置文件目录'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">    <span class="comment"># xTODO 测试临时使用</span></span><br><span class="line">    <span class="comment"># F_NGINX_CONF=/tmp/cert/conf.d</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$F_NGINX_CONF</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'未发现 nginx 自定义配置文件目录'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'选择私钥加密类型(RSA/ECC)(RSA): '</span> CSR_TYPE</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$CSR_TYPE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    CSR_TYPE=RSA</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  CSR_TYPE=`tr <span class="string">'[a-z]'</span> <span class="string">'[A-Z]'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$CSR_TYPE</span>"</span>`</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$CSR_TYPE</span>"</span>x != <span class="string">"RSA"</span>x &amp;&amp; <span class="string">"<span class="variable">$CSR_TYPE</span>"</span>x != <span class="string">"ECC"</span>x ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'仅支持 RSA 或 ECC 类型'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$CSR_TYPE</span>"</span> = <span class="string">"ECC"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">'选择 ECC 加密算法 [1: secp256r1] [2: secp384r1] (1): '</span> ECC_ALGO</span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$ECC_ALGO</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">      ECC_ALGO=1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$ECC_ALGO</span>"</span> <span class="_">-ne</span> 1 &amp;&amp; <span class="string">"<span class="variable">$ECC_ALGO</span>"</span> <span class="_">-ne</span> 2 ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">log</span> error <span class="string">'选择正确的算法 [1: secp256r1] [2: secp384r1]'</span></span><br><span class="line">      <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'* 输入认证的域名[多个使用 , 区分]: '</span> DOMAINLIST</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$DOMAINLIST</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'至少需要一个域名'</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$DOMAINLIST</span> &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_LIST_BACK</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">'openssl 配置文件地址(/etc/ssl/openssl.cnf): '</span> OPENSSLCONFIG</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$OPENSSLCONFIG</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    OPENSSLCONFIG=/etc/ssl/openssl.cnf</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">createAccount</span></span>()&#123;</span><br><span class="line">  openssl genrsa 4096 &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$ACCOUNT_KEY</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">createPrivateKey</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$CSR_TYPE</span>"</span>x = <span class="string">"RSA"</span>x ]; <span class="keyword">then</span></span><br><span class="line">      openssl genrsa 4096 &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_KEY</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$CSR_TYPE</span>"</span>x = <span class="string">"ECC"</span>x ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ECC_ALGO</span> <span class="_">-eq</span> 1 ]; <span class="keyword">then</span></span><br><span class="line">      openssl ecparam -genkey -name secp256r1 | openssl ec -out <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_KEY</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ECC_ALGO</span> <span class="_">-eq</span> 2 ]; <span class="keyword">then</span></span><br><span class="line">      openssl ecparam -genkey -name secp384r1 | openssl ec -out <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_KEY</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">createCSR</span></span>() &#123;</span><br><span class="line">  OLCG=</span><br><span class="line">  <span class="keyword">if</span> [[ -z <span class="string">"<span class="variable">$OLCG</span>"</span> &amp;&amp; <span class="_">-f</span> <span class="string">"<span class="variable">$OPENSSLCONFIGPATHETC</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    OLCG=<span class="variable">$OPENSSLCONFIGPATHETC</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [[ -z <span class="string">"<span class="variable">$OLCG</span>"</span> &amp;&amp; <span class="_">-f</span> <span class="string">"<span class="variable">$OPENSSLCONFIGPATHUSR</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    OLCG=<span class="variable">$OPENSSLCONFIGPATHUSR</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [[ -z <span class="string">"<span class="variable">$OLCG</span>"</span> &amp;&amp; <span class="_">-f</span> <span class="string">"<span class="variable">$OPENSSLCONFIGPATHPKI</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    OLCG=<span class="variable">$OPENSSLCONFIGPATHPKI</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$OPENSSLCONFIG</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    OLCG=<span class="variable">$OPENSSLCONFIG</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  DNS=$(genDNS)</span><br><span class="line">  <span class="comment"># log debug $DNS</span></span><br><span class="line"></span><br><span class="line">  cp <span class="variable">$OLCG</span> <span class="variable">$F_CERT_STORE</span>/openssl.cnf</span><br><span class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">'[SAN]\nsubjectAltName='</span><span class="variable">$DNS</span> &gt;&gt; <span class="variable">$F_CERT_STORE</span>/openssl.cnf</span><br><span class="line">  openssl req -new -sha256 -key <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_KEY</span> -subj <span class="string">"/"</span> -reqexts SAN -config <span class="variable">$F_CERT_STORE</span>/openssl.cnf &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_CSR</span></span><br><span class="line">  rm -rf <span class="variable">$F_CERT_STORE</span>/openssl.cnf</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">genDNS</span></span>() &#123;</span><br><span class="line">  DML=<span class="variable">$&#123;DOMAINLIST//,/ &#125;</span></span><br><span class="line">  DNS=</span><br><span class="line">  IX=0</span><br><span class="line">  <span class="keyword">for</span> DOMAIN <span class="keyword">in</span> <span class="variable">$DML</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$IX</span>"</span> <span class="_">-gt</span> <span class="string">"0"</span> ]; <span class="keyword">then</span></span><br><span class="line">      DNS=<span class="variable">$DNS</span><span class="string">','</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    DNS=<span class="variable">$DNS</span><span class="string">'DNS:'</span><span class="variable">$DOMAIN</span></span><br><span class="line">    ((IX+=1))</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$DNS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">writeNginxConf</span></span>()&#123;</span><br><span class="line">  <span class="comment"># xTODO 应改成单个域名匹配, 而不是所有域名放置在一起</span></span><br><span class="line">  CONF=$(cat <span class="variable">$BIN_PATH</span>/<span class="variable">$SSL_VERIFY_CONF</span>)</span><br><span class="line">  DML=<span class="variable">$&#123;DOMAINLIST//,/ &#125;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">""</span> &gt; <span class="variable">$F_NGINX_CONF</span>/<span class="variable">$SSL_VERIFY_CONF</span></span><br><span class="line">  <span class="keyword">for</span> DOMAIN <span class="keyword">in</span> <span class="variable">$DML</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    DMS=<span class="variable">$&#123;CONF//\&#123;\&#123;DOMAIN\&#125;</span>\&#125;/<span class="variable">$DOMAIN</span>&#125;</span><br><span class="line">    DMS=<span class="variable">$&#123;DMS//\&#123;\&#123;F_NGINX_VERIFY\&#125;</span>\&#125;/<span class="variable">$F_NGINX_VERIFY</span>&#125;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$DMS</span>"</span> &gt;&gt; <span class="variable">$F_NGINX_CONF</span>/<span class="variable">$SSL_VERIFY_CONF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">""</span> &gt;&gt; <span class="variable">$F_NGINX_CONF</span>/<span class="variable">$SSL_VERIFY_CONF</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restartNginx</span></span>()&#123;</span><br><span class="line">  SYSCTL=`<span class="built_in">which</span> systemctl`</span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$SYSCTL</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="variable">$SYSCTL</span> restart nginx</span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  SERVICE=`<span class="built_in">which</span> service`</span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$SERVICE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="variable">$SERVICE</span> nginx restart</span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">fetchCert</span></span>()&#123;</span><br><span class="line">  curl -o <span class="variable">$F_CERT_STORE</span>/acme_tiny.py https://raw.githubusercontent.com/diafygi/acme-tiny/master/acme_tiny.py</span><br><span class="line">  python <span class="variable">$F_CERT_STORE</span>/acme_tiny.py --account-key <span class="variable">$F_CERT_STORE</span>/<span class="variable">$ACCOUNT_KEY</span> \</span><br><span class="line">    --csr <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_CSR</span> --acme-dir <span class="variable">$F_NGINX_VERIFY</span> &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SIGNED_CRT</span></span><br><span class="line"></span><br><span class="line">  curl -o <span class="variable">$F_CERT_STORE</span>/intermediate.pem https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</span><br><span class="line">  cat <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SIGNED_CRT</span> <span class="variable">$F_CERT_STORE</span>/intermediate.pem &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$CHAINED_PEM</span></span><br><span class="line"></span><br><span class="line">  curl -o <span class="variable">$F_CERT_STORE</span>/root.pem https://letsencrypt.org/certs/isrgrootx1.pem</span><br><span class="line">  cat <span class="variable">$F_CERT_STORE</span>/intermediate.pem <span class="variable">$F_CERT_STORE</span>/root.pem &gt; <span class="variable">$F_CERT_STORE</span>/full_chained.pem</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">end</span></span>()&#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">''</span></span><br><span class="line">  <span class="built_in">log</span> info <span class="string">'证书配置完成'</span></span><br><span class="line">  <span class="built_in">log</span> info <span class="string">'已配置 https 的域名'</span></span><br><span class="line">  DML=<span class="variable">$&#123;DOMAINLIST//,/ &#125;</span></span><br><span class="line">  <span class="keyword">for</span> DOMAIN <span class="keyword">in</span> <span class="variable">$DML</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"\e[1;35m<span class="variable">$DOMAIN</span>\e[0m"</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">''</span></span><br><span class="line">  <span class="built_in">log</span> info <span class="string">' 在 Nginx 中有关证书配置的域名中设定如下配置, 以启用 https'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"\e[1;31mlisten              443 ssl;\e[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"\e[1;31mssl_certificate     <span class="variable">$F_CERT_STORE</span>/<span class="variable">$CHAINED_PEM</span>;\e[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"\e[1;31mssl_certificate_key <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_KEY</span>;\e[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"有关 Nginx 更多配置: https://imququ.com/post/my-nginx-conf.html"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">''</span></span><br><span class="line">  <span class="built_in">log</span> info <span class="string">'执行 \e[1;31mcrontab -e\e[0m 命令, 在打开的编辑器中写入下方内容, 以启用定时更新脚本.'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"\e[1;31m0 0 1 * * <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SYNC_SH</span> &gt;/dev/null 2&gt;&amp;1\e[0m"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">sync</span></span>()&#123;</span><br><span class="line">  SYNC_SHELL=$(cat <span class="variable">$BIN_PATH</span>/<span class="variable">$SYNC_SH</span>)</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;F_CERT_STORE\&#125;</span>\&#125;/<span class="variable">$F_CERT_STORE</span>&#125;</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;F_NGINX_VERIFY\&#125;</span>\&#125;/<span class="variable">$F_NGINX_VERIFY</span>&#125;</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;ACCOUNT_KEY\&#125;</span>\&#125;/<span class="variable">$ACCOUNT_KEY</span>&#125;</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;DOMAIN_CSR\&#125;</span>\&#125;/<span class="variable">$DOMAIN_CSR</span>&#125;</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;SIGNED_CRT\&#125;</span>\&#125;/<span class="variable">$SIGNED_CRT</span>&#125;</span><br><span class="line">  SYNC_SHELL=<span class="variable">$&#123;SYNC_SHELL//\&#123;\&#123;CHAINED_PEM\&#125;</span>\&#125;/<span class="variable">$CHAINED_PEM</span>&#125;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$SYNC_SHELL</span>"</span> &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SYNC_SH</span></span><br><span class="line">  chmod +x <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SYNC_SH</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">main</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">  isRoot</span><br><span class="line">  <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> error <span class="string">'请使用 root 账户执行'</span></span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  userInput</span><br><span class="line">  <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  createAccount</span><br><span class="line"></span><br><span class="line">  createPrivateKey</span><br><span class="line"></span><br><span class="line">  createCSR</span><br><span class="line"></span><br><span class="line">  writeNginxConf</span><br><span class="line"></span><br><span class="line">  restartNginx</span><br><span class="line"></span><br><span class="line">  fetchCert</span><br><span class="line"></span><br><span class="line">  sync</span><br><span class="line"></span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main</span><br></pre></td></tr></table></figure>
<p><strong>ssl_verify.conf</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  server_name &#123;&#123;DOMAIN&#125;&#125;;</span><br><span class="line">  listen 80;</span><br><span class="line"></span><br><span class="line">  location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">    alias &#123;&#123;F_NGINX_VERIFY&#125;&#125;;</span><br><span class="line">    try_files $uri =404;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    rewrite ^/(.*)$ https://&#123;&#123;DOMAIN&#125;&#125;/$1 permanent;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>sync.sh</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span><br><span class="line"></span></span><br><span class="line"><span class="comment">## #######</span></span><br><span class="line"><span class="comment"># 自动更新脚本</span></span><br><span class="line"><span class="comment"># 此脚本为自动更新模板, 在执行 ecpt.sh 后会创建一个新的脚本并将信息配置为交互时填入的信息且加入到 crontab 中定时执行</span></span><br><span class="line"><span class="comment">## #######</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 证书存储目录</span></span><br><span class="line">F_CERT_STORE=&#123;&#123;F_CERT_STORE&#125;&#125;</span><br><span class="line"><span class="comment">## nginx ssl 验证目录</span></span><br><span class="line">F_NGINX_VERIFY=&#123;&#123;F_NGINX_VERIFY&#125;&#125;</span><br><span class="line"></span><br><span class="line">ACCOUNT_KEY=&#123;&#123;ACCOUNT_KEY&#125;&#125;</span><br><span class="line">DOMAIN_CSR=&#123;&#123;DOMAIN_CSR&#125;&#125;</span><br><span class="line">SIGNED_CRT=&#123;&#123;SIGNED_CRT&#125;&#125;</span><br><span class="line">CHAINED_PEM=&#123;&#123;CHAINED_PEM&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restartNginx</span></span>()&#123;</span><br><span class="line">  SYSCTL=`<span class="built_in">which</span> systemctl`</span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$SYSCTL</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="variable">$SYSCTL</span> restart nginx</span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  SERVICE=`<span class="built_in">which</span> service`</span><br><span class="line">  <span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$SERVICE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="variable">$SERVICE</span> nginx restart</span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">python <span class="variable">$F_CERT_STORE</span>/acme_tiny.py --account-key <span class="variable">$F_CERT_STORE</span>/<span class="variable">$ACCOUNT_KEY</span> \</span><br><span class="line">  --csr <span class="variable">$F_CERT_STORE</span>/<span class="variable">$DOMAIN_CSR</span> --acme-dir <span class="variable">$F_NGINX_VERIFY</span> &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SIGNED_CRT</span> || <span class="built_in">exit</span></span><br><span class="line">curl -o <span class="variable">$F_CERT_STORE</span>/intermediate.pem https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</span><br><span class="line">cat <span class="variable">$F_CERT_STORE</span>/<span class="variable">$SIGNED_CRT</span> <span class="variable">$F_CERT_STORE</span>/intermediate.pem &gt; <span class="variable">$F_CERT_STORE</span>/<span class="variable">$CHAINED_PEM</span></span><br><span class="line"></span><br><span class="line">restartNginx</span><br></pre></td></tr></table></figure>
<p>整体目录结构看起来是这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── ecpt.sh</span><br><span class="line">├── ssl_verify.conf</span><br><span class="line">└── sync.sh</span><br></pre></td></tr></table></figure>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>若执行成功会显示类似如下日志信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">~# ./ecpt.sh </span><br><span class="line">* 选择证书存储目录: /data/cert/0u0</span><br><span class="line">* 选择 nginx ssl 验证目录: /data/wwwroot/ssl/</span><br><span class="line">* 选择 nginx 自定义配置文件目录: /etc/nginx/conf.d</span><br><span class="line">选择私钥加密类型(RSA/ECC)(RSA): </span><br><span class="line">* 输入认证的域名[多个使用 , 区分]: thief.0u0.me</span><br><span class="line">openssl 配置文件地址(/etc/ssl/openssl.cnf): </span><br><span class="line">Generating RSA private key, 4096 bit long modulus</span><br><span class="line">................................................................................++</span><br><span class="line">.................................++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Generating RSA private key, 4096 bit long modulus</span><br><span class="line">........................................................................................++</span><br><span class="line">................................................................++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line"> * Restarting nginx nginx                                                  [OK] </span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  9151  100  9151    0     0  12225      0 --:--:-- --:--:-- --:--:-- 12217</span><br><span class="line">Parsing account key...</span><br><span class="line">Parsing CSR...</span><br><span class="line">Registering account...</span><br><span class="line">Registered!</span><br><span class="line">Verifying thief.0u0.me...</span><br><span class="line">thief.0u0.me verified!</span><br><span class="line">Signing certificate...</span><br><span class="line">Certificate signed!</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  1647  100  1647    0     0   5159      0 --:--:-- --:--:-- --:--:--  5163</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  1967  100  1967    0     0  28235      0 --:--:-- --:--:-- --:--:-- 28507</span><br><span class="line"></span><br><span class="line">[INFO]: 证书配置完成</span><br><span class="line">[INFO]: 已配置 https 的域名</span><br><span class="line">thief.0u0.me</span><br><span class="line"></span><br><span class="line">[INFO]:  在 Nginx 中有关证书配置的域名中设定如下配置, 已启用 https</span><br><span class="line">listen              443 ssl;</span><br><span class="line">ssl_certificate     /data/cert/0u0/chained.pem;</span><br><span class="line">ssl_certificate_key /data/cert/0u0/domain.key;</span><br><span class="line">有关 Nginx 更多配置: https://imququ.com/post/my-nginx-conf.html</span><br><span class="line"></span><br><span class="line">[INFO]: 执行 crontab -e 命令, 在打开的编辑器中写入下方内容, 以启用定时更新脚本.</span><br><span class="line">0 0 1 * * /data/cert/0u0/sync.sh &gt;/dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>运行方式</p>
<blockquote>
<p>整个运行过程需要在 root 账户下进行, 可通过 <code>sudo -i</code> 或者 <code>su</code> 命令进入 root 账户</p>
</blockquote>
<p><code>ecpt.sh</code> 为执行脚本, <code>sync.sh</code> 为证书定时更新脚本模板, 执行成功后会在第一步输入的证书存放目录生成一个新的可执行脚本, <code>ssl_verify.conf</code> 为 nginx 配置模板, 用于进行 https 站点认证.</p>
<p>要求输入的信息解释</p>
<ul>
<li><p>* 选择证书存储目录: /data/cert/0u0<br>必填, 所有有关 https 证书和此脚本的文件存储均存放在此目录</p>
</li>
<li><p>* 选择 nginx ssl 验证目录: /data/wwwroot/ssl/<br>必填,此目录是用于进行站点认证时所访问的路径, 配置与 nginx 中(脚本中自动配置)</p>
</li>
<li><p>* 选择 nginx 自定义配置文件目录: /etc/nginx/conf.d<br>必填, nginx 自定义配置路径, 具体路径可通过 <code>/etc/nginx/nginx.conf</code> 中查看, 通常是 <code>include xx</code> 这样的语句</p>
</li>
<li><p>选择私钥加密类型(RSA/ECC)(RSA):<br>加密类型, 可选 RSA/ECC 类型, 若选择 ECC 后续还会跳出选择使用 [1: secp256r1]  [2: secp384r1] 算法, 默认 1</p>
</li>
<li><p>* 输入认证的域名[多个使用 , 区分]: thief.0u0.me<br>必填, 需要认证的域名, 多个使用 , 区分, 不要输入空格</p>
</li>
<li><p>openssl 配置文件地址(/etc/ssl/openssl.cnf):<br>openssl 配文件地址, 脚本中已经预定义了三个路径, 分别是<br><code>/etc/ssl/openssl.cnf</code><br><code>/usr/local/openssl/ssl/openssl.cnf</code><br><code>/etc/pki/tls/openssl.cnf</code><br>如果不输入将默认从这三个路径去找, 但是只要有输入将以输入的地址为最优先地址.</p>
</li>
</ul>
<h2 id="一些坑"><a href="#一些坑" class="headerlink" title="一些坑"></a>一些坑</h2><ul>
<li>必须要使用 root 账户执行, <code>sudo</code> 在测试时发生了 nginx 不能重启的问题.</li>
<li>执行 <code>ecpt.sh</code> 进行域名输入时, 多个域名使用半角 <code>,</code> 进行分割, 且不要出现空格(后果未知, 未进行测试).</li>
<li>执行 <code>ecpt.sh</code> 进行第二步输入 <code>选择 nginx ssl 验证目录</code> 时, 所输入的路径必须要在最后加入 <code>/</code> , 因为此处输入的路径是用于 nginx 的配置中, 若没有 <code>/</code> 会导致后续进行验证失败 (我就是不在脚本给处理了 ╮(╯▽╰)╭ ).</li>
<li>因 nginx 配置特性, 同一个域名和端口只能够有一个 <code>server</code>, 因此, 在执行本脚本时输入的域名在 nginx 配置中一定不要有 <code>80</code> 端口的其他配置, 否则会导致认证失败.</li>
<li>执行成功后最后的日志输入, 定时更新脚本未自动写入到 <code>crontab</code> 中, 请手动执行 <code>crontab -e</code> 进行追加 (使用 root 账户).</li>
</ul>
<p>关于此脚本所做的事情看文章开始提供的链接查看.</p>
<p>收工 (￣ω￣) </p>
<p>喔 不, 看上面的执行日志就看到了, <a href="https://thief.0u0.me" target="_blank" rel="external">thief.0u0.me</a> 对 就是这个~</p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/ssl/" class="post__tag__link">ssl</a></li><li class="post__tag__item"><a href="/tags/lesencrypt/" class="post__tag__link">lesencrypt</a></li><li class="post__tag__item"><a href="/tags/https/" class="post__tag__link">https</a></li></ul><a href="/post/letsencrypt-auto-shell/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2017 iaceob</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/post/final-ng-II-part-2/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/post/final-ng-II-part-1/" class="page-menu__link icon-arrow-right"></a></li></menu></footer></body></html>
<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="幾文山" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Nginx 反向代理不完全指南 - 1 - 幾文山</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">幾文山</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="http://old.3u3.me" class="head-nav__link">Old</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2016-09-03T18:09:38.000Z" class="post__time">September 4, 2016</time><h1 class="post__title"><a href="/post/nginx-proxy-part-1/">Nginx 反向代理不完全指南 - 1</a></h1></header><div class="post__main echo"><p>現行的開發項目中有很多都是前後端分離的方式進行開發, 因此在最終部署的時候, 前後端並不是部署在一次的, 然而, 如果是分開部署的話前端訪問時就會有跨域的問題.</p>
<p>此文所述的解決方式是使用 Nginx 的反向代理來實現</p>
<p>配置方式如下:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># example.com</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> example.com;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /home/www/wwwroot/project;</span><br><span class="line">        <span class="attribute">index</span> index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /api/ &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://local.example.com:8080/;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line"><span class="comment">#        proxy_set_header Host $host;</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span>  Host local.example.com:<span class="number">8080</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這裡配置的意思就是, 當 <code>example.com</code> 域名訪問時, 如果路徑是 <code>/api/</code> 則訪問後端接口, 否則進入前端的項目, 實現兩個項目在同域的處理.</p>
<p><code>/api/</code> 處的設置解析 </p>
<ul>
<li><code>localtion /api/</code> 後面 / 必須要, 如果沒加則會報錯(似乎是 404, 忘記了)</li>
<li><code>proxy_pass http://local.example.com:8080/</code> 這裡最後的 / 也是需要的, 沒加同樣不能正確的訪問</li>
<li><code>proxy_set_header  Host local.example.com:8080;</code> 這裡是設置轉發給目標地址的 host, 如果不設置, 將默認使用瀏覽器返回的 header 頭中的 Host 屬性值, 比如這裡就會使用 <code>example.com/api</code>, 因為大多數情況, 後臺的服務可能是個獨立的服務, 是有可能也綁定了另一個域名, 或者只是通過二級目錄訪問, 如果用的不是被綁定的域名, 則無法通過服務的解析(目前的做法是後臺部署使用 Tomcat, 綁定了另一個寫在 host 的域名(該方式在以前的博文中也提到過), 因此此處修改成在 Tomcat 中綁定的域名).</li>
<li><code>proxy_set_header X-Real-IP $remote_addr;</code> 將真實的訪問人 IP 發送給後端, 否則後端無法獲取到正確的 IP</li>
<li><code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</code> 將真實的訪問人 IP 發送給後端, 否則後端無法獲取到正確的 IP</li>
</ul>
<p>更多詳細的代理配置見:<br><a href="http://zhangge.net/5054.html" target="_blank" rel="external">http://zhangge.net/5054.html</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/nginx/" class="post__tag__link">nginx</a></li><li class="post__tag__item"><a href="/tags/proxy/" class="post__tag__link">proxy</a></li></ul><a href="/post/nginx-proxy-part-1/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2016 iaceob</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/post/oracle-not-lonely/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/post/pg-setup-centos/" class="page-menu__link icon-arrow-right"></a></li></menu></footer></body></html>